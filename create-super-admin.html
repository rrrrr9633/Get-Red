<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç†ä¸­å¿ƒ - å¤§çº¢è¡ŒåŠ¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0c0c0c, #1a1a1a);
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .create-container {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        .create-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .create-header h1 {
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .create-header p {
            opacity: 0.8;
            font-size: 14px;
            color: #00ffff;
        }
        
        .user-type-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .user-type-card {
            background: rgba(30, 30, 50, 0.8);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .user-type-card:hover {
            border-color: #ffd700;
            transform: translateY(-2px);
        }
        
        .user-type-card.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }
        
        .user-type-icon {
            font-size: 32px;
            margin-bottom: 10px;
            display: block;
        }
        
        .user-type-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .user-type-desc {
            font-size: 12px;
            color: #ccc;
        }

        .warning {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid #ff6b6b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .warning h4 {
            color: #ff6b6b;
            margin-bottom: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #ffd700;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffd700;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .password-requirements {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .btn-create {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-create:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error, .success {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid #ff6b6b;
        }

        .success {
            color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid #4ade80;
        }

        .ip-info {
            text-align: center;
            margin-top: 15px;
            font-size: 12px;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="create-container">
        <div class="create-header">
            <h1>ï¿½ ç”¨æˆ·ç®¡ç†ä¸­å¿ƒ</h1>
            <p>åˆ›å»ºå’Œç®¡ç†ä¸åŒç±»å‹çš„ç”¨æˆ·è´¦æˆ·</p>
        </div>

        <!-- ç”¨æˆ·ç±»å‹é€‰æ‹©å™¨ -->
        <div class="user-type-selector">
            <div class="user-type-card" onclick="selectUserType('user')">
                <span class="user-type-icon">ğŸ‘¤</span>
                <div class="user-type-title">æ™®é€šç”¨æˆ·</div>
                <div class="user-type-desc">åŸºç¡€ç”¨æˆ·æƒé™</div>
            </div>
            <div class="user-type-card" onclick="selectUserType('service')">
                <span class="user-type-icon">ğŸ’¬</span>
                <div class="user-type-title">å®¢æœç”¨æˆ·</div>
                <div class="user-type-desc">å®¢æœå·¥ä½œå°æƒé™</div>
            </div>
            <div class="user-type-card" onclick="selectUserType('super_admin')">
                <span class="user-type-icon">ğŸ”</span>
                <div class="user-type-title">è¶…çº§ç®¡ç†å‘˜</div>
                <div class="user-type-desc">æœ€é«˜ç³»ç»Ÿæƒé™</div>
            </div>
        </div>

        <div class="warning" id="userTypeWarning" style="display: none;">
            <h4>âš ï¸ é‡è¦æé†’</h4>
            <p id="warningText"></p>
        </div>

        <div id="message"></div>

        <form id="createUserForm" style="display: none;">
            <input type="hidden" id="selectedUserType" name="userType">
            
            <div class="form-group">
                <label for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" name="username" required 
                       placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>
            
            <div class="form-group">
                <label for="nickname">æ˜µç§°</label>
                <input type="text" id="nickname" name="nickname" required 
                       placeholder="è¯·è¾“å…¥æ˜µç§°">
            </div>

            <div class="form-group">
                <label for="password">å¯†ç </label>
                <input type="password" id="password" name="password" required
                       placeholder="è¯·è¾“å…¥å¯†ç ">
                <div class="password-requirements" id="passwordReq">
                    å¯†ç è¦æ±‚ï¼šè‡³å°‘6ä½å­—ç¬¦
                </div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">ç¡®è®¤å¯†ç </label>
                <input type="password" id="confirmPassword" name="confirmPassword" required
                       placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
            </div>

            <!-- è¶…çº§ç®¡ç†å‘˜ä¸“ç”¨å­—æ®µ -->
            <div class="form-group" id="superAdminFields" style="display: none;">
                <label for="secretKey">è¶…çº§ç®¡ç†å‘˜èº«ä»½ç </label>
                <input type="password" id="secretKey" name="secretKey"
                       placeholder="è¯·è¾“å…¥è¶…çº§ç®¡ç†å‘˜èº«ä»½ç è¿›è¡ŒéªŒè¯">
                <div class="password-requirements">
                    éœ€è¦å½“å‰è¶…çº§ç®¡ç†å‘˜èº«ä»½ç éªŒè¯ï¼ˆé»˜è®¤ï¼šadminï¼‰
                </div>
            </div>

            <div class="form-group">
                <label for="email">é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                <input type="email" id="email" name="email" 
                       placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€">
            </div>

            <button type="submit" class="btn-create" id="createBtn">
                åˆ›å»ºç”¨æˆ·
            </button>
        </form>

        <div class="ip-info" id="ipInfo">
            å½“å‰IP: <span id="currentIP">è·å–ä¸­...</span>
        </div>
    </div>
    <script>
        let selectedUserType = null;
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            getCurrentIP();
            
            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            document.getElementById('createUserForm').addEventListener('submit', handleFormSubmit);
        });
        
        // é€‰æ‹©ç”¨æˆ·ç±»å‹
        function selectUserType(type) {
            selectedUserType = type;
            
            // æ›´æ–°é€‰æ‹©çŠ¶æ€
            document.querySelectorAll('.user-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // è®¾ç½®éšè—å­—æ®µ
            document.getElementById('selectedUserType').value = type;
            
            // æ˜¾ç¤ºå¯¹åº”çš„è­¦å‘Šå’Œè¦æ±‚
            showUserTypeWarning(type);
            
            // æ˜¾ç¤ºè¡¨å•
            document.getElementById('createUserForm').style.display = 'block';
            
            // æ›´æ–°è¡¨å•å­—æ®µæ˜¾ç¤º
            updateFormFields(type);
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ç±»å‹è­¦å‘Š
        function showUserTypeWarning(type) {
            const warningDiv = document.getElementById('userTypeWarning');
            const warningText = document.getElementById('warningText');
            
            const warnings = {
                user: 'æ™®é€šç”¨æˆ·åªèƒ½è®¿é—®åŸºç¡€åŠŸèƒ½ï¼Œæ— æ³•è¿›å…¥ç®¡ç†åå°ã€‚',
                service: 'å®¢æœç”¨æˆ·å¯ä»¥è®¿é—®å®¢æœå·¥ä½œå°ï¼Œå¤„ç†ç”¨æˆ·å’¨è¯¢å’Œé—®é¢˜ã€‚',
                admin: 'ç®¡ç†å‘˜æ‹¥æœ‰ç®¡ç†åå°çš„å¤§éƒ¨åˆ†æƒé™ï¼Œå¯ä»¥ç®¡ç†ç”¨æˆ·ã€å¥–å“ã€è®¢å•ç­‰ã€‚',
                super_admin: 'è¶…çº§ç®¡ç†å‘˜æ‹¥æœ‰ç³»ç»Ÿæœ€é«˜æƒé™ï¼ŒåŒ…æ‹¬åˆ›å»ºå…¶ä»–ç®¡ç†å‘˜ã€ä¿®æ”¹ç³»ç»Ÿæ ¸å¿ƒé…ç½®ç­‰ã€‚è¯·å¦¥å–„ä¿ç®¡è´¦æˆ·ä¿¡æ¯ï¼'
            };
            
            warningText.textContent = warnings[type];
            warningDiv.style.display = 'block';
        }
        
        // æ›´æ–°è¡¨å•å­—æ®µæ˜¾ç¤º
        function updateFormFields(type) {
            const superAdminFields = document.getElementById('superAdminFields');
            const passwordReq = document.getElementById('passwordReq');
            const createBtn = document.getElementById('createBtn');
            
            if (type === 'super_admin') {
                superAdminFields.style.display = 'block';
                passwordReq.textContent = 'å¯†ç è¦æ±‚ï¼šè‡³å°‘6ä½å­—ç¬¦';
                createBtn.textContent = 'åˆ›å»ºè¶…çº§ç®¡ç†å‘˜';
                document.getElementById('secretKey').required = true;
            } else {
                superAdminFields.style.display = 'none';
                passwordReq.textContent = 'å¯†ç è¦æ±‚ï¼šè‡³å°‘6ä½å­—ç¬¦';
                createBtn.textContent = 'åˆ›å»º' + getUserTypeName(type);
                document.getElementById('secretKey').required = false;
            }
        }
        
        // è·å–ç”¨æˆ·ç±»å‹ä¸­æ–‡å
        function getUserTypeName(type) {
            const names = {
                user: 'æ™®é€šç”¨æˆ·',
                service: 'å®¢æœç”¨æˆ·', 
                super_admin: 'è¶…çº§ç®¡ç†å‘˜'
            };
            return names[type] || 'ç”¨æˆ·';
        }
        
        // å¤„ç†è¡¨å•æäº¤
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!selectedUserType) {
                showMessage('è¯·å…ˆé€‰æ‹©ç”¨æˆ·ç±»å‹ï¼', 'error');
                return;
            }
            
            const formData = new FormData(e.target);
            const userData = {
                userType: selectedUserType,
                username: formData.get('username'),
                nickname: formData.get('nickname'),
                password: formData.get('password'),
                confirmPassword: formData.get('confirmPassword'),
                email: formData.get('email') || null
            };
            
            // éªŒè¯å¯†ç 
            if (userData.password !== userData.confirmPassword) {
                showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼', 'error');
                return;
            }
            
            // éªŒè¯å¯†ç å¼ºåº¦
            if (!validatePassword(userData.password, selectedUserType)) {
                return;
            }
            
            // è¶…çº§ç®¡ç†å‘˜éœ€è¦é¢å¤–éªŒè¯
            if (selectedUserType === 'super_admin') {
                const secretKey = formData.get('secretKey');
                
                if (!secretKey) {
                    showMessage('åˆ›å»ºè¶…çº§ç®¡ç†å‘˜éœ€è¦è¾“å…¥å½“å‰è¶…çº§ç®¡ç†å‘˜èº«ä»½ç ï¼', 'error');
                    return;
                }
                
                userData.secretKey = secretKey;
            }
            
            // æäº¤åˆ›å»ºè¯·æ±‚
            await createUser(userData);
        }
        
        // éªŒè¯å¯†ç å¼ºåº¦
        function validatePassword(password, userType) {
            if (password.length < 6) {
                showMessage('å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦ï¼', 'error');
                return false;
            }
            
            return true;
        }
        
        // åˆ›å»ºç”¨æˆ·
        async function createUser(userData) {
            try {
                const createBtn = document.getElementById('createBtn');
                const originalText = createBtn.textContent;
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                createBtn.textContent = 'åˆ›å»ºä¸­...';
                createBtn.disabled = true;
                
                // è°ƒç”¨APIåˆ›å»ºç”¨æˆ·
                const formData = new FormData();
                formData.append('userType', userData.userType);
                formData.append('username', userData.username);
                formData.append('nickname', userData.nickname);
                formData.append('password', userData.password);
                formData.append('email', userData.email || '');
                
                if (userData.secretKey) {
                    formData.append('secretKey', userData.secretKey);
                }
                
                const response = await fetch('server/api/super-admin.php?action=createUser', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`${getUserTypeName(userData.userType)}åˆ›å»ºæˆåŠŸï¼`, 'success');
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('createUserForm').reset();
                    document.getElementById('createUserForm').style.display = 'none';
                    document.getElementById('userTypeWarning').style.display = 'none';
                    
                    // æ¸…é™¤é€‰æ‹©çŠ¶æ€
                    document.querySelectorAll('.user-type-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    selectedUserType = null;
                } else {
                    showMessage('åˆ›å»ºå¤±è´¥ï¼š' + result.error, 'error');
                }
                
            } catch (error) {
                console.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', error);
                showMessage('åˆ›å»ºç”¨æˆ·å¤±è´¥ï¼š' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const createBtn = document.getElementById('createBtn');
                createBtn.textContent = originalText;
                createBtn.disabled = false;
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.className = type;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
            
            // 3ç§’åéšè—æ¶ˆæ¯
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
        
        // è·å–å½“å‰IP
        async function getCurrentIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                document.getElementById('currentIP').textContent = data.ip;
            } catch (error) {
                document.getElementById('currentIP').textContent = 'æ— æ³•è·å–';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            getCurrentIP();
            
            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            document.getElementById('createUserForm').addEventListener('submit', handleFormSubmit);
        });
    </script>
</body>
</html>
