<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥–å“ç®¡ç† - å¹¸è¿é™ä¸´</title>
    <script src="../../js/api-client.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0c0c0c, #1a1a1a);
            color: #fff;
            min-height: 100vh;
        }

        .admin-header {
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 0;
            border-bottom: 2px solid #ffd700;
            text-align: center;
        }

        .admin-header h1 {
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            font-size: 32px;
            cursor: pointer;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .admin-nav {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            justify-content: center;
        }

        .nav-btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .nav-btn.active {
            background: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        .probability-summary {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .probability-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .probability-label {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .probability-value {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .probability-status {
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }

        .probability-status.perfect {
            background: #22c55e;
            color: #000;
        }

        .probability-status.low {
            background: #f59e0b;
            color: #000;
        }

        .probability-status.high {
            background: #ef4444;
            color: #fff;
        }

        .prizes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .prize-card {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .prize-card:hover {
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.3);
            transform: translateY(-5px);
        }

        .prize-image-container {
            text-align: center;
            margin-bottom: 15px;
        }

        .prize-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #ffd700;
            margin-bottom: 10px;
        }

        .prize-icon {
            font-size: 60px;
            margin-bottom: 10px;
            display: block;
        }

        .prize-info h3 {
            color: #ffd700;
            margin-bottom: 10px;
            text-align: center;
        }

        .prize-details {
            display: grid;
            gap: 8px;
            margin-bottom: 15px;
        }

        .prize-detail {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .prize-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
        }

        .btn-edit:hover {
            background: #2563eb;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .btn-toggle {
            background: #10b981;
            color: white;
        }

        .btn-toggle:hover {
            background: #059669;
        }

        .btn-toggle.inactive {
            background: #6b7280;
        }

        .add-prize-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            border: none;
            border-radius: 50%;
            color: #000;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
            transition: all 0.3s ease;
        }

        .add-prize-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #ffd700;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #ffd700;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffd700;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .image-preview {
            text-align: center;
            margin: 10px 0;
        }

        .preview-image {
            max-width: 100px;
            max-height: 100px;
            border-radius: 5px;
            border: 2px solid #ffd700;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .loading {
            text-align: center;
            color: #ffd700;
            font-size: 18px;
            padding: 40px;
        }

        .error {
            color: #ef4444;
            text-align: center;
            margin: 20px 0;
        }

        .success {
            color: #10b981;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .prizes-grid {
                grid-template-columns: 1fr;
            }

            .admin-nav {
                flex-direction: column;
                align-items: center;
            }

            .modal-content {
                margin: 20px;
                width: calc(100% - 40px);
            }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1 onclick="goToHome()">å¥–å“ç®¡ç†ç³»ç»Ÿ</h1>
        <div id="currentLuckyPage" style="margin-top:10px;color:#ffd700;font-size:18px;"></div>
    </div>

    <div class="admin-container">
        <div class="admin-nav">
            <a href="admin.html" class="nav-btn">ç”¨æˆ·ç®¡ç†</a>
            <button class="nav-btn active">å¥–å“ç®¡ç†</button>
            <a href="../main.html" class="nav-btn">è¿”å›æ¸¸æˆ</a>
        </div>

        <!-- æ¦‚ç‡ç»Ÿè®¡æ˜¾ç¤º -->
        <div class="probability-summary">
            <div class="probability-info">
                <span class="probability-label">æ€»æ¦‚ç‡:</span>
                <span id="totalProbability" class="probability-value">0%</span>
                <span id="probabilityStatus" class="probability-status"></span>
            </div>
            <div class="probability-actions">
                <button id="autoBalanceBtn" class="nav-btn" onclick="autoBalanceProbabilities()" style="display:none;">è‡ªåŠ¨å¹³è¡¡æ¦‚ç‡</button>
            </div>
        </div>

        <div id="prizesContainer" class="prizes-grid">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>

        <button class="add-prize-btn" onclick="showAddPrizeModal()" title="æ·»åŠ æ–°å¥–å“">+</button>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘å¥–å“æ¨¡æ€æ¡† -->
    <div id="prizeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ·»åŠ å¥–å“</h2>
            </div>
            
            <form id="prizeForm">
                <input type="hidden" id="prizeId">
                
                <div class="form-group">
                    <label for="prizeName">å¥–å“åç§°</label>
                    <input type="text" id="prizeName" required>
                </div>

                <div class="form-group">
                    <label for="prizeIcon">å¥–å“å›¾æ ‡ (Emoji)</label>
                    <input type="text" id="prizeIcon" placeholder="ğŸ“±">
                </div>

                <div class="form-group">
                    <label for="prizeImageUrl">å¥–å“å›¾ç‰‡URL</label>
                    <input type="url" id="prizeImageUrl" placeholder="https://example.com/image.jpg">
                    <div class="image-preview" id="imagePreview"></div>
                </div>

                <div class="form-group">
                    <label for="prizeValue">å¥–å“ä»·å€¼</label>
                    <input type="number" id="prizeValue" min="0" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="prizeProbability">ä¸­å¥–æ¦‚ç‡ (%)</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="prizeProbability" min="0" max="100" step="0.01" required style="flex: 1;">
                        <button type="button" id="restoreProbabilityBtn" onclick="restoreOriginalProbability()" 
                                style="display: none; padding: 8px 12px; background: #ffd700; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
                            æ¢å¤ä¸Šæ¬¡æ¦‚ç‡
                        </button>
                    </div>
                    <small id="probabilityHint" style="color: #888; display: none; margin-top: 5px;"></small>
                </div>

                <div class="form-group">
                    <label for="prizeRarity">ç¨€æœ‰åº¦</label>
                    <select id="prizeRarity" required onchange="handleRarityChange()">
                        <option value="common">æ™®é€š</option>
                        <option value="rare">ç¨€æœ‰</option>
                        <option value="epic">å²è¯—</option>
                        <option value="legendary">ä¼ è¯´</option>
                    </select>
                </div>

                <div class="form-group" id="quantityGroup" style="display: none;">
                    <label for="prizeQuantity">æ•°é‡é™åˆ¶</label>
                    <input type="number" id="prizeQuantity" min="1" placeholder="è¾“å…¥ä¼ è¯´ç‰©å“æ•°é‡">
                    <small style="color: #ccc; font-size: 12px;">ä»…ä¼ è¯´ç‰©å“éœ€è¦è®¾ç½®æ•°é‡é™åˆ¶</small>
                </div>

                <div class="form-group">
                    <label for="prizeActive">çŠ¶æ€</label>
                    <select id="prizeActive" required>
                        <option value="1">å¯ç”¨</option>
                        <option value="0">ç¦ç”¨</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn-secondary" onclick="closePrizeModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let prizes = [];
        let editingPrizeId = null;

        // è·å–URLå‚æ•°
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const luckyPage = getQueryParam('page') || 'lucky1.html';
            document.getElementById('currentLuckyPage').textContent = 'å½“å‰ç®¡ç†é¡µé¢: ' + luckyPage;
            window.currentLuckyPage = luckyPage;
            loadPrizes();
            setupEventListeners();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å›¾ç‰‡URLé¢„è§ˆ
            document.getElementById('prizeImageUrl').addEventListener('input', function() {
                const url = this.value;
                const preview = document.getElementById('imagePreview');
                
                if (url) {
                    preview.innerHTML = `<img src="${url}" alt="é¢„è§ˆ" class="preview-image" onerror="this.style.display='none'">`;
                } else {
                    preview.innerHTML = '';
                }
            });

            // è¡¨å•æäº¤
            document.getElementById('prizeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                savePrize();
            });
        }

        // åŠ è½½å¥–å“åˆ—è¡¨
        async function loadPrizes() {
            try {
                // ä¼ é€’luckyé¡µé¢å‚æ•°ï¼Œåç«¯å¯æ®æ­¤åŒºåˆ†ä¸åŒé¡µé¢å¥–å“
                const response = await fetch(`../../server/api/admin.php?action=prizes&page=${encodeURIComponent(window.currentLuckyPage)}`);
                const data = await response.json();
                
                if (data.success) {
                    prizes = data.prizes;
                    renderPrizes();
                    updateProbabilitySummary();
                } else {
                    showError('åŠ è½½å¥–å“å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åŠ è½½å¥–å“å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ¸²æŸ“å¥–å“åˆ—è¡¨
        function renderPrizes() {
            const container = document.getElementById('prizesContainer');
            
            if (prizes.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— å¥–å“æ•°æ®</div>';
                return;
            }

            container.innerHTML = prizes.map(prize => `
                <div class="prize-card">
                    <div class="prize-image-container">
                        ${prize.image_url ? 
                            `<img src="${prize.image_url}" alt="${prize.name}" class="prize-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                             <span class="prize-icon" style="display:none;">${prize.icon}</span>` :
                            `<span class="prize-icon">${prize.icon}</span>`
                        }
                    </div>
                    <div class="prize-info">
                        <h3>${prize.name}</h3>
                        <div class="prize-details">
                            <div class="prize-detail">
                                <span>ä»·å€¼:</span>
                                <span>Â¥${prize.value}</span>
                            </div>
                            <div class="prize-detail">
                                <span>æ¦‚ç‡:</span>
                                <span>${prize.probability}%${
                                    prize.rarity === 'legendary' && 
                                    parseFloat(prize.probability) === 0 && 
                                    prize.original_probability !== null && 
                                    parseFloat(prize.original_probability) > 0 
                                    ? ` <small style="color: #ffd700;">(å¯æ¢å¤è‡³${prize.original_probability}%)</small>` 
                                    : ''
                                }</span>
                            </div>
                            <div class="prize-detail">
                                <span>ç¨€æœ‰åº¦:</span>
                                <span>${getRarityText(prize.rarity)}</span>
                            </div>
                            ${prize.rarity === 'legendary' && prize.quantity !== null ? 
                                `<div class="prize-detail">
                                    <span>æ•°é‡:</span>
                                    <span style="color: ${prize.quantity <= 0 ? '#ff4444' : '#44ff44'}">${prize.quantity}</span>
                                </div>` : ''
                            }
                            <div class="prize-detail">
                                <span>çŠ¶æ€:</span>
                                <span>${prize.active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span>
                            </div>
                        </div>
                        <div class="prize-actions">
                            <button class="btn btn-edit" onclick="editPrize(${prize.id})">ç¼–è¾‘</button>
                            <button class="btn btn-toggle ${prize.active ? '' : 'inactive'}" 
                                    onclick="togglePrize(${prize.id}, ${prize.active})">
                                ${prize.active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn btn-delete" onclick="deletePrize(${prize.id})">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // è·å–ç¨€æœ‰åº¦æ–‡æœ¬
        function getRarityText(rarity) {
            const rarityMap = {
                'common': 'æ™®é€š',
                'rare': 'ç¨€æœ‰',
                'epic': 'å²è¯—',
                'legendary': 'ä¼ è¯´'
            };
            return rarityMap[rarity] || 'æ™®é€š';
        }

        // æ›´æ–°æ¦‚ç‡ç»Ÿè®¡
        function updateProbabilitySummary() {
            const activePrizes = prizes.filter(prize => prize.active);
            const totalProbability = activePrizes.reduce((sum, prize) => sum + parseFloat(prize.probability), 0);
            
            const totalElement = document.getElementById('totalProbability');
            const statusElement = document.getElementById('probabilityStatus');
            const autoBalanceBtn = document.getElementById('autoBalanceBtn');
            
            totalElement.textContent = totalProbability.toFixed(2) + '%';
            
            if (Math.abs(totalProbability - 100) < 0.01) {
                statusElement.textContent = 'å®Œç¾';
                statusElement.className = 'probability-status perfect';
                autoBalanceBtn.style.display = 'none';
            } else if (totalProbability < 100) {
                statusElement.textContent = `ç¼ºå°‘ ${(100 - totalProbability).toFixed(2)}%`;
                statusElement.className = 'probability-status low';
                autoBalanceBtn.style.display = 'inline-block';
            } else {
                statusElement.textContent = `è¶…å‡º ${(totalProbability - 100).toFixed(2)}%`;
                statusElement.className = 'probability-status high';
                autoBalanceBtn.style.display = 'none';
            }
        }

        // è‡ªåŠ¨å¹³è¡¡æ¦‚ç‡
        async function autoBalanceProbabilities() {
            const activePrizes = prizes.filter(prize => prize.active);
            if (activePrizes.length === 0) {
                showError('æ²¡æœ‰å¯ç”¨çš„å¥–å“éœ€è¦å¹³è¡¡');
                return;
            }

            const totalProbability = activePrizes.reduce((sum, prize) => sum + parseFloat(prize.probability), 0);
            if (totalProbability >= 100) {
                showError('æ€»æ¦‚ç‡å·²è¾¾åˆ°æˆ–è¶…è¿‡100%ï¼Œæ— éœ€è‡ªåŠ¨å¹³è¡¡');
                return;
            }

            const remainingProbability = 100 - totalProbability;
            const averageProbability = remainingProbability / activePrizes.length;

            // æ›´æ–°æ¯ä¸ªæ´»è·ƒå¥–å“çš„æ¦‚ç‡
            const updatePromises = activePrizes.map(async (prize) => {
                const newProbability = parseFloat(prize.probability) + averageProbability;
                
                const response = await fetch(`../../server/api/admin.php?action=update_prize&page=${currentLuckyPage}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: prize.id,
                        name: prize.name,
                        icon: prize.icon,
                        image_url: prize.image_url,
                        value: prize.value,
                        probability: newProbability,
                        rarity: prize.rarity,
                        active: prize.active
                    })
                });

                return response.json();
            });

            try {
                const results = await Promise.all(updatePromises);
                const allSuccess = results.every(result => result.success);
                
                if (allSuccess) {
                    showSuccess('æ¦‚ç‡å¹³è¡¡å®Œæˆï¼');
                    loadPrizes();
                } else {
                    showError('éƒ¨åˆ†å¥–å“æ¦‚ç‡æ›´æ–°å¤±è´¥');
                    loadPrizes();
                }
            } catch (error) {
                console.error('è‡ªåŠ¨å¹³è¡¡æ¦‚ç‡å¤±è´¥:', error);
                showError('è‡ªåŠ¨å¹³è¡¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // å¤„ç†ç¨€æœ‰åº¦å˜åŒ–
        function handleRarityChange() {
            const rarity = document.getElementById('prizeRarity').value;
            const quantityGroup = document.getElementById('quantityGroup');
            const restoreBtn = document.getElementById('restoreProbabilityBtn');
            const probabilityHint = document.getElementById('probabilityHint');
            
            if (rarity === 'legendary') {
                quantityGroup.style.display = 'block';
                document.getElementById('prizeQuantity').required = true;
                
                // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ä¸”æœ‰åŸå§‹æ¦‚ç‡ï¼Œæ˜¾ç¤ºæ¢å¤é€‰é¡¹
                if (editingPrizeId) {
                    const prize = prizes.find(p => p.id == editingPrizeId);
                    if (prize && prize.original_probability !== null && prize.original_probability !== undefined) {
                        const originalProb = parseFloat(prize.original_probability);
                        if (originalProb > 0) {
                            restoreBtn.style.display = 'block';
                            restoreBtn.dataset.originalProbability = originalProb;
                            probabilityHint.style.display = 'block';
                            probabilityHint.textContent = `æç¤ºï¼šè¯¥ä¼ è¯´ç‰©å“çš„åŸå§‹æ¦‚ç‡ä¸º ${originalProb}%`;
                        }
                    }
                }
            } else {
                quantityGroup.style.display = 'none';
                document.getElementById('prizeQuantity').required = false;
                document.getElementById('prizeQuantity').value = '';
                
                // éä¼ è¯´ç‰©å“éšè—æ¦‚ç‡æ¢å¤åŠŸèƒ½
                restoreBtn.style.display = 'none';
                probabilityHint.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºæ·»åŠ å¥–å“æ¨¡æ€æ¡†
        function showAddPrizeModal() {
            editingPrizeId = null;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ å¥–å“';
            document.getElementById('prizeForm').reset();
            document.getElementById('prizeId').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            
            // éšè—æ¦‚ç‡æ¢å¤ç›¸å…³å…ƒç´ 
            document.getElementById('restoreProbabilityBtn').style.display = 'none';
            document.getElementById('probabilityHint').style.display = 'none';
            
            document.getElementById('prizeModal').classList.add('show');
        }

        // æ˜¾ç¤ºç¼–è¾‘å¥–å“æ¨¡æ€æ¡†
        function editPrize(id) {
            const prize = prizes.find(p => p.id == id);
            if (!prize) return;

            editingPrizeId = id;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å¥–å“';
            document.getElementById('prizeId').value = prize.id;
            document.getElementById('prizeName').value = prize.name;
            document.getElementById('prizeIcon').value = prize.icon;
            document.getElementById('prizeImageUrl').value = prize.image_url || '';
            document.getElementById('prizeValue').value = prize.value;
            document.getElementById('prizeProbability').value = prize.probability;
            document.getElementById('prizeRarity').value = prize.rarity;
            document.getElementById('prizeActive').value = prize.active;
            
            // å¤„ç†ä¼ è¯´ç‰©å“çš„æ¦‚ç‡æ¢å¤åŠŸèƒ½
            const restoreBtn = document.getElementById('restoreProbabilityBtn');
            const probabilityHint = document.getElementById('probabilityHint');
            
            if (prize.rarity === 'legendary' && prize.original_probability !== null && prize.original_probability !== undefined) {
                const originalProb = parseFloat(prize.original_probability);
                const currentProb = parseFloat(prize.probability);
                
                // å¦‚æœå½“å‰æ¦‚ç‡ä¸º0ä¸”æœ‰åŸå§‹æ¦‚ç‡ï¼Œæ˜¾ç¤ºæ¢å¤æŒ‰é’®
                if (currentProb === 0 && originalProb > 0) {
                    restoreBtn.style.display = 'block';
                    restoreBtn.dataset.originalProbability = originalProb;
                    probabilityHint.style.display = 'block';
                    probabilityHint.textContent = `æç¤ºï¼šè¯¥ä¼ è¯´ç‰©å“çš„ä¸Šæ¬¡æ¦‚ç‡ä¸º ${originalProb}%ï¼Œå¯ç‚¹å‡»æŒ‰é’®å¿«é€Ÿæ¢å¤`;
                } else if (originalProb > 0 && originalProb !== currentProb) {
                    // å¦‚æœæœ‰åŸå§‹æ¦‚ç‡ä¸”ä¸å½“å‰æ¦‚ç‡ä¸åŒï¼Œä¹Ÿæ˜¾ç¤ºæ¢å¤é€‰é¡¹
                    restoreBtn.style.display = 'block';
                    restoreBtn.dataset.originalProbability = originalProb;
                    probabilityHint.style.display = 'block';
                    probabilityHint.textContent = `æç¤ºï¼šè¯¥ä¼ è¯´ç‰©å“çš„åŸå§‹æ¦‚ç‡ä¸º ${originalProb}%`;
                } else {
                    restoreBtn.style.display = 'none';
                    probabilityHint.style.display = 'none';
                }
            } else {
                restoreBtn.style.display = 'none';
                probabilityHint.style.display = 'none';
            }
            
            // å¤„ç†æ•°é‡å­—æ®µ
            if (prize.rarity === 'legendary') {
                document.getElementById('quantityGroup').style.display = 'block';
                document.getElementById('prizeQuantity').value = prize.quantity || '';
                document.getElementById('prizeQuantity').required = true;
            } else {
                document.getElementById('quantityGroup').style.display = 'none';
                document.getElementById('prizeQuantity').value = '';
                document.getElementById('prizeQuantity').required = false;
            }

            // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
            if (prize.image_url) {
                document.getElementById('imagePreview').innerHTML = 
                    `<img src="${prize.image_url}" alt="é¢„è§ˆ" class="preview-image">`;
            }

            document.getElementById('prizeModal').classList.add('show');
        }

        // æ¢å¤åŸå§‹æ¦‚ç‡
        function restoreOriginalProbability() {
            const restoreBtn = document.getElementById('restoreProbabilityBtn');
            const originalProbability = restoreBtn.dataset.originalProbability;
            
            if (originalProbability) {
                document.getElementById('prizeProbability').value = originalProbability;
                // éšè—æç¤ºï¼Œå› ä¸ºå·²ç»æ¢å¤äº†
                document.getElementById('probabilityHint').textContent = `å·²æ¢å¤åˆ°åŸå§‹æ¦‚ç‡ ${originalProbability}%ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨ä¿®æ”¹`;
            }
        }

        // å…³é—­å¥–å“æ¨¡æ€æ¡†
        function closePrizeModal() {
            document.getElementById('prizeModal').classList.remove('show');
            
            // é‡ç½®æ¦‚ç‡æ¢å¤ç›¸å…³å…ƒç´ 
            document.getElementById('restoreProbabilityBtn').style.display = 'none';
            document.getElementById('probabilityHint').style.display = 'none';
            document.getElementById('probabilityHint').textContent = '';
        }

        // ä¿å­˜å¥–å“
        async function savePrize() {
            const formData = {
                id: document.getElementById('prizeId').value,
                name: document.getElementById('prizeName').value,
                icon: document.getElementById('prizeIcon').value,
                image_url: document.getElementById('prizeImageUrl').value,
                value: parseFloat(document.getElementById('prizeValue').value),
                probability: parseFloat(document.getElementById('prizeProbability').value),
                rarity: document.getElementById('prizeRarity').value,
                active: parseInt(document.getElementById('prizeActive').value)
            };
            
            // å¦‚æœæ˜¯ä¼ è¯´ç‰©å“ï¼Œæ·»åŠ æ•°é‡å­—æ®µ
            if (formData.rarity === 'legendary') {
                const quantity = document.getElementById('prizeQuantity').value;
                if (!quantity || quantity < 1) {
                    showError('ä¼ è¯´ç‰©å“å¿…é¡»è®¾ç½®æ•°é‡ï¼Œä¸”æ•°é‡å¿…é¡»å¤§äº0');
                    return;
                }
                formData.quantity = parseInt(quantity);
            }

            // éªŒè¯æ¦‚ç‡
            if (formData.active) {
                const otherActivePrizes = prizes.filter(prize => 
                    prize.active && prize.id != formData.id
                );
                const otherProbabilitySum = otherActivePrizes.reduce((sum, prize) => 
                    sum + parseFloat(prize.probability), 0
                );
                const totalProbability = otherProbabilitySum + formData.probability;

                if (totalProbability > 100) {
                    showError(`æ¦‚ç‡è¶…è¿‡100%ï¼å½“å‰å…¶ä»–å¥–å“æ¦‚ç‡æ€»å’Œä¸º${otherProbabilitySum.toFixed(2)}%ï¼Œæœ€å¤šåªèƒ½è®¾ç½®${(100 - otherProbabilitySum).toFixed(2)}%`);
                    return;
                }
            }

            try {
                const action = editingPrizeId ? 'update_prize' : 'add_prize';
                const response = await fetch(`../../server/api/admin.php?action=${action}&page=${encodeURIComponent(window.currentLuckyPage)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess(editingPrizeId ? 'å¥–å“æ›´æ–°æˆåŠŸï¼' : 'å¥–å“æ·»åŠ æˆåŠŸï¼');
                    closePrizeModal();
                    loadPrizes();
                } else {
                    showError('ä¿å­˜å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜å¥–å“å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åˆ‡æ¢å¥–å“çŠ¶æ€
        async function togglePrize(id, currentStatus) {
            try {
                const response = await fetch(`../../server/api/admin.php?action=toggle_prize&page=${encodeURIComponent(window.currentLuckyPage)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: id,
                        active: !currentStatus
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('å¥–å“çŠ¶æ€æ›´æ–°æˆåŠŸï¼');
                    loadPrizes();
                } else {
                    showError('æ›´æ–°å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æ›´æ–°å¥–å“çŠ¶æ€å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åˆ é™¤å¥–å“
        async function deletePrize(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥–å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            try {
                const response = await fetch(`../../server/api/admin.php?action=delete_prize&id=${id}&page=${encodeURIComponent(window.currentLuckyPage)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('å¥–å“åˆ é™¤æˆåŠŸï¼');
                    loadPrizes();
                } else {
                    showError('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤å¥–å“å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // è¿”å›ä¸»é¡µ
        function goToHome() {
            window.location.href = '../../index.html';
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            // ç®€å•çš„é”™è¯¯æ˜¾ç¤ºï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ”¹è¿›
            alert('é”™è¯¯: ' + message);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            // ç®€å•çš„æˆåŠŸæ˜¾ç¤ºï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ”¹è¿›
            alert('æˆåŠŸ: ' + message);
        }
    </script>
</body>
</html>
