<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥–å“ç®¡ç† - å¤§çº¢è¡ŒåŠ¨</title>
    <script src="../../js/api-client.js"></script>
    <script>
        // è¶…çº§ç®¡ç†å‘˜æƒé™éªŒè¯ - ç®€åŒ–ç‰ˆæœ¬
        async function checkAdminAccess() {
            try {
                // ç›´æ¥æ£€æŸ¥è¶…çº§ç®¡ç†å‘˜sessionçŠ¶æ€
                const response = await fetch('../../server/api/super-admin.php?action=check');
                const data = await response.json();
                
                if (!data.authenticated) {
                    alert('éœ€è¦è¶…çº§ç®¡ç†å‘˜æƒé™ï¼è¯·å…ˆç™»å½•ã€‚');
                    window.location.href = '../../super-admin.html';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('æƒé™éªŒè¯å¤±è´¥:', error);
                alert('ç³»ç»Ÿé”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•ï¼');
                window.location.href = '../../super-admin.html';
                return false;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶ç«‹å³éªŒè¯
        checkAdminAccess();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0c0c0c, #1a1a1a);
            color: #fff;
            min-height: 100vh;
        }

        .admin-header {
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 0;
            border-bottom: 2px solid #ffd700;
            text-align: center;
        }

        .admin-header h1 {
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            font-size: 32px;
            cursor: pointer;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .admin-nav {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            justify-content: center;
        }

        .nav-btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .nav-btn.active {
            background: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        .probability-summary {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .probability-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .probability-label {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .probability-value {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .probability-status {
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }

        .probability-status.perfect {
            background: #22c55e;
            color: #000;
        }

        .probability-status.low {
            background: #f59e0b;
            color: #000;
        }

        .probability-status.high {
            background: #ef4444;
            color: #fff;
        }

        .prizes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .prize-card {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .prize-card:hover {
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.3);
            transform: translateY(-5px);
        }

        .prize-image-container {
            text-align: center;
            margin-bottom: 15px;
        }

        .prize-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #ffd700;
            margin-bottom: 10px;
        }

        .prize-icon {
            font-size: 60px;
            margin-bottom: 10px;
            display: block;
        }

        .prize-info h3 {
            color: #ffd700;
            margin-bottom: 10px;
            text-align: center;
        }

        .prize-details {
            display: grid;
            gap: 8px;
            margin-bottom: 15px;
        }

        .prize-detail {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .prize-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
        }

        .btn-edit:hover {
            background: #2563eb;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .btn-toggle {
            background: #10b981;
            color: white;
        }

        .btn-toggle:hover {
            background: #059669;
        }

        .btn-toggle.inactive {
            background: #6b7280;
        }

        .add-prize-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            border: none;
            border-radius: 50%;
            color: #000;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
            transition: all 0.3s ease;
        }

        .add-prize-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #ffd700;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #ffd700;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffd700;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .image-preview {
            text-align: center;
            margin: 10px 0;
        }

        .preview-image {
            max-width: 100px;
            max-height: 100px;
            border-radius: 5px;
            border: 2px solid #ffd700;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .loading {
            text-align: center;
            color: #ffd700;
            font-size: 18px;
            padding: 40px;
        }

        .error {
            color: #ef4444;
            text-align: center;
            margin: 20px 0;
        }

        .success {
            color: #10b981;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .prizes-grid {
                grid-template-columns: 1fr;
            }

            .admin-nav {
                flex-direction: column;
                align-items: center;
            }

            .modal-content {
                margin: 20px;
                width: calc(100% - 40px);
            }
        }

        /* æŠ½å¥–ä»·æ ¼æ§åˆ¶åŒºåŸŸæ ·å¼ */
        .price-control-section {
            background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,20,20,0.95));
            border-top: 2px solid #ffd700;
            padding: 30px 0;
            margin-top: 40px;
        }

        .price-control-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .price-control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 20px;
        }

        .price-control-header h3 {
            color: #ffd700;
            font-size: 24px;
            margin: 0;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .current-page-indicator {
            color: #fff;
            font-size: 16px;
        }

        .current-page-indicator span:last-child {
            color: #ffd700;
            font-weight: bold;
        }

        .price-control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .price-item {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .price-item:hover {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        .price-item label {
            display: block;
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .price-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .price-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .price-input-group input:focus {
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            outline: none;
        }

        .btn-update {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-update:hover {
            background: linear-gradient(45deg, #ffed4e, #ffd700);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .price-control-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn-warning {
            background: linear-gradient(45deg, #f59e0b, #fbbf24);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-warning:hover {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .price-history {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .price-history h4 {
            color: #ffd700;
            margin: 0 0 15px 0;
            font-size: 18px;
        }

        .price-history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            color: #ccc;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-time {
            color: #888;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .price-control-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .price-control-grid {
                grid-template-columns: 1fr;
            }

            .price-control-actions {
                flex-direction: column;
                align-items: center;
            }

            .price-input-group {
                flex-direction: column;
            }

            .btn-update {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1 onclick="goToHome()">å¥–å“ç®¡ç†ç³»ç»Ÿ</h1>
        <div id="currentLuckyPage" style="margin-top:10px;color:#ffd700;font-size:18px;"></div>
    </div>

    <div class="admin-container">
        <div class="admin-nav">
            <a href="admin.html" class="nav-btn">ç”¨æˆ·ç®¡ç†</a>
            <button class="nav-btn active">å¥–å“ç®¡ç†</button>
            <button class="nav-btn" onclick="showLimitedDropConfig()">é™æ—¶æ‰è½é…ç½®</button>
            <a href="../main.html" class="nav-btn">è¿”å›æ¸¸æˆ</a>
        </div>

        <!-- æ¦‚ç‡ç»Ÿè®¡æ˜¾ç¤º -->
        <div class="probability-summary">
            <div class="probability-info">
                <span class="probability-label">æ€»æ¦‚ç‡:</span>
                <span id="totalProbability" class="probability-value">0%</span>
                <span id="probabilityStatus" class="probability-status"></span>
            </div>
            <div class="probability-actions">
                <button id="autoBalanceBtn" class="nav-btn" onclick="autoBalanceProbabilities()" style="display:none;">è‡ªåŠ¨å¹³è¡¡æ¦‚ç‡</button>
            </div>
        </div>

        <div id="prizesContainer" class="prizes-grid">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>

        <button class="add-prize-btn" onclick="showAddPrizeModal()" title="æ·»åŠ æ–°å¥–å“">+</button>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘å¥–å“æ¨¡æ€æ¡† -->
    <div id="prizeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ·»åŠ å¥–å“</h2>
            </div>
            
            <form id="prizeForm">
                <input type="hidden" id="prizeId">
                
                <div class="form-group">
                    <label for="prizeName">å¥–å“åç§°</label>
                    <input type="text" id="prizeName" required>
                </div>

                <div class="form-group">
                    <label for="prizeIcon">å¥–å“å›¾æ ‡ (Emoji)</label>
                    <input type="text" id="prizeIcon" placeholder="ğŸ“±">
                </div>

                <div class="form-group">
                    <label for="prizeImageUrl">å¥–å“å›¾ç‰‡URL</label>
                    <input type="url" id="prizeImageUrl" placeholder="https://example.com/image.jpg">
                    <div class="image-preview" id="imagePreview"></div>
                </div>

                <div class="form-group">
                    <label for="prizeValue">å¥–å“ä»·å€¼</label>
                    <input type="number" id="prizeValue" min="0" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="prizeProbability">ä¸­å¥–æ¦‚ç‡ (%)</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="prizeProbability" min="0" max="100" step="0.01" required style="flex: 1;">
                        <button type="button" id="restoreProbabilityBtn" onclick="restoreOriginalProbability()" 
                                style="display: none; padding: 8px 12px; background: #ffd700; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
                            æ¢å¤ä¸Šæ¬¡æ¦‚ç‡
                        </button>
                    </div>
                    <small id="probabilityHint" style="color: #888; display: none; margin-top: 5px;"></small>
                </div>

                <div class="form-group">
                    <label for="prizeRarity">ç¨€æœ‰åº¦</label>
                    <select id="prizeRarity" required onchange="handleRarityChange()">
                        <option value="common">æ™®é€š</option>
                        <option value="rare">ç¨€æœ‰</option>
                        <option value="epic">å²è¯—</option>
                        <option value="legendary">ä¼ è¯´</option>
                    </select>
                </div>

                <div class="form-group" id="quantityGroup" style="display: none;">
                    <label for="prizeQuantity">æ•°é‡é™åˆ¶</label>
                    <input type="number" id="prizeQuantity" min="1" placeholder="è¾“å…¥ä¼ è¯´ç‰©å“æ•°é‡">
                    <small style="color: #ccc; font-size: 12px;">ä»…ä¼ è¯´ç‰©å“éœ€è¦è®¾ç½®æ•°é‡é™åˆ¶</small>
                </div>

                <div class="form-group">
                    <label for="prizeActive">çŠ¶æ€</label>
                    <select id="prizeActive" required>
                        <option value="1">å¯ç”¨</option>
                        <option value="0">ç¦ç”¨</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn-secondary" onclick="closePrizeModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æŠ½å¥–ä»·æ ¼æ§åˆ¶åŒºåŸŸ -->
    <div class="price-control-section">
        <div class="price-control-container">
            <div class="price-control-header">
                <h3>æŠ½å¥–ä»·æ ¼è®¾ç½®</h3>
                <div class="current-page-indicator">
                    <span>å½“å‰é¡µé¢: </span>
                    <span id="priceControlCurrentPage"></span>
                </div>
            </div>
            
            <div class="price-control-content">
                <div class="price-control-grid">
                    <div class="price-item">
                        <label for="singleDrawPrice">å•æŠ½ä»·æ ¼ (é‡‘å¸)</label>
                        <div class="price-input-group">
                            <input type="number" id="singleDrawPrice" min="1" value="10">
                            <button type="button" onclick="updateDrawPrice('single')" class="btn-update">æ›´æ–°</button>
                        </div>
                    </div>
                    
                    <div class="price-item">
                        <label for="tripleDrawPrice">ä¸‰è¿æŠ½ä»·æ ¼ (é‡‘å¸)</label>
                        <div class="price-input-group">
                            <input type="number" id="tripleDrawPrice" min="1" value="30">
                            <button type="button" onclick="updateDrawPrice('triple')" class="btn-update">æ›´æ–°</button>
                        </div>
                    </div>
                    
                    <div class="price-item">
                        <label for="quintupleDrawPrice">äº”è¿æŠ½ä»·æ ¼ (é‡‘å¸)</label>
                        <div class="price-input-group">
                            <input type="number" id="quintupleDrawPrice" min="1" value="50">
                            <button type="button" onclick="updateDrawPrice('quintuple')" class="btn-update">æ›´æ–°</button>
                        </div>
                    </div>
                </div>
                
                <div class="price-control-actions">
                    <button type="button" onclick="loadCurrentPrices()" class="btn-secondary">åˆ·æ–°ä»·æ ¼</button>
                    <button type="button" onclick="resetToDefaultPrices()" class="btn-warning">æ¢å¤é»˜è®¤ä»·æ ¼</button>
                    <button type="button" onclick="batchUpdatePrices()" class="btn-primary">æ‰¹é‡æ›´æ–°</button>
                </div>
                
                <div class="price-history">
                    <h4>ä»·æ ¼æ›´æ–°å†å²</h4>
                    <div id="priceHistory" class="price-history-list">
                        <div class="loading">åŠ è½½å†å²è®°å½•ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let prizes = [];
        let editingPrizeId = null;

        // è·å–URLå‚æ•°
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const luckyPage = getQueryParam('page') || 'lucky1.html';
            document.getElementById('currentLuckyPage').textContent = 'å½“å‰ç®¡ç†é¡µé¢: ' + luckyPage;
            document.getElementById('priceControlCurrentPage').textContent = luckyPage;
            window.currentLuckyPage = luckyPage;
            loadPrizes();
            setupEventListeners();
            loadCurrentPrices(); // åŠ è½½å½“å‰ä»·æ ¼è®¾ç½®
            loadPriceHistory(); // åŠ è½½ä»·æ ¼å†å²
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å›¾ç‰‡URLé¢„è§ˆ
            document.getElementById('prizeImageUrl').addEventListener('input', function() {
                const url = this.value;
                const preview = document.getElementById('imagePreview');
                
                if (url) {
                    preview.innerHTML = `<img src="${url}" alt="é¢„è§ˆ" class="preview-image" onerror="this.style.display='none'">`;
                } else {
                    preview.innerHTML = '';
                }
            });

            // è¡¨å•æäº¤
            document.getElementById('prizeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                savePrize();
            });
        }

        // åŠ è½½å¥–å“åˆ—è¡¨
        async function loadPrizes() {
            try {
                // ä¼ é€’luckyé¡µé¢å‚æ•°ï¼Œåç«¯å¯æ®æ­¤åŒºåˆ†ä¸åŒé¡µé¢å¥–å“
                const response = await fetch(`../../server/api/admin.php?action=prizes&page=${encodeURIComponent(window.currentLuckyPage)}`);
                const data = await response.json();
                
                if (data.success) {
                    prizes = data.prizes;
                    renderPrizes();
                    updateProbabilitySummary();
                } else {
                    showError('åŠ è½½å¥–å“å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åŠ è½½å¥–å“å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ¸²æŸ“å¥–å“åˆ—è¡¨
        function renderPrizes() {
            const container = document.getElementById('prizesContainer');
            
            if (prizes.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— å¥–å“æ•°æ®</div>';
                return;
            }

            container.innerHTML = prizes.map(prize => `
                <div class="prize-card">
                    <div class="prize-image-container">
                        ${prize.image_url ? 
                            `<img src="${prize.image_url}" alt="${prize.name}" class="prize-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                             <span class="prize-icon" style="display:none;">${prize.icon}</span>` :
                            `<span class="prize-icon">${prize.icon}</span>`
                        }
                    </div>
                    <div class="prize-info">
                        <h3>${prize.name}</h3>
                        <div class="prize-details">
                            <div class="prize-detail">
                                <span>ä»·å€¼:</span>
                                <span>Â¥${prize.value}</span>
                            </div>
                            <div class="prize-detail">
                                <span>æ¦‚ç‡:</span>
                                <span>${prize.probability}%${
                                    prize.rarity === 'legendary' && 
                                    parseFloat(prize.probability) === 0 && 
                                    prize.original_probability !== null && 
                                    parseFloat(prize.original_probability) > 0 
                                    ? ` <small style="color: #ffd700;">(å¯æ¢å¤è‡³${prize.original_probability}%)</small>` 
                                    : ''
                                }</span>
                            </div>
                            <div class="prize-detail">
                                <span>ç¨€æœ‰åº¦:</span>
                                <span>${getRarityText(prize.rarity)}</span>
                            </div>
                            ${prize.rarity === 'legendary' && prize.quantity !== null ? 
                                `<div class="prize-detail">
                                    <span>æ•°é‡:</span>
                                    <span style="color: ${prize.quantity <= 0 ? '#ff4444' : '#44ff44'}">${prize.quantity}</span>
                                </div>` : ''
                            }
                            <div class="prize-detail">
                                <span>çŠ¶æ€:</span>
                                <span>${prize.active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span>
                            </div>
                        </div>
                        <div class="prize-actions">
                            <button class="btn btn-edit" onclick="editPrize(${prize.id})">ç¼–è¾‘</button>
                            <button class="btn btn-toggle ${prize.active ? '' : 'inactive'}" 
                                    onclick="togglePrize(${prize.id}, ${prize.active})">
                                ${prize.active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn btn-delete" onclick="deletePrize(${prize.id})">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // è·å–ç¨€æœ‰åº¦æ–‡æœ¬
        function getRarityText(rarity) {
            const rarityMap = {
                'common': 'æ™®é€š',
                'rare': 'ç¨€æœ‰',
                'epic': 'å²è¯—',
                'legendary': 'ä¼ è¯´'
            };
            return rarityMap[rarity] || 'æ™®é€š';
        }

        // æ›´æ–°æ¦‚ç‡ç»Ÿè®¡
        function updateProbabilitySummary() {
            const activePrizes = prizes.filter(prize => prize.active);
            const totalProbability = activePrizes.reduce((sum, prize) => sum + parseFloat(prize.probability), 0);
            
            const totalElement = document.getElementById('totalProbability');
            const statusElement = document.getElementById('probabilityStatus');
            const autoBalanceBtn = document.getElementById('autoBalanceBtn');
            
            totalElement.textContent = totalProbability.toFixed(2) + '%';
            
            if (Math.abs(totalProbability - 100) < 0.01) {
                statusElement.textContent = 'å®Œç¾';
                statusElement.className = 'probability-status perfect';
                autoBalanceBtn.style.display = 'none';
            } else if (totalProbability < 100) {
                statusElement.textContent = `ç¼ºå°‘ ${(100 - totalProbability).toFixed(2)}%`;
                statusElement.className = 'probability-status low';
                autoBalanceBtn.style.display = 'inline-block';
            } else {
                statusElement.textContent = `è¶…å‡º ${(totalProbability - 100).toFixed(2)}%`;
                statusElement.className = 'probability-status high';
                autoBalanceBtn.style.display = 'none';
            }
        }

        // è‡ªåŠ¨å¹³è¡¡æ¦‚ç‡
        async function autoBalanceProbabilities() {
            const activePrizes = prizes.filter(prize => prize.active);
            if (activePrizes.length === 0) {
                showError('æ²¡æœ‰å¯ç”¨çš„å¥–å“éœ€è¦å¹³è¡¡');
                return;
            }

            const totalProbability = activePrizes.reduce((sum, prize) => sum + parseFloat(prize.probability), 0);
            if (totalProbability >= 100) {
                showError('æ€»æ¦‚ç‡å·²è¾¾åˆ°æˆ–è¶…è¿‡100%ï¼Œæ— éœ€è‡ªåŠ¨å¹³è¡¡');
                return;
            }

            const remainingProbability = 100 - totalProbability;
            const averageProbability = remainingProbability / activePrizes.length;

            // æ›´æ–°æ¯ä¸ªæ´»è·ƒå¥–å“çš„æ¦‚ç‡
            const updatePromises = activePrizes.map(async (prize) => {
                const newProbability = parseFloat(prize.probability) + averageProbability;
                
                const response = await fetch(`../../server/api/admin.php?action=update_prize&page=${currentLuckyPage}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: prize.id,
                        name: prize.name,
                        icon: prize.icon,
                        image_url: prize.image_url,
                        value: prize.value,
                        probability: newProbability,
                        rarity: prize.rarity,
                        active: prize.active
                    })
                });

                return response.json();
            });

            try {
                const results = await Promise.all(updatePromises);
                const allSuccess = results.every(result => result.success);
                
                if (allSuccess) {
                    showSuccess('æ¦‚ç‡å¹³è¡¡å®Œæˆï¼');
                    loadPrizes();
                } else {
                    showError('éƒ¨åˆ†å¥–å“æ¦‚ç‡æ›´æ–°å¤±è´¥');
                    loadPrizes();
                }
            } catch (error) {
                console.error('è‡ªåŠ¨å¹³è¡¡æ¦‚ç‡å¤±è´¥:', error);
                showError('è‡ªåŠ¨å¹³è¡¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // å¤„ç†ç¨€æœ‰åº¦å˜åŒ–
        function handleRarityChange() {
            const rarity = document.getElementById('prizeRarity').value;
            const quantityGroup = document.getElementById('quantityGroup');
            const restoreBtn = document.getElementById('restoreProbabilityBtn');
            const probabilityHint = document.getElementById('probabilityHint');
            
            if (rarity === 'legendary') {
                quantityGroup.style.display = 'block';
                document.getElementById('prizeQuantity').required = true;
                
                // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ä¸”æœ‰åŸå§‹æ¦‚ç‡ï¼Œæ˜¾ç¤ºæ¢å¤é€‰é¡¹
                if (editingPrizeId) {
                    const prize = prizes.find(p => p.id == editingPrizeId);
                    if (prize && prize.original_probability !== null && prize.original_probability !== undefined) {
                        const originalProb = parseFloat(prize.original_probability);
                        if (originalProb > 0) {
                            restoreBtn.style.display = 'block';
                            restoreBtn.dataset.originalProbability = originalProb;
                            probabilityHint.style.display = 'block';
                            probabilityHint.textContent = `æç¤ºï¼šè¯¥ä¼ è¯´ç‰©å“çš„åŸå§‹æ¦‚ç‡ä¸º ${originalProb}%`;
                        }
                    }
                }
            } else {
                quantityGroup.style.display = 'none';
                document.getElementById('prizeQuantity').required = false;
                document.getElementById('prizeQuantity').value = '';
                
                // éä¼ è¯´ç‰©å“éšè—æ¦‚ç‡æ¢å¤åŠŸèƒ½
                restoreBtn.style.display = 'none';
                probabilityHint.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºæ·»åŠ å¥–å“æ¨¡æ€æ¡†
        function showAddPrizeModal() {
            editingPrizeId = null;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ å¥–å“';
            document.getElementById('prizeForm').reset();
            document.getElementById('prizeId').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            
            // éšè—æ¦‚ç‡æ¢å¤ç›¸å…³å…ƒç´ 
            document.getElementById('restoreProbabilityBtn').style.display = 'none';
            document.getElementById('probabilityHint').style.display = 'none';
            
            document.getElementById('prizeModal').classList.add('show');
        }

        // æ˜¾ç¤ºç¼–è¾‘å¥–å“æ¨¡æ€æ¡†
        function editPrize(id) {
            const prize = prizes.find(p => p.id == id);
            if (!prize) return;

            editingPrizeId = id;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å¥–å“';
            document.getElementById('prizeId').value = prize.id;
            document.getElementById('prizeName').value = prize.name;
            document.getElementById('prizeIcon').value = prize.icon;
            document.getElementById('prizeImageUrl').value = prize.image_url || '';
            document.getElementById('prizeValue').value = prize.value;
            document.getElementById('prizeProbability').value = prize.probability;
            document.getElementById('prizeRarity').value = prize.rarity;
            document.getElementById('prizeActive').value = prize.active;
            
            // å¤„ç†ä¼ è¯´ç‰©å“çš„æ¦‚ç‡æ¢å¤åŠŸèƒ½
            const restoreBtn = document.getElementById('restoreProbabilityBtn');
            const probabilityHint = document.getElementById('probabilityHint');
            
            if (prize.rarity === 'legendary' && prize.original_probability !== null && prize.original_probability !== undefined) {
                const originalProb = parseFloat(prize.original_probability);
                const currentProb = parseFloat(prize.probability);
                
                // å¦‚æœå½“å‰æ¦‚ç‡ä¸º0ä¸”æœ‰åŸå§‹æ¦‚ç‡ï¼Œæ˜¾ç¤ºæ¢å¤æŒ‰é’®
                if (currentProb === 0 && originalProb > 0) {
                    restoreBtn.style.display = 'block';
                    restoreBtn.dataset.originalProbability = originalProb;
                    probabilityHint.style.display = 'block';
                    probabilityHint.textContent = `æç¤ºï¼šè¯¥ä¼ è¯´ç‰©å“çš„ä¸Šæ¬¡æ¦‚ç‡ä¸º ${originalProb}%ï¼Œå¯ç‚¹å‡»æŒ‰é’®å¿«é€Ÿæ¢å¤`;
                } else if (originalProb > 0 && originalProb !== currentProb) {
                    // å¦‚æœæœ‰åŸå§‹æ¦‚ç‡ä¸”ä¸å½“å‰æ¦‚ç‡ä¸åŒï¼Œä¹Ÿæ˜¾ç¤ºæ¢å¤é€‰é¡¹
                    restoreBtn.style.display = 'block';
                    restoreBtn.dataset.originalProbability = originalProb;
                    probabilityHint.style.display = 'block';
                    probabilityHint.textContent = `æç¤ºï¼šè¯¥ä¼ è¯´ç‰©å“çš„åŸå§‹æ¦‚ç‡ä¸º ${originalProb}%`;
                } else {
                    restoreBtn.style.display = 'none';
                    probabilityHint.style.display = 'none';
                }
            } else {
                restoreBtn.style.display = 'none';
                probabilityHint.style.display = 'none';
            }
            
            // å¤„ç†æ•°é‡å­—æ®µ
            if (prize.rarity === 'legendary') {
                document.getElementById('quantityGroup').style.display = 'block';
                document.getElementById('prizeQuantity').value = prize.quantity || '';
                document.getElementById('prizeQuantity').required = true;
            } else {
                document.getElementById('quantityGroup').style.display = 'none';
                document.getElementById('prizeQuantity').value = '';
                document.getElementById('prizeQuantity').required = false;
            }

            // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
            if (prize.image_url) {
                document.getElementById('imagePreview').innerHTML = 
                    `<img src="${prize.image_url}" alt="é¢„è§ˆ" class="preview-image">`;
            }

            document.getElementById('prizeModal').classList.add('show');
        }

        // æ¢å¤åŸå§‹æ¦‚ç‡
        function restoreOriginalProbability() {
            const restoreBtn = document.getElementById('restoreProbabilityBtn');
            const originalProbability = restoreBtn.dataset.originalProbability;
            
            if (originalProbability) {
                document.getElementById('prizeProbability').value = originalProbability;
                // éšè—æç¤ºï¼Œå› ä¸ºå·²ç»æ¢å¤äº†
                document.getElementById('probabilityHint').textContent = `å·²æ¢å¤åˆ°åŸå§‹æ¦‚ç‡ ${originalProbability}%ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨ä¿®æ”¹`;
            }
        }

        // å…³é—­å¥–å“æ¨¡æ€æ¡†
        function closePrizeModal() {
            document.getElementById('prizeModal').classList.remove('show');
            
            // é‡ç½®æ¦‚ç‡æ¢å¤ç›¸å…³å…ƒç´ 
            document.getElementById('restoreProbabilityBtn').style.display = 'none';
            document.getElementById('probabilityHint').style.display = 'none';
            document.getElementById('probabilityHint').textContent = '';
        }

        // ä¿å­˜å¥–å“
        async function savePrize() {
            const formData = {
                id: document.getElementById('prizeId').value,
                name: document.getElementById('prizeName').value,
                icon: document.getElementById('prizeIcon').value,
                image_url: document.getElementById('prizeImageUrl').value,
                value: parseFloat(document.getElementById('prizeValue').value),
                probability: parseFloat(document.getElementById('prizeProbability').value),
                rarity: document.getElementById('prizeRarity').value,
                active: parseInt(document.getElementById('prizeActive').value)
            };
            
            // å¦‚æœæ˜¯ä¼ è¯´ç‰©å“ï¼Œæ·»åŠ æ•°é‡å­—æ®µ
            if (formData.rarity === 'legendary') {
                const quantity = document.getElementById('prizeQuantity').value;
                if (!quantity || quantity < 1) {
                    showError('ä¼ è¯´ç‰©å“å¿…é¡»è®¾ç½®æ•°é‡ï¼Œä¸”æ•°é‡å¿…é¡»å¤§äº0');
                    return;
                }
                formData.quantity = parseInt(quantity);
            }

            // éªŒè¯æ¦‚ç‡
            if (formData.active) {
                const otherActivePrizes = prizes.filter(prize => 
                    prize.active && prize.id != formData.id
                );
                const otherProbabilitySum = otherActivePrizes.reduce((sum, prize) => 
                    sum + parseFloat(prize.probability), 0
                );
                const totalProbability = otherProbabilitySum + formData.probability;

                if (totalProbability > 100) {
                    showError(`æ¦‚ç‡è¶…è¿‡100%ï¼å½“å‰å…¶ä»–å¥–å“æ¦‚ç‡æ€»å’Œä¸º${otherProbabilitySum.toFixed(2)}%ï¼Œæœ€å¤šåªèƒ½è®¾ç½®${(100 - otherProbabilitySum).toFixed(2)}%`);
                    return;
                }
            }

            try {
                const action = editingPrizeId ? 'update_prize' : 'add_prize';
                const response = await fetch(`../../server/api/admin.php?action=${action}&page=${encodeURIComponent(window.currentLuckyPage)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess(editingPrizeId ? 'å¥–å“æ›´æ–°æˆåŠŸï¼' : 'å¥–å“æ·»åŠ æˆåŠŸï¼');
                    closePrizeModal();
                    loadPrizes();
                } else {
                    showError('ä¿å­˜å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜å¥–å“å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åˆ‡æ¢å¥–å“çŠ¶æ€
        async function togglePrize(id, currentStatus) {
            try {
                const response = await fetch(`../../server/api/admin.php?action=toggle_prize&page=${encodeURIComponent(window.currentLuckyPage)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: id,
                        active: !currentStatus
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('å¥–å“çŠ¶æ€æ›´æ–°æˆåŠŸï¼');
                    loadPrizes();
                } else {
                    showError('æ›´æ–°å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æ›´æ–°å¥–å“çŠ¶æ€å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åˆ é™¤å¥–å“
        async function deletePrize(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥–å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            try {
                const response = await fetch(`../../server/api/admin.php?action=delete_prize&id=${id}&page=${encodeURIComponent(window.currentLuckyPage)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('å¥–å“åˆ é™¤æˆåŠŸï¼');
                    loadPrizes();
                } else {
                    showError('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤å¥–å“å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // è¿”å›ä¸»é¡µ
        function goToHome() {
            window.location.href = '../../index.html';
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            // ç®€å•çš„é”™è¯¯æ˜¾ç¤ºï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ”¹è¿›
            alert('é”™è¯¯: ' + message);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            // ç®€å•çš„æˆåŠŸæ˜¾ç¤ºï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ”¹è¿›
            alert('æˆåŠŸ: ' + message);
        }

        // ======== æŠ½å¥–ä»·æ ¼æ§åˆ¶åŠŸèƒ½ ========

        // åŠ è½½å½“å‰ä»·æ ¼è®¾ç½®
        async function loadCurrentPrices() {
            try {
                const response = await fetch(`../../server/api/admin.php?action=get_draw_prices&page=${encodeURIComponent(window.currentLuckyPage)}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('singleDrawPrice').value = data.prices.single || 10;
                    document.getElementById('tripleDrawPrice').value = data.prices.triple || 30;
                    document.getElementById('quintupleDrawPrice').value = data.prices.quintuple || 50;
                } else {
                    console.warn('åŠ è½½ä»·æ ¼å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', data.error);
                }
            } catch (error) {
                console.error('åŠ è½½ä»·æ ¼å¤±è´¥:', error);
            }
        }

        // æ›´æ–°å•ä¸ªæŠ½å¥–ä»·æ ¼
        async function updateDrawPrice(type) {
            let price, element, typeName;
            
            switch(type) {
                case 'single':
                    element = document.getElementById('singleDrawPrice');
                    price = element.value;
                    typeName = 'å•æŠ½';
                    break;
                case 'triple':
                    element = document.getElementById('tripleDrawPrice');
                    price = element.value;
                    typeName = 'ä¸‰è¿æŠ½';
                    break;
                case 'quintuple':
                    element = document.getElementById('quintupleDrawPrice');
                    price = element.value;
                    typeName = 'äº”è¿æŠ½';
                    break;
                default:
                    showError('æœªçŸ¥çš„æŠ½å¥–ç±»å‹');
                    return;
            }

            if (!price || price < 1) {
                showError('ä»·æ ¼å¿…é¡»å¤§äº0');
                return;
            }

            try {
                const response = await fetch('../../server/api/admin.php?action=update_draw_price', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        page: window.currentLuckyPage,
                        type: type,
                        price: parseInt(price)
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`${typeName}ä»·æ ¼å·²æ›´æ–°ä¸º ${price} é‡‘å¸`);
                    loadPriceHistory(); // åˆ·æ–°å†å²è®°å½•
                } else {
                    showError('æ›´æ–°å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æ›´æ–°ä»·æ ¼å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ‰¹é‡æ›´æ–°ä»·æ ¼
        async function batchUpdatePrices() {
            const singlePrice = document.getElementById('singleDrawPrice').value;
            const triplePrice = document.getElementById('tripleDrawPrice').value;
            const quintuplePrice = document.getElementById('quintupleDrawPrice').value;

            if (!singlePrice || !triplePrice || !quintuplePrice || 
                singlePrice < 1 || triplePrice < 1 || quintuplePrice < 1) {
                showError('æ‰€æœ‰ä»·æ ¼å¿…é¡»å¤§äº0');
                return;
            }

            if (!confirm('ç¡®å®šè¦æ‰¹é‡æ›´æ–°æ‰€æœ‰æŠ½å¥–ä»·æ ¼å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch('../../server/api/admin.php?action=batch_update_draw_prices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        page: window.currentLuckyPage,
                        prices: {
                            single: parseInt(singlePrice),
                            triple: parseInt(triplePrice),
                            quintuple: parseInt(quintuplePrice)
                        }
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('æ‰€æœ‰ä»·æ ¼å·²æˆåŠŸæ›´æ–°ï¼');
                    loadPriceHistory(); // åˆ·æ–°å†å²è®°å½•
                } else {
                    showError('æ‰¹é‡æ›´æ–°å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æ‰¹é‡æ›´æ–°ä»·æ ¼å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ¢å¤é»˜è®¤ä»·æ ¼
        async function resetToDefaultPrices() {
            if (!confirm('ç¡®å®šè¦æ¢å¤åˆ°é»˜è®¤ä»·æ ¼å—ï¼Ÿ\nå•æŠ½: 10é‡‘å¸\nä¸‰è¿æŠ½: 30é‡‘å¸\näº”è¿æŠ½: 50é‡‘å¸')) {
                return;
            }

            try {
                const response = await fetch('../../server/api/admin.php?action=reset_draw_prices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        page: window.currentLuckyPage
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('ä»·æ ¼å·²æ¢å¤ä¸ºé»˜è®¤å€¼ï¼');
                    loadCurrentPrices(); // åˆ·æ–°å½“å‰ä»·æ ¼æ˜¾ç¤º
                    loadPriceHistory(); // åˆ·æ–°å†å²è®°å½•
                } else {
                    showError('æ¢å¤é»˜è®¤ä»·æ ¼å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æ¢å¤é»˜è®¤ä»·æ ¼å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åŠ è½½ä»·æ ¼å†å²
        async function loadPriceHistory() {
            try {
                const response = await fetch(`../../server/api/admin.php?action=get_price_history&page=${encodeURIComponent(window.currentLuckyPage)}`);
                const data = await response.json();
                
                const historyContainer = document.getElementById('priceHistory');
                
                if (data.success && data.history && data.history.length > 0) {
                    const historyHtml = data.history.map(item => `
                        <div class="history-item">
                            <div>
                                <strong>${getTypeDisplayName(item.type)}</strong>: 
                                ${item.old_price} â†’ ${item.new_price} é‡‘å¸
                            </div>
                            <div class="history-time">${formatTime(item.created_at)}</div>
                        </div>
                    `).join('');
                    historyContainer.innerHTML = historyHtml;
                } else {
                    historyContainer.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">æš‚æ— ä»·æ ¼æ›´æ–°å†å²</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ä»·æ ¼å†å²å¤±è´¥:', error);
                document.getElementById('priceHistory').innerHTML = '<div style="text-align: center; color: #ef4444; padding: 20px;">åŠ è½½å†å²è®°å½•å¤±è´¥</div>';
            }
        }

        // è·å–ç±»å‹æ˜¾ç¤ºåç§°
        function getTypeDisplayName(type) {
            const typeMap = {
                'single': 'å•æŠ½',
                'triple': 'ä¸‰è¿æŠ½',
                'quintuple': 'äº”è¿æŠ½',
                'batch': 'æ‰¹é‡æ›´æ–°',
                'reset': 'æ¢å¤é»˜è®¤'
            };
            return typeMap[type] || type;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeString) {
            const date = new Date(timeString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>

    <!-- é™æ—¶æ‰è½é…ç½®æ¨¡æ€æ¡† -->
    <div id="limitedDropModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001;">
            <div class="modal-header">
                <h2>é™æ—¶æ‰è½é…ç½®</h2>
                <span class="close" onclick="closeLimitedDropModal()">&times;</span>
            </div>
            
            <div class="form-group">
                <label>å½“å‰ç®¡ç†é¡µé¢:</label>
                <div id="currentPageDisplay" style="color: #ffd700; font-weight: bold; padding: 8px; background: rgba(255,215,0,0.1); border-radius: 5px;">
                    æ­£åœ¨æ£€æµ‹...
                </div>
                <small style="color: #666;">è‡ªåŠ¨ä»URLå‚æ•°æ£€æµ‹å½“å‰ç®¡ç†çš„é¡µé¢</small>
            </div>

            <div class="form-group">
                <label>å¯ç”¨çŠ¶æ€:</label>
                <label class="switch">
                    <input type="checkbox" id="limitedDropEnabled">
                    <span class="slider"></span>
                </label>
                <span id="enabledStatus" class="status-text">å…³é—­</span>
            </div>

            <div class="form-group">
                <label for="windowTitle">çª—å£æ ‡é¢˜:</label>
                <input type="text" id="windowTitle" value="é™æ—¶æ‰è½ï¼Œçˆ†ç‡æå‡" maxlength="100">
            </div>

            <div class="form-group">
                <label for="rateBoostFrom">åŸºç¡€çˆ†ç‡æ˜¾ç¤º (%):</label>
                <input type="number" id="rateBoostFrom" value="0.1" min="0.001" max="100" step="0.001" style="width: 120px;">
                <small style="color: #666;">æ˜¾ç¤ºçš„åŸå§‹çˆ†ç‡ (ä»…ç”¨äºå±•ç¤ºï¼Œä¸å½±å“å®é™…æ¦‚ç‡)</small>
            </div>

            <div class="form-group">
                <label for="rateBoostTo">æå‡åçˆ†ç‡æ˜¾ç¤º (%):</label>
                <input type="number" id="rateBoostTo" value="2.5" min="0.001" max="100" step="0.001" style="width: 120px;">
                <small style="color: #666;">æ˜¾ç¤ºçš„æå‡åçˆ†ç‡ (ä»…ç”¨äºå±•ç¤ºï¼Œä¸å½±å“å®é™…æ¦‚ç‡)</small>
            </div>

            <div class="form-group">
                <label>é€‰æ‹©ä¼ è¯´çº§å¥–å“:</label>
                <div id="legendaryPrizesList" class="prizes-selection">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-primary" onclick="saveLimitedDropConfig()">ä¿å­˜é…ç½®</button>
                <button type="button" class="btn-secondary" onclick="closeLimitedDropModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <style>
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-right: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #ffd700;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .status-text {
            color: #ffd700;
            font-weight: bold;
        }

        .prizes-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
        }

        .selectable-prize {
            background: rgba(20, 20, 40, 0.8);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .selectable-prize:hover {
            border-color: #ffd700;
            transform: translateY(-2px);
        }

        .selectable-prize.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .selectable-prize .prize-icon {
            font-size: 40px;
            display: block;
            margin-bottom: 8px;
        }

        .selectable-prize .prize-name {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .selectable-prize .prize-value {
            color: #fff;
            font-size: 12px;
        }

        .selectable-prize .prize-quantity {
            color: #aaa;
            font-size: 11px;
            margin-top: 3px;
        }
    </style>

    <script>
        let limitedDropConfig = null;
        let legendaryPrizes = [];
        let currentPage = 'luckytemp'; // å½“å‰é€‰æ‹©çš„é¡µé¢

        // ä»URLå‚æ•°è·å–å½“å‰ç®¡ç†çš„é¡µé¢åç§°
        function getCurrentPageFromUrl() {
            const pageParam = getQueryParam('page') || 'luckytemp.html';
            // æå–é¡µé¢åç§°ï¼Œå»æ‰.htmlåç¼€
            return pageParam.replace(/\.html$/, '');
        }

        // æ˜¾ç¤ºé™æ—¶æ‰è½é…ç½®æ¨¡æ€æ¡†
        async function showLimitedDropConfig() {
            try {
                // ä»URLå‚æ•°è·å–å½“å‰é¡µé¢
                currentPage = getCurrentPageFromUrl();
                console.log('å½“å‰ç®¡ç†é¡µé¢:', currentPage);
                
                // è·å–å½“å‰é…ç½®
                await loadLimitedDropConfig();
                // è·å–ä¼ è¯´çº§å¥–å“
                await loadLegendaryPrizes();
                
                document.getElementById('limitedDropModal').style.display = 'block';
            } catch (error) {
                console.error('æ‰“å¼€é™æ—¶æ‰è½é…ç½®å¤±è´¥:', error);
                alert('æ‰“å¼€é…ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åŠ è½½é™æ—¶æ‰è½é…ç½®
        async function loadLimitedDropConfig() {
            try {
                const response = await fetch(`../../server/api/limited-drop.php?action=get_config&page=${currentPage}`);
                const data = await response.json();
                
                if (data.success) {
                    limitedDropConfig = data.config;
                    
                    // æ›´æ–°ç•Œé¢
                    const enabledCheckbox = document.getElementById('limitedDropEnabled');
                    const statusText = document.getElementById('enabledStatus');
                    const windowTitleInput = document.getElementById('windowTitle');
                    const currentPageDisplay = document.getElementById('currentPageDisplay');
                    const rateBoostFromInput = document.getElementById('rateBoostFrom');
                    const rateBoostToInput = document.getElementById('rateBoostTo');
                    
                    enabledCheckbox.checked = limitedDropConfig.is_active == 1;
                    statusText.textContent = enabledCheckbox.checked ? 'å¼€å¯' : 'å…³é—­';
                    windowTitleInput.value = limitedDropConfig.window_title || 'é™æ—¶æ‰è½ï¼Œçˆ†ç‡æå‡';
                    currentPageDisplay.textContent = `${currentPage} é¡µé¢`;
                    rateBoostFromInput.value = limitedDropConfig.rate_boost_from || '0.1';
                    rateBoostToInput.value = limitedDropConfig.rate_boost_to || '2.5';
                    
                    // ç›‘å¬å¼€å…³å˜åŒ–
                    enabledCheckbox.onchange = function() {
                        statusText.textContent = this.checked ? 'å¼€å¯' : 'å…³é—­';
                    };
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                throw error;
            }
        }

        // åŠ è½½ä¼ è¯´çº§å¥–å“
        async function loadLegendaryPrizes() {
            try {
                const response = await fetch(`../../server/api/limited-drop.php?action=get_legendary_prizes&page=${currentPage}`);
                const data = await response.json();
                
                if (data.success) {
                    legendaryPrizes = data.prizes;
                    renderLegendaryPrizes();
                    
                    // æ˜¾ç¤ºè¡¨åä¿¡æ¯
                    const infoText = data.table_name ? `(ä½¿ç”¨è¡¨: ${data.table_name})` : '';
                    const currentPageDisplay = document.getElementById('currentPageDisplay');
                    if (currentPageDisplay) {
                        currentPageDisplay.innerHTML = `${currentPage} é¡µé¢ <small style="color: #aaa;">${infoText}</small>`;
                    }
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('åŠ è½½ä¼ è¯´çº§å¥–å“å¤±è´¥:', error);
                document.getElementById('legendaryPrizesList').innerHTML = '<div style="color: red;">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
                throw error;
            }
        }

        // æ¸²æŸ“ä¼ è¯´çº§å¥–å“é€‰æ‹©åˆ—è¡¨
        function renderLegendaryPrizes() {
            const container = document.getElementById('legendaryPrizesList');
            
            if (legendaryPrizes.length === 0) {
                container.innerHTML = '<div style="color: #aaa; text-align: center; padding: 20px;">æš‚æ— ä¼ è¯´çº§å¥–å“</div>';
                return;
            }
            
            const selectedIds = limitedDropConfig.selected_prize_ids || [];
            
            container.innerHTML = legendaryPrizes.map(prize => `
                <div class="selectable-prize ${selectedIds.includes(prize.id.toString()) ? 'selected' : ''}" 
                     onclick="togglePrizeSelection(${prize.id})">
                    <span class="prize-icon">${prize.icon || 'ğŸ'}</span>
                    <div class="prize-name">${prize.name}</div>
                    <div class="prize-value">ä»·å€¼: Â¥${prize.value}</div>
                    <div class="prize-quantity">å‰©ä½™: ${prize.quantity || 'âˆ'}</div>
                </div>
            `).join('');
        }

        // åˆ‡æ¢å¥–å“é€‰æ‹©çŠ¶æ€
        function togglePrizeSelection(prizeId) {
            const element = event.currentTarget;
            const selectedIds = limitedDropConfig.selected_prize_ids || [];
            const prizeIdStr = prizeId.toString();
            
            if (selectedIds.includes(prizeIdStr)) {
                // å–æ¶ˆé€‰æ‹©
                limitedDropConfig.selected_prize_ids = selectedIds.filter(id => id !== prizeIdStr);
                element.classList.remove('selected');
            } else {
                // é€‰æ‹©
                limitedDropConfig.selected_prize_ids = [...selectedIds, prizeIdStr];
                element.classList.add('selected');
            }
        }

        // ä¿å­˜é™æ—¶æ‰è½é…ç½®
        async function saveLimitedDropConfig() {
            try {
                const configData = {
                    page: currentPage, // æ·»åŠ é¡µé¢å‚æ•°
                    is_active: document.getElementById('limitedDropEnabled').checked ? 1 : 0,
                    window_title: document.getElementById('windowTitle').value || 'é™æ—¶æ‰è½ï¼Œçˆ†ç‡æå‡',
                    rate_boost_from: parseFloat(document.getElementById('rateBoostFrom').value) || 0.1,
                    rate_boost_to: parseFloat(document.getElementById('rateBoostTo').value) || 2.5,
                    selected_prize_ids: limitedDropConfig.selected_prize_ids || []
                };
                
                const response = await fetch('../../server/api/limited-drop.php?action=update_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`${currentPage} é¡µé¢é…ç½®ä¿å­˜æˆåŠŸï¼`);
                    closeLimitedDropModal();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // å…³é—­é™æ—¶æ‰è½é…ç½®æ¨¡æ€æ¡†
        function closeLimitedDropModal() {
            document.getElementById('limitedDropModal').style.display = 'none';
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeString) {
            const date = new Date(timeString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
