<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - å¤§çº¢è¡ŒåŠ¨</title>
    <script>
        // è¶…çº§ç®¡ç†å‘˜éªŒè¯ - æ¯æ¬¡è®¿é—®éƒ½éœ€è¦é‡æ–°è®¤è¯
        async function checkSuperAdminAccess() {
            // æ¸…é™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„æœ¬åœ°è®¤è¯çŠ¶æ€
            sessionStorage.removeItem('superAdminVerified');
            localStorage.removeItem('superAdminVerified');
            
            try {
                const response = await fetch('../../server/api/super-admin.php?action=check');
                const data = await response.json();
                
                if (!data.authenticated) {
                    alert('éœ€è¦è¶…çº§ç®¡ç†å‘˜æƒé™è®¿é—®æ­¤é¡µé¢ï¼è¯·é‡æ–°è¿›è¡Œèº«ä»½éªŒè¯ã€‚');
                    // å¼ºåˆ¶æ¸…é™¤æœåŠ¡å™¨ç«¯ä¼šè¯
                    await clearServerSession();
                    window.location.href = '../../super-admin.html';
                    return false;
                }
                
                // æ˜¾ç¤ºè¶…çº§ç®¡ç†å‘˜ä¿¡æ¯
                document.addEventListener('DOMContentLoaded', function() {
                    const headerP = document.querySelector('.admin-header p');
                    if (headerP) {
                        headerP.textContent = `æ¬¢è¿ï¼Œè¶…çº§ç®¡ç†å‘˜ï¼š${data.admin.username}`;
                    }
                });
                
                return true;
            } catch (error) {
                console.error('éªŒè¯å¤±è´¥:', error);
                alert('éªŒè¯ç³»ç»Ÿé”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•ï¼');
                await clearServerSession();
                window.location.href = '../../super-admin.html';
                return false;
            }
        }
        
        // æ¸…é™¤æœåŠ¡å™¨ç«¯ä¼šè¯
        async function clearServerSession() {
            try {
                await fetch('../../server/api/super-admin.php?action=logout', {
                    method: 'POST'
                });
            } catch (error) {
                console.error('æ¸…é™¤ä¼šè¯å¤±è´¥:', error);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶ç«‹å³éªŒè¯
        checkSuperAdminAccess();
        
        // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬ï¼Œå½“é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹æ—¶é‡æ–°éªŒè¯
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                checkSuperAdminAccess();
            }
        });
        
        // æ·»åŠ çª—å£ç„¦ç‚¹äº‹ä»¶ç›‘å¬
        window.addEventListener('focus', function() {
            checkSuperAdminAccess();
        });
        
        // é€€å‡ºç™»å½•å‡½æ•°
        async function logoutSuperAdmin() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿé€€å‡ºåéœ€è¦é‡æ–°è¿›è¡Œèº«ä»½éªŒè¯ã€‚')) {
                try {
                    await fetch('../../server/api/super-admin.php?action=logout', {
                        method: 'POST'
                    });
                    
                    // æ¸…é™¤æœ¬åœ°çŠ¶æ€
                    sessionStorage.clear();
                    localStorage.clear();
                    
                    alert('å·²å®‰å…¨é€€å‡ºï¼');
                    window.location.href = '../../super-admin.html';
                } catch (error) {
                    console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                    alert('é€€å‡ºç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0c0c0c, #1a1a1a);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .admin-header {
            text-align: center;
            margin-bottom: 50px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        .header-content {
            flex: 1;
        }

        .admin-header h1 {
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            font-size: 48px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .admin-header p {
            color: #ccc;
            font-size: 18px;
        }
        
        .logout-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 107, 107, 0.2);
            border: 2px solid #ff6b6b;
            color: #ff6b6b;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255, 107, 107, 0.3);
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.3);
        }

        .admin-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            max-width: 800px;
            width: 100%;
            padding: 0 20px;
        }

        .menu-card {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }

        .menu-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
            background: rgba(255, 215, 0, 0.1);
        }

        .menu-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #ffd700;
        }

        .menu-title {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 15px;
        }

        .menu-description {
            color: #ccc;
            font-size: 14px;
            line-height: 1.5;
        }

        .back-btn {
            position: fixed;
            top: 30px;
            left: 30px;
            padding: 12px 24px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        @media (max-width: 768px) {
            .admin-header h1 {
                font-size: 36px;
            }

            .admin-menu {
                grid-template-columns: 1fr;
                max-width: 400px;
            }

            .menu-card {
                padding: 30px 20px;
            }

            .menu-icon {
                font-size: 48px;
            }

            .menu-title {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <a href="../../index.html" class="back-btn">â† è¿”å›ä¸»é¡µ</a>

    <div class="admin-header">
        <div class="header-content">
            <h1 onclick="goToHome()">ç®¡ç†åå°</h1>
            <p>ç³»ç»Ÿç®¡ç†ä¸é…ç½®ä¸­å¿ƒ</p>
        </div>
        <button class="logout-btn" onclick="logoutSuperAdmin()">ğŸ”’ é€€å‡ºç™»å½•</button>
    </div>

    <div class="admin-menu">
        <div onclick="navigateToPage('users.html')" class="menu-card" style="cursor: pointer;">
            <div class="menu-icon">ğŸ‘¥</div>
            <div class="menu-title">ç”¨æˆ·ç®¡ç†</div>
            <div class="menu-description">
                ç®¡ç†ç”¨æˆ·è´¦æˆ·ã€æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯ã€ç¼–è¾‘ç”¨æˆ·èµ„æ–™å’Œæƒé™è®¾ç½®
            </div>
        </div>

        <div onclick="navigateToPage('draws.html')" class="menu-card" style="cursor: pointer;">
            <div class="menu-icon">ğŸ²</div>
            <div class="menu-title">æŠ½å¥–è®°å½•</div>
            <div class="menu-description">
                æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„æŠ½å¥–è®°å½•ã€ä½™é¢å˜åŠ¨å’Œè¯¦ç»†äº¤æ˜“ä¿¡æ¯
            </div>
        </div>

        <div class="menu-card" onclick="showPrizePageSelector()">
            <div class="menu-icon">ğŸ</div>
            <div class="menu-title">å¥–å“ç®¡ç†</div>
            <div class="menu-description">
                ç®¡ç†æ¸¸æˆå¥–å“ã€ä¿®æ”¹å¥–å“å›¾ç‰‡ã€è®¾ç½®ä¸­å¥–æ¦‚ç‡å’Œå¥–å“ä»·å€¼
            </div>
        </div>
    <!-- å¥–å“é¡µé¢é€‰æ‹©å¼¹çª— -->
    <div id="prizePageModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:2000;align-items:center;justify-content:center;">
        <div style="background:#222;padding:30px 40px;border-radius:20px;max-width:90vw;min-width:400px;box-shadow:0 0 30px #ffd700;">
            <h2 style="color:#ffd700;text-align:center;margin-bottom:20px;">å¥–å“ç®¡ç†</h2>
            
            <!-- é€‰é¡¹å¡ -->
            <div style="display:flex;gap:10px;justify-content:center;margin-bottom:20px;border-bottom:2px solid #ffd700;">
                <button onclick="switchPrizeTab('lucky')" id="luckyTabBtn" class="prize-tab-btn active" style="padding:12px 24px;background:rgba(255,215,0,0.1);color:#ffd700;border:none;border-bottom:3px solid #ffd700;cursor:pointer;font-size:16px;font-weight:bold;">Luckyé¡µé¢æ§åˆ¶</button>
                <button onclick="switchPrizeTab('shop')" id="shopTabBtn" class="prize-tab-btn" style="padding:12px 24px;background:transparent;color:#fff;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:16px;">å•†åŸå¥–å“ç®¡ç†</button>
                <button onclick="switchPrizeTab('icons')" id="iconsTabBtn" class="prize-tab-btn" style="padding:12px 24px;background:transparent;color:#fff;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:16px;">å›¾æ ‡æ›´æ”¹</button>
            </div>
            
            <!-- Luckyé¡µé¢æ§åˆ¶å†…å®¹ -->
            <div id="luckyTabContent" class="prize-tab-content">
                <div style="display:flex;gap:10px;justify-content:center;margin-bottom:20px;flex-wrap:wrap;">
                    <button onclick="showCreateLuckyModal()" style="padding:8px 16px;border-radius:15px;background:#4ade80;color:#000;font-weight:bold;border:none;cursor:pointer;">åˆ›å»ºæ–°Lucky</button>
                    <button onclick="showRenameLuckyModal()" style="padding:8px 16px;border-radius:15px;background:#f59e0b;color:#000;font-weight:bold;border:none;cursor:pointer;">é‡å‘½åLucky</button>
                    <button onclick="showThumbImageModal()" style="padding:8px 16px;border-radius:15px;background:#8b5cf6;color:#fff;font-weight:bold;border:none;cursor:pointer;">è®¾ç½®å°å›¾ç‰‡</button>
                    <button onclick="showDeleteLuckyModal()" style="padding:8px 16px;border-radius:15px;background:#ef4444;color:#fff;font-weight:bold;border:none;cursor:pointer;">åˆ é™¤Lucky</button>
                </div>
                <div id="luckyPageList" style="display:flex;flex-wrap:wrap;gap:20px;justify-content:center;"></div>
            </div>
            
            <!-- å•†åŸå¥–å“ç®¡ç†å†…å®¹ -->
            <div id="shopTabContent" class="prize-tab-content" style="display:none;">
                <div style="display:flex;gap:10px;justify-content:center;margin-bottom:20px;">
                    <button onclick="switchShopSubTab('skin')" id="skinSubTabBtn" class="shop-sub-tab-btn active" style="padding:10px 20px;border-radius:15px;background:#ffd700;color:#000;font-weight:bold;border:none;cursor:pointer;">ğŸ¨ çš®è‚¤å¥–å“</button>
                    <button onclick="switchShopSubTab('escort')" id="escortSubTabBtn" class="shop-sub-tab-btn" style="padding:10px 20px;border-radius:15px;background:#444;color:#fff;font-weight:bold;border:none;cursor:pointer;">ğŸ›¡ï¸ æŠ¤èˆªå¥–å“</button>
                    <button onclick="switchShopSubTab('orders')" id="ordersSubTabBtn" class="shop-sub-tab-btn" style="padding:10px 20px;border-radius:15px;background:#444;color:#fff;font-weight:bold;border:none;cursor:pointer;">ğŸ“¦ è´­ä¹°è®¢å•</button>
                </div>
                
                <!-- çš®è‚¤å¥–å“ -->
                <div id="skinSubContent" class="shop-sub-content">
                    <div style="text-align:right;margin-bottom:15px;">
                        <button onclick="showAddShopItemModal('skin')" style="padding:8px 16px;border-radius:15px;background:#4ade80;color:#000;font-weight:bold;border:none;cursor:pointer;">+ æ·»åŠ çš®è‚¤</button>
                    </div>
                    <div id="skinItemsList" style="max-height:400px;overflow-y:auto;"></div>
                </div>
                
                <!-- æŠ¤èˆªå¥–å“ -->
                <div id="escortSubContent" class="shop-sub-content" style="display:none;">
                    <div style="text-align:right;margin-bottom:15px;">
                        <button onclick="showAddShopItemModal('escort')" style="padding:8px 16px;border-radius:15px;background:#4ade80;color:#000;font-weight:bold;border:none;cursor:pointer;">+ æ·»åŠ æŠ¤èˆª</button>
                    </div>
                    <div id="escortItemsList" style="max-height:400px;overflow-y:auto;"></div>
                </div>
                
                <!-- è´­ä¹°è®¢å• -->
                <div id="ordersSubContent" class="shop-sub-content" style="display:none;">
                    <div style="margin-bottom:15px;">
                        <select id="orderStatusFilter" onchange="loadShopOrders()" style="padding:8px;border-radius:5px;background:#333;color:#fff;border:1px solid #ffd700;">
                            <option value="">å…¨éƒ¨è®¢å•</option>
                            <option value="pending">å¾…å¤„ç†</option>
                            <option value="processing">å¤„ç†ä¸­</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="cancelled">å·²å–æ¶ˆ</option>
                        </select>
                    </div>
                    <div id="ordersList" style="max-height:400px;overflow-y:auto;"></div>
                </div>
            </div>
            
            <!-- å›¾æ ‡æ›´æ”¹å†…å®¹ -->
            <div id="iconsTabContent" class="prize-tab-content" style="display:none;">
                <div style="background:rgba(255,215,0,0.05);padding:15px;border-radius:10px;margin-bottom:20px;">
                    <p style="color:#ffd700;margin-bottom:10px;">ğŸ’¡ è¯´æ˜ï¼š</p>
                    <p style="color:#ccc;font-size:14px;">åœ¨è¿™é‡Œå¯ä»¥æ›´æ”¹ä¸»é¡µå•†åº—åŒºåŸŸå››ä¸ªå¡ç‰‡çš„å›¾æ ‡å›¾ç‰‡ã€‚ä¿®æ”¹åä¼šç«‹å³åœ¨ä¸»é¡µæ˜¾ç¤ºã€‚</p>
                </div>
                
                <div id="shopIconsList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;">
                    <div style="color:#888;text-align:center;padding:40px;">åŠ è½½ä¸­...</div>
                </div>
            </div>
            
            <div style="text-align:center;margin-top:20px;">
                <button onclick="closePrizePageModal()" style="padding:10px 30px;border-radius:20px;background:#ffd700;color:#222;font-weight:bold;border:none;cursor:pointer;">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºLuckyé¡µé¢å¼¹çª— -->
    <div id="createLuckyModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:2100;align-items:center;justify-content:center;">
        <div style="background:#222;padding:30px;border-radius:20px;max-width:500px;width:90%;box-shadow:0 0 30px #4ade80;">
            <h2 style="color:#4ade80;text-align:center;margin-bottom:20px;">åˆ›å»ºæ–°Luckyé¡µé¢</h2>
            <form id="createLuckyForm">
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">æ–‡ä»¶å (luckyå¼€å¤´):</label>
                    <input type="text" id="luckyFileName" placeholder="ä¾‹å¦‚: lucky5" style="width:100%;padding:8px;border-radius:5px;border:1px solid #4ade80;background:#333;color:#fff;" required>
                    <small style="color:#ccc;">å°†è‡ªåŠ¨æ·»åŠ .htmlåç¼€</small>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">é¡µé¢æ˜¾ç¤ºåç§°:</label>
                    <input type="text" id="luckyDisplayName" placeholder="ä¾‹å¦‚: å¤§çº¢è¡ŒåŠ¨5" style="width:100%;padding:8px;border-radius:5px;border:1px solid #4ade80;background:#333;color:#fff;" required>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">ä¸­å¿ƒå±•ç¤ºå›¾ç‰‡:</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <input type="file" id="luckyImage" accept="image/*" style="width:60%;padding:8px;border-radius:5px;border:1px solid #4ade80;background:#333;color:#fff;">
                        <button type="button" onclick="previewImage('luckyImage', 'imagePreview')" style="padding:6px 12px;border-radius:5px;background:#ffd700;color:#000;border:none;cursor:pointer;font-size:12px;">é¢„è§ˆ</button>
                    </div>
                    <small style="color:#ccc;">æ­¤å›¾ç‰‡å°†æ˜¾ç¤ºåœ¨é¡µé¢ä¸­å¿ƒå¤§ç¤¼ç‰©ä½ç½®ï¼Œæ”¯æŒ PNGã€JPGã€GIFã€WebP æ ¼å¼</small>
                    <div id="imagePreview" style="margin-top:10px;text-align:center;"></div>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">æ¸¸æˆè¯´æ˜:</label>
                    <textarea id="luckyDescription" placeholder="è¾“å…¥æ¸¸æˆç©æ³•è¯´æ˜..." style="width:100%;padding:8px;border-radius:5px;border:1px solid #4ade80;background:#333;color:#fff;height:60px;resize:vertical;"></textarea>
                </div>
                <div style="text-align:center;gap:10px;display:flex;justify-content:center;">
                    <button type="submit" style="padding:10px 20px;border-radius:15px;background:#4ade80;color:#000;font-weight:bold;border:none;cursor:pointer;">åˆ›å»º</button>
                    <button type="button" onclick="closeCreateLuckyModal()" style="padding:10px 20px;border-radius:15px;background:#6b7280;color:#fff;font-weight:bold;border:none;cursor:pointer;">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- é‡å‘½åLuckyé¡µé¢å¼¹çª— -->
    <div id="renameLuckyModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:2100;align-items:center;justify-content:center;">
        <div style="background:#222;padding:30px;border-radius:20px;max-width:500px;width:90%;box-shadow:0 0 30px #f59e0b;">
            <h2 style="color:#f59e0b;text-align:center;margin-bottom:20px;">é‡å‘½åLuckyé¡µé¢</h2>
            <form id="renameLuckyForm">
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">é€‰æ‹©è¦é‡å‘½åçš„é¡µé¢:</label>
                    <select id="renameSelectPage" style="width:100%;padding:8px;border-radius:5px;border:1px solid #f59e0b;background:#333;color:#fff;" required>
                        <option value="">è¯·é€‰æ‹©é¡µé¢</option>
                    </select>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">æ–°æ–‡ä»¶å (luckyå¼€å¤´):</label>
                    <input type="text" id="newLuckyFileName" placeholder="ä¾‹å¦‚: lucky6" style="width:100%;padding:8px;border-radius:5px;border:1px solid #f59e0b;background:#333;color:#fff;" required>
                </div>
                <div style="margin-bottom:20px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">æ–°é¡µé¢æ˜¾ç¤ºåç§°:</label>
                    <input type="text" id="newLuckyDisplayName" placeholder="ä¾‹å¦‚: å¤§çº¢è¡ŒåŠ¨6" style="width:100%;padding:8px;border-radius:5px;border:1px solid #f59e0b;background:#333;color:#fff;" required>
                </div>
                <div style="text-align:center;gap:10px;display:flex;justify-content:center;">
                    <button type="submit" style="padding:10px 20px;border-radius:15px;background:#f59e0b;color:#000;font-weight:bold;border:none;cursor:pointer;">é‡å‘½å</button>
                    <button type="button" onclick="closeRenameLuckyModal()" style="padding:10px 20px;border-radius:15px;background:#6b7280;color:#fff;font-weight:bold;border:none;cursor:pointer;">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- åˆ é™¤Luckyé¡µé¢å¼¹çª— -->
    <div id="deleteLuckyModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:2100;align-items:center;justify-content:center;">
        <div style="background:#222;padding:30px;border-radius:20px;max-width:500px;width:90%;box-shadow:0 0 30px #ef4444;">
            <h2 style="color:#ef4444;text-align:center;margin-bottom:20px;">åˆ é™¤Luckyé¡µé¢</h2>
            <div style="margin-bottom:15px;">
                <label style="color:#fff;display:block;margin-bottom:5px;">é€‰æ‹©è¦åˆ é™¤çš„é¡µé¢:</label>
                <select id="deleteSelectPage" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ef4444;background:#333;color:#fff;" required>
                    <option value="">è¯·é€‰æ‹©é¡µé¢</option>
                </select>
            </div>
            <div style="color:#ef4444;margin-bottom:20px;text-align:center;">
                <strong>è­¦å‘Šï¼šåˆ é™¤æ“ä½œå°†åŒæ—¶åˆ é™¤é¡µé¢æ–‡ä»¶å’Œå¯¹åº”çš„å¥–å“æ•°æ®ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼</strong>
            </div>
            <div style="text-align:center;gap:10px;display:flex;justify-content:center;">
                <button onclick="confirmDeleteLucky()" style="padding:10px 20px;border-radius:15px;background:#ef4444;color:#fff;font-weight:bold;border:none;cursor:pointer;">ç¡®è®¤åˆ é™¤</button>
                <button onclick="closeDeleteLuckyModal()" style="padding:10px 20px;border-radius:15px;background:#6b7280;color:#fff;font-weight:bold;border:none;cursor:pointer;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Luckyé¡µé¢å°å›¾ç‰‡è®¾ç½®å¼¹çª— -->
    <div id="thumbImageModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:2100;align-items:center;justify-content:center;">
        <div style="background:#222;padding:30px;border-radius:20px;max-width:600px;width:90%;box-shadow:0 0 30px #8b5cf6;">
            <h2 style="color:#8b5cf6;text-align:center;margin-bottom:20px;">è®¾ç½®Luckyé¡µé¢å°å›¾ç‰‡</h2>
            <form id="thumbImageForm">
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">é€‰æ‹©Luckyé¡µé¢:</label>
                    <select id="thumbSelectPage" style="width:100%;padding:8px;border-radius:5px;border:1px solid #8b5cf6;background:#333;color:#fff;" required>
                        <option value="">è¯·é€‰æ‹©é¡µé¢</option>
                    </select>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">å½“å‰å°å›¾ç‰‡:</label>
                    <div id="currentThumbImage" style="text-align:center;padding:15px;border:1px dashed #8b5cf6;border-radius:8px;color:#ccc;">
                        æœªé€‰æ‹©é¡µé¢
                    </div>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">ä¸Šä¼ æ–°å°å›¾ç‰‡:</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <input type="file" id="thumbImageFile" accept="image/*" style="width:70%;padding:8px;border-radius:5px;border:1px solid #8b5cf6;background:#333;color:#fff;">
                        <button type="button" onclick="previewThumbImage()" style="padding:6px 12px;border-radius:5px;background:#ffd700;color:#000;border:none;cursor:pointer;font-size:12px;">é¢„è§ˆ</button>
                    </div>
                    <small style="color:#ccc;">å»ºè®®å°ºå¯¸ 120x120pxï¼Œæ”¯æŒ PNGã€JPGã€GIFã€WebP æ ¼å¼ï¼Œæœ€å¤§1MB</small>
                    <div id="thumbImagePreview" style="margin-top:10px;text-align:center;"></div>
                </div>
                <div style="text-align:center;gap:10px;display:flex;justify-content:center;">
                    <button type="submit" style="padding:10px 20px;border-radius:15px;background:#8b5cf6;color:#fff;font-weight:bold;border:none;cursor:pointer;">ä¸Šä¼ è®¾ç½®</button>
                    <button type="button" onclick="closeThumbImageModal()" style="padding:10px 20px;border-radius:15px;background:#6b7280;color:#fff;font-weight:bold;border:none;cursor:pointer;">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>


                <div onclick="navigateToPage('recharge.html')" class="menu-card" style="cursor: pointer;">
            <div class="menu-icon">ğŸ’°</div>
            <div class="menu-title">å……å€¼ä¿¡æ¯</div>
            <div class="menu-description">
                ç®¡ç†å……å€¼æ¯”ä¾‹è®¾ç½®ã€æŸ¥çœ‹ç”¨æˆ·å……å€¼è®°å½•å’Œé…ç½®æ”¯ä»˜æ–¹å¼
            </div>
        </div>

        <div onclick="navigateToPage('database.html')" class="menu-card" style="cursor: pointer;">
            <div class="menu-icon">ğŸ—„ï¸</div>
            <div class="menu-title">æ•°æ®åº“é…ç½®</div>
            <div class="menu-description">
                æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€ã€æ‰§è¡ŒSQLå‘½ä»¤å’Œç®¡ç†æ•°æ®è¡¨
            </div>
        </div>

        <div onclick="navigateToPage('config.html')" class="menu-card" style="cursor: pointer;">
            <div class="menu-icon">âš™ï¸</div>
            <div class="menu-title">ä¿¡æ¯è®¾ç½®</div>
            <div class="menu-description">
                ä¿¡æ¯è®¾ç½®å’Œç®¡ç†å‘˜å®‰æ’
            </div>
        </div>
    </div>

    <script>
        function goToHome() {
            window.location.href = '../../index.html';
        }

        // å¼¹çª—æ˜¾ç¤ºå¥–å“é¡µé¢é€‰æ‹©
        function showPrizePageSelector() {
            // è·å–luckyé¡µé¢åˆ—è¡¨
            fetchLuckyPages().then(function(pages) {
                const list = document.getElementById('luckyPageList');
                list.innerHTML = '';
                if (pages.length === 0) {
                    list.innerHTML = '<div style="color:#fff;">æœªæ£€æµ‹åˆ°luckyé¡µé¢</div>';
                } else {
                    pages.forEach(function(page) {
                        const btn = document.createElement('button');
                        btn.textContent = page.displayName || page.fileName;
                        btn.style = 'padding:12px 28px;margin:5px;border-radius:18px;background:#ffd700;color:#222;font-weight:bold;border:none;cursor:pointer;font-size:16px;';
                        btn.onclick = function() {
                            navigateToPage(`prizes.html?page=${encodeURIComponent(page.fileName)}`);
                        };
                        list.appendChild(btn);
                    });
                }
                document.getElementById('prizePageModal').style.display = 'flex';
            });
        }

        function closePrizePageModal() {
            document.getElementById('prizePageModal').style.display = 'none';
        }

        // æ˜¾ç¤ºåˆ›å»ºLuckyå¼¹çª—
        function showCreateLuckyModal() {
            document.getElementById('createLuckyModal').style.display = 'flex';
        }

        function closeCreateLuckyModal() {
            document.getElementById('createLuckyModal').style.display = 'none';
            document.getElementById('createLuckyForm').reset();
        }

        // æ˜¾ç¤ºé‡å‘½åLuckyå¼¹çª—
        function showRenameLuckyModal() {
            fetchLuckyPages().then(function(pages) {
                const select = document.getElementById('renameSelectPage');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©é¡µé¢</option>';
                pages.forEach(function(page) {
                    const option = document.createElement('option');
                    option.value = page.fileName;
                    option.textContent = `${page.fileName} (${page.displayName || 'æœªå‘½å'})`;
                    select.appendChild(option);
                });
                document.getElementById('renameLuckyModal').style.display = 'flex';
            });
        }

        function closeRenameLuckyModal() {
            document.getElementById('renameLuckyModal').style.display = 'none';
            document.getElementById('renameLuckyForm').reset();
        }

        // æ˜¾ç¤ºåˆ é™¤Luckyå¼¹çª—
        function showDeleteLuckyModal() {
            fetchLuckyPages().then(function(pages) {
                const select = document.getElementById('deleteSelectPage');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©é¡µé¢</option>';
                pages.forEach(function(page) {
                    const option = document.createElement('option');
                    option.value = page.fileName;
                    option.textContent = `${page.fileName} (${page.displayName || 'æœªå‘½å'})`;
                    select.appendChild(option);
                });
                document.getElementById('deleteLuckyModal').style.display = 'flex';
            });
        }

        function closeDeleteLuckyModal() {
            document.getElementById('deleteLuckyModal').style.display = 'none';
        }

        // æ£€æµ‹pagesç›®å½•ä¸‹çš„lucky*.htmlé¡µé¢
        async function fetchLuckyPages() {
            try {
                const response = await fetch('../../server/api/admin.php?action=list_lucky_pages');
                const data = await response.json();
                if (data.success) {
                    return data.pages;
                } else {
                    console.error('è·å–Luckyé¡µé¢åˆ—è¡¨å¤±è´¥:', data.error);
                    return [];
                }
            } catch (error) {
                console.error('ç½‘ç»œé”™è¯¯:', error);
                // fallbackåˆ°é™æ€åˆ—è¡¨
                return [
                    {fileName: "lucky1.html", displayName: "å¤§çº¢è¡ŒåŠ¨"},
                    {fileName: "lucky2.html", displayName: "å¤§çº¢è¡ŒåŠ¨2"},
                    {fileName: "lucky3.html", displayName: "å¤§çº¢è¡ŒåŠ¨3"},
                    {fileName: "lucky4.html", displayName: "å¤§çº¢è¡ŒåŠ¨4"}
                ];
            }
        }

        // å›¾ç‰‡é¢„è§ˆå‡½æ•°
        function previewImage(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="max-width:200px;max-height:150px;border-radius:10px;border:2px solid #ffd700;">`;
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.innerHTML = '';
            }
        }

        // åˆ›å»ºæ–°Luckyé¡µé¢
        document.getElementById('createLuckyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileName = document.getElementById('luckyFileName').value.trim();
            const displayName = document.getElementById('luckyDisplayName').value.trim();
            const description = document.getElementById('luckyDescription').value.trim();
            const imageFile = document.getElementById('luckyImage').files[0];
            
            // éªŒè¯æ–‡ä»¶å
            if (!fileName.startsWith('lucky')) {
                alert('æ–‡ä»¶åå¿…é¡»ä»¥"lucky"å¼€å¤´ï¼');
                return;
            }
            
            if (!/^lucky[a-zA-Z0-9_-]*$/.test(fileName)) {
                alert('æ–‡ä»¶ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦ï¼');
                return;
            }

            try {
                // å‡†å¤‡FormDataä»¥æ”¯æŒæ–‡ä»¶ä¸Šä¼ 
                const formData = new FormData();
                formData.append('fileName', fileName + '.html');
                formData.append('displayName', displayName);
                formData.append('description', description);
                if (imageFile) {
                    formData.append('gameImage', imageFile);
                }

                const response = await fetch('../../server/api/admin.php?action=create_lucky_page', {
                    method: 'POST',
                    body: formData  // ä¸è®¾ç½®Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®
                });

                const data = await response.json();
                if (data.success) {
                    alert('Luckyé¡µé¢åˆ›å»ºæˆåŠŸï¼');
                    closeCreateLuckyModal();
                    // åˆ·æ–°é¡µé¢åˆ—è¡¨
                    showPrizePageSelector();
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ›å»ºLuckyé¡µé¢å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        });

        // é‡å‘½åLuckyé¡µé¢
        document.getElementById('renameLuckyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const oldFileName = document.getElementById('renameSelectPage').value;
            const newFileName = document.getElementById('newLuckyFileName').value.trim();
            const newDisplayName = document.getElementById('newLuckyDisplayName').value.trim();
            
            if (!oldFileName) {
                alert('è¯·é€‰æ‹©è¦é‡å‘½åçš„é¡µé¢ï¼');
                return;
            }
            
            // éªŒè¯æ–°æ–‡ä»¶å
            if (!newFileName.startsWith('lucky')) {
                alert('æ–°æ–‡ä»¶åå¿…é¡»ä»¥"lucky"å¼€å¤´ï¼');
                return;
            }
            
            if (!/^lucky[a-zA-Z0-9_-]*$/.test(newFileName)) {
                alert('æ–°æ–‡ä»¶ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦ï¼');
                return;
            }

            try {
                const response = await fetch('../../server/api/admin.php?action=rename_lucky_page', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        oldFileName: oldFileName,
                        newFileName: newFileName + '.html',
                        newDisplayName: newDisplayName
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Luckyé¡µé¢é‡å‘½åæˆåŠŸï¼');
                    closeRenameLuckyModal();
                    // åˆ·æ–°é¡µé¢åˆ—è¡¨
                    showPrizePageSelector();
                } else {
                    alert('é‡å‘½åå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('é‡å‘½åLuckyé¡µé¢å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        });

        // ç¡®è®¤åˆ é™¤Luckyé¡µé¢
        async function confirmDeleteLucky() {
            const fileName = document.getElementById('deleteSelectPage').value;
            
            if (!fileName) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„é¡µé¢ï¼');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${fileName} å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤é¡µé¢æ–‡ä»¶å’Œæ‰€æœ‰ç›¸å…³æ•°æ®ï¼Œä¸”ä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch('../../server/api/admin.php?action=delete_lucky_page', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fileName: fileName
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Luckyé¡µé¢åˆ é™¤æˆåŠŸï¼');
                    closeDeleteLuckyModal();
                    // åˆ·æ–°é¡µé¢åˆ—è¡¨
                    showPrizePageSelector();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤Luckyé¡µé¢å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ˜¾ç¤ºLuckyé¡µé¢å°å›¾ç‰‡è®¾ç½®å¼¹çª—
        function showThumbImageModal() {
            fetchLuckyPages().then(function(pages) {
                const select = document.getElementById('thumbSelectPage');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©é¡µé¢</option>';
                pages.forEach(function(page) {
                    const option = document.createElement('option');
                    option.value = page.fileName;
                    option.textContent = page.displayName || page.fileName;
                    option.dataset.thumbImage = page.thumbImage || '';
                    select.appendChild(option);
                });
                document.getElementById('thumbImageModal').style.display = 'flex';
            });
        }

        function closeThumbImageModal() {
            document.getElementById('thumbImageModal').style.display = 'none';
            document.getElementById('thumbImageForm').reset();
            document.getElementById('currentThumbImage').innerHTML = 'æœªé€‰æ‹©é¡µé¢';
            document.getElementById('thumbImagePreview').innerHTML = '';
        }

        // é€‰æ‹©é¡µé¢æ—¶æ˜¾ç¤ºå½“å‰å°å›¾ç‰‡
        document.getElementById('thumbSelectPage').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const currentThumbDiv = document.getElementById('currentThumbImage');
            
            if (selectedOption.dataset.thumbImage) {
                currentThumbDiv.innerHTML = `<img src="../../${selectedOption.dataset.thumbImage}" style="max-width:120px;max-height:120px;border-radius:8px;" alt="å½“å‰å°å›¾ç‰‡">`;
            } else {
                currentThumbDiv.innerHTML = '<div style="color:#666;">è¯¥é¡µé¢æš‚æ— å°å›¾ç‰‡</div>';
            }
        });

        // é¢„è§ˆå°å›¾ç‰‡
        function previewThumbImage() {
            const fileInput = document.getElementById('thumbImageFile');
            const previewDiv = document.getElementById('thumbImagePreview');
            
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                if (file.size > 1024 * 1024) {
                    alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·æ§åˆ¶åœ¨1MBä»¥å†…');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewDiv.innerHTML = `
                        <div style="display:inline-block;text-align:center;margin-top:10px;">
                            <img src="${e.target.result}" style="max-width:120px;max-height:120px;border-radius:8px;border:2px solid #8b5cf6;" alt="é¢„è§ˆå›¾ç‰‡">
                            <div style="color:#8b5cf6;font-size:12px;margin-top:5px;">é¢„è§ˆå›¾ç‰‡</div>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                previewDiv.innerHTML = '';
            }
        }

        // æäº¤å°å›¾ç‰‡ä¸Šä¼ 
        document.getElementById('thumbImageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileName = document.getElementById('thumbSelectPage').value;
            const fileInput = document.getElementById('thumbImageFile');
            
            if (!fileName) {
                alert('è¯·é€‰æ‹©Luckyé¡µé¢ï¼');
                return;
            }
            
            if (!fileInput.files || !fileInput.files[0]) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡ï¼');
                return;
            }
            
            const formData = new FormData();
            formData.append('fileName', fileName);
            formData.append('thumbImage', fileInput.files[0]);
            
            try {
                const response = await fetch('../../server/api/admin.php?action=update_lucky_page_thumb', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('å°å›¾ç‰‡è®¾ç½®æˆåŠŸï¼');
                    closeThumbImageModal();
                    // åˆ·æ–°é¡µé¢åˆ—è¡¨
                    showPrizePageSelector();
                } else {
                    alert('è®¾ç½®å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('ä¸Šä¼ å°å›¾ç‰‡å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        });

        // ç®€åŒ–çš„å¯¼èˆªå‡½æ•° - ç›´æ¥è·³è½¬ï¼Œä¾èµ–sessionéªŒè¯
        function navigateToPage(pagePath) {
            // ç›´æ¥è·³è½¬åˆ°ç›®æ ‡é¡µé¢ï¼Œç›®æ ‡é¡µé¢ä¼šè‡ªåŠ¨éªŒè¯è¶…çº§ç®¡ç†å‘˜session
            window.location.href = pagePath;
        }
    </script>

    <!-- å•†åŸç‰©å“è¡¨å•æ¨¡æ€æ¡† -->
    <div id="shopItemModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:2200;align-items:center;justify-content:center;">
        <div style="background:#222;padding:30px;border-radius:20px;max-width:700px;width:90%;box-shadow:0 0 30px #ffd700;max-height:90vh;overflow-y:auto;">
            <h2 id="shopItemModalTitle" style="color:#ffd700;text-align:center;margin-bottom:20px;">æ·»åŠ å•†å“</h2>
            
            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div style="display:flex;gap:10px;justify-content:center;margin-bottom:20px;border-bottom:2px solid #ffd700;">
                <button onclick="switchShopItemTab('basic')" id="basicTabBtn" class="shop-item-tab-btn" style="padding:10px 20px;background:rgba(255,215,0,0.1);color:#ffd700;border:none;border-bottom:3px solid #ffd700;cursor:pointer;font-size:14px;font-weight:bold;">åŸºæœ¬ä¿¡æ¯</button>
                <button onclick="switchShopItemTab('legendary')" id="legendaryTabBtn" class="shop-item-tab-btn" style="padding:10px 20px;background:transparent;color:#fff;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:14px;">ä¼ è¯´çº§å…‘æ¢</button>
            </div>
            
            <!-- åŸºæœ¬ä¿¡æ¯æ ‡ç­¾é¡µ -->
            <div id="basicTabContent" class="shop-item-tab-content">
                <form id="shopItemForm">
                    <input type="hidden" id="shopItemId">
                    <input type="hidden" id="shopItemType">
                    
                    <div style="margin-bottom:15px;">
                        <label style="color:#fff;display:block;margin-bottom:5px;">ç‰©å“åç§°:</label>
                        <input type="text" id="shopItemName" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;" required>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="color:#fff;display:block;margin-bottom:5px;">ç‰©å“å›¾æ ‡ (Emoji):</label>
                        <input type="text" id="shopItemIcon" placeholder="ğŸ" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="color:#fff;display:block;margin-bottom:5px;">ç‰©å“å›¾ç‰‡URL:</label>
                        <input type="url" id="shopItemImageUrl" placeholder="https://example.com/image.jpg" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="color:#fff;display:block;margin-bottom:5px;">ç‰©å“æè¿°:</label>
                        <textarea id="shopItemDescription" rows="3" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;"></textarea>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="color:#fff;display:block;margin-bottom:5px;">ä»·æ ¼ï¼ˆé‡‘å¸ï¼‰:</label>
                        <input type="number" id="shopItemPrice" min="0" step="0.01" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;" required>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="color:#fff;display:block;margin-bottom:5px;">ç¨€æœ‰åº¦:</label>
                        <select id="shopItemRarity" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;" required>
                            <option value="common">æ™®é€š</option>
                            <option value="rare">ç¨€æœ‰</option>
                            <option value="epic">å²è¯—</option>
                            <option value="legendary">ä¼ è¯´</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="color:#fff;display:block;margin-bottom:5px;">åº“å­˜æ•°é‡:</label>
                        <input type="number" id="shopItemStock" value="-1" min="-1" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;">
                        <small style="color:#888;">-1 è¡¨ç¤ºæ— é™åº“å­˜</small>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="color:#fff;display:block;margin-bottom:5px;">æ’åºé¡ºåº:</label>
                        <input type="number" id="shopItemSortOrder" value="0" min="0" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="color:#fff;display:block;margin-bottom:5px;">çŠ¶æ€:</label>
                        <select id="shopItemActive" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;" required>
                            <option value="1">ä¸Šæ¶</option>
                            <option value="0">ä¸‹æ¶</option>
                        </select>
                    </div>
                    
                    <div style="display:flex;gap:10px;justify-content:center;">
                        <button type="submit" style="padding:10px 30px;border-radius:20px;background:#ffd700;color:#222;font-weight:bold;border:none;cursor:pointer;">ä¿å­˜</button>
                        <button type="button" onclick="closeShopItemModal()" style="padding:10px 30px;border-radius:20px;background:#666;color:#fff;font-weight:bold;border:none;cursor:pointer;">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
            
            <!-- ä¼ è¯´çº§å…‘æ¢æ ‡ç­¾é¡µ -->
            <div id="legendaryTabContent" class="shop-item-tab-content" style="display:none;">
                <div style="background:rgba(255,215,0,0.05);padding:15px;border-radius:10px;margin-bottom:20px;">
                    <p style="color:#ffd700;margin-bottom:10px;">ğŸ’¡ é…ç½®è¯´æ˜ï¼š</p>
                    <p style="color:#ccc;font-size:14px;">è®¾ç½®ç”¨æˆ·å¯ä»¥ä½¿ç”¨å“ªäº›ä¼ è¯´çº§ç‰©å“æ¥å…‘æ¢æ­¤å•†å“ã€‚ç”¨æˆ·éœ€è¦æ‹¥æœ‰æ‰€æœ‰æŒ‡å®šçš„ä¼ è¯´çº§ç‰©å“æ‰èƒ½å®Œæˆå…‘æ¢ã€‚</p>
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:10px;font-weight:bold;">é€‰æ‹©æ‰€éœ€ä¼ è¯´çº§ç‰©å“ï¼š</label>
                    <div id="legendaryItemsSelection" style="max-height:400px;overflow-y:auto;background:#333;border:1px solid #ffd700;border-radius:10px;padding:15px;">
                        <div style="color:#888;text-align:center;padding:20px;">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">å¯ç”¨ä¼ è¯´çº§å…‘æ¢:</label>
                    <select id="legendaryExchangeActive" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;">
                        <option value="1">å¯ç”¨</option>
                        <option value="0">ç¦ç”¨</option>
                    </select>
                </div>
                
                <div style="display:flex;gap:10px;justify-content:center;">
                    <button type="button" onclick="saveLegendaryExchangeConfig()" style="padding:10px 30px;border-radius:20px;background:#ffd700;color:#222;font-weight:bold;border:none;cursor:pointer;">ä¿å­˜é…ç½®</button>
                    <button type="button" onclick="closeShopItemModal()" style="padding:10px 30px;border-radius:20px;background:#666;color:#fff;font-weight:bold;border:none;cursor:pointer;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾æ ‡ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="iconEditModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:2300;align-items:center;justify-content:center;">
        <div style="background:#222;padding:30px;border-radius:20px;max-width:500px;width:90%;box-shadow:0 0 30px #ffd700;">
            <h2 id="iconEditModalTitle" style="color:#ffd700;text-align:center;margin-bottom:20px;">ç¼–è¾‘å›¾æ ‡</h2>
            
            <form id="iconEditForm">
                <input type="hidden" id="iconEditId">
                <input type="hidden" id="iconEditKey">
                
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">å›¾æ ‡åç§°:</label>
                    <input type="text" id="iconEditName" readonly style="width:100%;padding:8px;border-radius:5px;border:1px solid #666;background:#444;color:#aaa;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">å›¾æ ‡å›¾ç‰‡URL:</label>
                    <input type="url" id="iconEditUrl" placeholder="https://example.com/image.png" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;">
                    <small style="color:#888;">ç•™ç©ºåˆ™ä½¿ç”¨å¤‡ç”¨å›¾æ ‡ï¼ˆEmojiï¼‰</small>
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">å¤‡ç”¨å›¾æ ‡ (Emoji):</label>
                    <input type="text" id="iconEditFallback" placeholder="ğŸ" maxlength="5" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="color:#fff;display:block;margin-bottom:5px;">æè¿°:</label>
                    <textarea id="iconEditDescription" rows="2" style="width:100%;padding:8px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;"></textarea>
                </div>
                
                <div style="margin-bottom:20px;text-align:center;">
                    <div style="color:#888;margin-bottom:10px;">é¢„è§ˆ:</div>
                    <div id="iconPreview" style="background:#333;border:2px solid #ffd700;border-radius:10px;padding:20px;display:inline-block;">
                        <img id="iconPreviewImg" src="" alt="é¢„è§ˆ" style="max-width:150px;max-height:150px;display:none;" onerror="this.style.display='none'; document.getElementById('iconPreviewEmoji').style.display='block';">
                        <div id="iconPreviewEmoji" style="font-size:80px;">ğŸ</div>
                    </div>
                </div>
                
                <div style="display:flex;gap:10px;justify-content:center;">
                    <button type="submit" style="padding:10px 30px;border-radius:20px;background:#ffd700;color:#222;font-weight:bold;border:none;cursor:pointer;">ä¿å­˜</button>
                    <button type="button" onclick="closeIconEditModal()" style="padding:10px 30px;border-radius:20px;background:#666;color:#fff;font-weight:bold;border:none;cursor:pointer;">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentPrizeTab = 'lucky';
        let currentShopSubTab = 'skin';
        let editingShopItemId = null;

        // åˆ‡æ¢å¥–å“ç®¡ç†ä¸»é€‰é¡¹å¡
        function switchPrizeTab(tab) {
            currentPrizeTab = tab;
            
            document.querySelectorAll('.prize-tab-btn').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = '#fff';
                btn.style.borderBottom = '3px solid transparent';
            });
            
            document.querySelectorAll('.prize-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            if (tab === 'lucky') {
                document.getElementById('luckyTabBtn').style.background = 'rgba(255,215,0,0.1)';
                document.getElementById('luckyTabBtn').style.color = '#ffd700';
                document.getElementById('luckyTabBtn').style.borderBottom = '3px solid #ffd700';
                document.getElementById('luckyTabContent').style.display = 'block';
            } else if (tab === 'shop') {
                document.getElementById('shopTabBtn').style.background = 'rgba(255,215,0,0.1)';
                document.getElementById('shopTabBtn').style.color = '#ffd700';
                document.getElementById('shopTabBtn').style.borderBottom = '3px solid #ffd700';
                document.getElementById('shopTabContent').style.display = 'block';
                switchShopSubTab('skin');
            } else if (tab === 'icons') {
                document.getElementById('iconsTabBtn').style.background = 'rgba(255,215,0,0.1)';
                document.getElementById('iconsTabBtn').style.color = '#ffd700';
                document.getElementById('iconsTabBtn').style.borderBottom = '3px solid #ffd700';
                document.getElementById('iconsTabContent').style.display = 'block';
                loadShopIcons();
            }
        }

        // åˆ‡æ¢å•†åŸå­é€‰é¡¹å¡
        function switchShopSubTab(subTab) {
            currentShopSubTab = subTab;
            
            document.querySelectorAll('.shop-sub-tab-btn').forEach(btn => {
                btn.style.background = '#444';
                btn.style.color = '#fff';
            });
            
            document.querySelectorAll('.shop-sub-content').forEach(content => {
                content.style.display = 'none';
            });
            
            if (subTab === 'skin') {
                document.getElementById('skinSubTabBtn').style.background = '#ffd700';
                document.getElementById('skinSubTabBtn').style.color = '#000';
                document.getElementById('skinSubContent').style.display = 'block';
                loadShopItems('skin');
            } else if (subTab === 'escort') {
                document.getElementById('escortSubTabBtn').style.background = '#ffd700';
                document.getElementById('escortSubTabBtn').style.color = '#000';
                document.getElementById('escortSubContent').style.display = 'block';
                loadShopItems('escort');
            } else if (subTab === 'orders') {
                document.getElementById('ordersSubTabBtn').style.background = '#ffd700';
                document.getElementById('ordersSubTabBtn').style.color = '#000';
                document.getElementById('ordersSubContent').style.display = 'block';
                loadShopOrders();
            }
        }

        // åŠ è½½å•†åŸç‰©å“
        async function loadShopItems(type) {
            try {
                const response = await fetch('../../server/api/shop.php?action=admin_items');
                const data = await response.json();
                
                if (data.success) {
                    const items = data.items.filter(item => item.item_type === type);
                    renderShopItems(items, type);
                } else {
                    alert('åŠ è½½å•†å“å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åŠ è½½å•†å“å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // æ¸²æŸ“å•†åŸç‰©å“åˆ—è¡¨
        function renderShopItems(items, type) {
            const listId = type === 'skin' ? 'skinItemsList' : 'escortItemsList';
            const container = document.getElementById(listId);
            
            if (items.length === 0) {
                container.innerHTML = '<div style="color:#888;text-align:center;padding:20px;">æš‚æ— å•†å“</div>';
                return;
            }

            container.innerHTML = items.map(item => `
                <div style="background:#333;border:2px solid ${item.is_active ? '#ffd700' : '#666'};border-radius:10px;padding:15px;margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <div style="flex:1;">
                            <div style="color:#ffd700;font-size:18px;font-weight:bold;margin-bottom:5px;">
                                ${item.icon || 'ğŸ'} ${item.name}
                            </div>
                            <div style="color:#ccc;font-size:14px;margin-bottom:10px;">${item.description || ''}</div>
                            <div style="display:flex;gap:15px;flex-wrap:wrap;">
                                <span style="color:#fff;">ä»·æ ¼: <span style="color:#ffd700;">${parseFloat(item.price).toFixed(0)} é‡‘å¸</span></span>
                                <span style="color:#fff;">ç¨€æœ‰åº¦: ${getRarityText(item.rarity)}</span>
                                <span style="color:#fff;">åº“å­˜: ${item.stock === -1 ? 'æ— é™' : item.stock}</span>
                                <span style="color:#fff;">çŠ¶æ€: ${item.is_active ? 'âœ… ä¸Šæ¶' : 'âŒ ä¸‹æ¶'}</span>
                            </div>
                        </div>
                        <div style="display:flex;gap:5px;">
                            <button onclick="editShopItem(${item.id})" style="padding:6px 12px;border-radius:8px;background:#3b82f6;color:#fff;border:none;cursor:pointer;font-size:12px;">ç¼–è¾‘</button>
                            <button onclick="deleteShopItem(${item.id})" style="padding:6px 12px;border-radius:8px;background:#ef4444;color:#fff;border:none;cursor:pointer;font-size:12px;">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getRarityText(rarity) {
            const map = {
                'common': 'æ™®é€š',
                'rare': 'ç¨€æœ‰',
                'epic': 'å²è¯—',
                'legendary': 'ä¼ è¯´'
            };
            return map[rarity] || 'æ™®é€š';
        }

        // æ˜¾ç¤ºæ·»åŠ å•†å“æ¨¡æ€æ¡†
        function showAddShopItemModal(type) {
            editingShopItemId = null;
            selectedLegendaryItems = [];
            document.getElementById('shopItemModalTitle').textContent = `æ·»åŠ ${type === 'skin' ? 'çš®è‚¤' : 'æŠ¤èˆª'}`;
            document.getElementById('shopItemForm').reset();
            document.getElementById('shopItemId').value = '';
            document.getElementById('shopItemType').value = type;
            document.getElementById('legendaryExchangeActive').value = '0';
            document.getElementById('legendaryItemsSelection').dataset.loaded = '';
            
            // åˆ‡æ¢åˆ°åŸºæœ¬ä¿¡æ¯æ ‡ç­¾é¡µ
            switchShopItemTab('basic');
            
            document.getElementById('shopItemModal').style.display = 'flex';
        }

        // ç¼–è¾‘å•†å“
        async function editShopItem(id) {
            try {
                const response = await fetch('../../server/api/shop.php?action=admin_items');
                const data = await response.json();
                
                if (data.success) {
                    const item = data.items.find(i => i.id == id);
                    if (!item) {
                        alert('å•†å“ä¸å­˜åœ¨');
                        return;
                    }
                    
                    editingShopItemId = id;
                    document.getElementById('shopItemModalTitle').textContent = 'ç¼–è¾‘å•†å“';
                    document.getElementById('shopItemId').value = item.id;
                    document.getElementById('shopItemType').value = item.item_type;
                    document.getElementById('shopItemName').value = item.name;
                    document.getElementById('shopItemIcon').value = item.icon || '';
                    document.getElementById('shopItemImageUrl').value = item.image_url || '';
                    document.getElementById('shopItemDescription').value = item.description || '';
                    document.getElementById('shopItemPrice').value = item.price;
                    document.getElementById('shopItemRarity').value = item.rarity;
                    document.getElementById('shopItemStock').value = item.stock;
                    document.getElementById('shopItemSortOrder').value = item.sort_order;
                    document.getElementById('shopItemActive').value = item.is_active;
                    
                    // åˆ‡æ¢åˆ°åŸºæœ¬ä¿¡æ¯æ ‡ç­¾é¡µ
                    switchShopItemTab('basic');
                    
                    // åŠ è½½ä¼ è¯´çº§å…‘æ¢é…ç½®
                    loadLegendaryExchangeConfig(id);
                    
                    document.getElementById('shopItemModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('åŠ è½½å•†å“ä¿¡æ¯å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥');
            }
        }

        // åˆ‡æ¢å•†å“ç¼–è¾‘æ ‡ç­¾é¡µ
        function switchShopItemTab(tab) {
            document.querySelectorAll('.shop-item-tab-btn').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = '#fff';
                btn.style.borderBottom = '3px solid transparent';
            });
            
            document.querySelectorAll('.shop-item-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            if (tab === 'basic') {
                document.getElementById('basicTabBtn').style.background = 'rgba(255,215,0,0.1)';
                document.getElementById('basicTabBtn').style.color = '#ffd700';
                document.getElementById('basicTabBtn').style.borderBottom = '3px solid #ffd700';
                document.getElementById('basicTabContent').style.display = 'block';
            } else if (tab === 'legendary') {
                document.getElementById('legendaryTabBtn').style.background = 'rgba(255,215,0,0.1)';
                document.getElementById('legendaryTabBtn').style.color = '#ffd700';
                document.getElementById('legendaryTabBtn').style.borderBottom = '3px solid #ffd700';
                document.getElementById('legendaryTabContent').style.display = 'block';
                
                // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½ä¼ è¯´çº§ç‰©å“ï¼Œç°åœ¨åŠ è½½
                if (!document.getElementById('legendaryItemsSelection').dataset.loaded) {
                    loadLegendaryItemsForSelection();
                }
            }
        }

        // åŠ è½½ä¼ è¯´çº§ç‰©å“ä¾›é€‰æ‹©
        let allLegendaryPrizes = [];
        let selectedLegendaryItems = [];

        async function loadLegendaryItemsForSelection() {
            try {
                const response = await fetch('../../server/api/admin.php?action=prizes');
                const data = await response.json();
                
                if (data.success) {
                    allLegendaryPrizes = data.prizes.filter(p => p.rarity === 'legendary');
                    renderLegendaryItemsSelection();
                    document.getElementById('legendaryItemsSelection').dataset.loaded = 'true';
                } else {
                    document.getElementById('legendaryItemsSelection').innerHTML = '<div style="color:#ef4444;text-align:center;padding:20px;">åŠ è½½å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ä¼ è¯´çº§ç‰©å“å¤±è´¥:', error);
                document.getElementById('legendaryItemsSelection').innerHTML = '<div style="color:#ef4444;text-align:center;padding:20px;">ç½‘ç»œé”™è¯¯</div>';
            }
        }

        function renderLegendaryItemsSelection() {
            const container = document.getElementById('legendaryItemsSelection');
            
            if (allLegendaryPrizes.length === 0) {
                container.innerHTML = '<div style="color:#888;text-align:center;padding:20px;">æš‚æ— ä¼ è¯´çº§ç‰©å“</div>';
                return;
            }

            container.innerHTML = allLegendaryPrizes.map(prize => {
                const selected = selectedLegendaryItems.find(item => item.prize_id == prize.id);
                const quantity = selected ? selected.quantity : 1;
                
                return `
                    <div style="background:${selected ? 'rgba(255,215,0,0.1)' : '#444'};border:2px solid ${selected ? '#ffd700' : '#666'};border-radius:10px;padding:12px;margin-bottom:10px;display:flex;align-items:center;gap:15px;">
                        <input type="checkbox" 
                               id="legendary_${prize.id}" 
                               ${selected ? 'checked' : ''} 
                               onchange="toggleLegendaryItem(${prize.id})"
                               style="width:20px;height:20px;cursor:pointer;">
                        <div style="flex:1;">
                            <div style="color:#ffd700;font-weight:bold;margin-bottom:5px;">
                                ${prize.icon || 'ğŸ‘‘'} ${prize.name}
                            </div>
                            <div style="color:#ccc;font-size:12px;">ä»·å€¼: ${parseFloat(prize.value).toFixed(0)} | å‰©ä½™: ${prize.quantity || 'âˆ'}</div>
                        </div>
                        <div style="display:${selected ? 'flex' : 'none'};align-items:center;gap:5px;" id="quantity_control_${prize.id}">
                            <label style="color:#fff;font-size:12px;">æ•°é‡:</label>
                            <input type="number" 
                                   id="quantity_${prize.id}" 
                                   value="${quantity}" 
                                   min="1" 
                                   max="10"
                                   onchange="updateLegendaryItemQuantity(${prize.id}, this.value)"
                                   style="width:60px;padding:5px;border-radius:5px;border:1px solid #ffd700;background:#333;color:#fff;text-align:center;">
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleLegendaryItem(prizeId) {
            const checkbox = document.getElementById(`legendary_${prizeId}`);
            const quantityControl = document.getElementById(`quantity_control_${prizeId}`);
            
            if (checkbox.checked) {
                const prize = allLegendaryPrizes.find(p => p.id == prizeId);
                selectedLegendaryItems.push({
                    prize_id: prizeId,
                    name: prize.name,
                    quantity: 1
                });
                quantityControl.style.display = 'flex';
            } else {
                selectedLegendaryItems = selectedLegendaryItems.filter(item => item.prize_id != prizeId);
                quantityControl.style.display = 'none';
            }
            
            renderLegendaryItemsSelection();
        }

        function updateLegendaryItemQuantity(prizeId, quantity) {
            const item = selectedLegendaryItems.find(item => item.prize_id == prizeId);
            if (item) {
                item.quantity = parseInt(quantity) || 1;
            }
        }

        // åŠ è½½ä¼ è¯´çº§å…‘æ¢é…ç½®
        async function loadLegendaryExchangeConfig(shopItemId) {
            try {
                const response = await fetch(`../../server/api/shop.php?action=legendary_exchange_config&shop_item_id=${shopItemId}`);
                const data = await response.json();
                
                if (data.success && data.config) {
                    const config = data.config;
                    selectedLegendaryItems = config.required_items || [];
                    document.getElementById('legendaryExchangeActive').value = config.is_active;
                    
                    // å¦‚æœä¼ è¯´çº§ç‰©å“å·²åŠ è½½ï¼Œé‡æ–°æ¸²æŸ“
                    if (document.getElementById('legendaryItemsSelection').dataset.loaded) {
                        renderLegendaryItemsSelection();
                    }
                } else {
                    // æ²¡æœ‰é…ç½®ï¼Œé‡ç½®ä¸ºç©º
                    selectedLegendaryItems = [];
                    document.getElementById('legendaryExchangeActive').value = '0';
                }
            } catch (error) {
                console.error('åŠ è½½ä¼ è¯´çº§å…‘æ¢é…ç½®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜ä¼ è¯´çº§å…‘æ¢é…ç½®
        async function saveLegendaryExchangeConfig() {
            const shopItemId = document.getElementById('shopItemId').value;
            
            if (!shopItemId) {
                alert('è¯·å…ˆä¿å­˜å•†å“åŸºæœ¬ä¿¡æ¯');
                return;
            }
            
            if (selectedLegendaryItems.length === 0) {
                if (!confirm('æœªé€‰æ‹©ä»»ä½•ä¼ è¯´çº§ç‰©å“ï¼Œè¿™å°†ç¦ç”¨æ­¤å•†å“çš„ä¼ è¯´çº§å…‘æ¢åŠŸèƒ½ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                    return;
                }
            }
            
            try {
                const response = await fetch('../../server/api/shop.php?action=save_legendary_exchange_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        shop_item_id: shopItemId,
                        required_items: selectedLegendaryItems,
                        is_active: parseInt(document.getElementById('legendaryExchangeActive').value),
                        sort_order: 0
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('ä¼ è¯´çº§å…‘æ¢é…ç½®ä¿å­˜æˆåŠŸï¼');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜ä¼ è¯´çº§å…‘æ¢é…ç½®å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // å…³é—­å•†å“æ¨¡æ€æ¡†
        function closeShopItemModal() {
            document.getElementById('shopItemModal').style.display = 'none';
        }

        // ä¿å­˜å•†å“
        document.getElementById('shopItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                id: document.getElementById('shopItemId').value,
                name: document.getElementById('shopItemName').value,
                icon: document.getElementById('shopItemIcon').value,
                image_url: document.getElementById('shopItemImageUrl').value,
                description: document.getElementById('shopItemDescription').value,
                price: parseFloat(document.getElementById('shopItemPrice').value),
                item_type: document.getElementById('shopItemType').value,
                rarity: document.getElementById('shopItemRarity').value,
                stock: parseInt(document.getElementById('shopItemStock').value),
                sort_order: parseInt(document.getElementById('shopItemSortOrder').value),
                is_active: parseInt(document.getElementById('shopItemActive').value)
            };
            
            try {
                const action = editingShopItemId ? 'update_item' : 'add_item';
                const response = await fetch(`../../server/api/shop.php?action=${action}`, {
                    method: editingShopItemId ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(editingShopItemId ? 'å•†å“æ›´æ–°æˆåŠŸ' : 'å•†å“æ·»åŠ æˆåŠŸ');
                    closeShopItemModal();
                    loadShopItems(formData.item_type);
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜å•†å“å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯');
            }
        });

        // åˆ é™¤å•†å“
        async function deleteShopItem(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`../../server/api/shop.php?action=delete_item&id=${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('å•†å“å·²åˆ é™¤');
                    loadShopItems(currentShopSubTab);
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤å•†å“å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // åŠ è½½è´­ä¹°è®¢å•
        async function loadShopOrders() {
            try {
                const status = document.getElementById('orderStatusFilter').value;
                const url = status ? 
                    `../../server/api/shop.php?action=admin_purchases&status=${status}` :
                    `../../server/api/shop.php?action=admin_purchases`;
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    renderOrders(data.purchases);
                } else {
                    alert('åŠ è½½è®¢å•å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // æ¸²æŸ“è®¢å•åˆ—è¡¨
        function renderOrders(orders) {
            const container = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                container.innerHTML = '<div style="color:#888;text-align:center;padding:20px;">æš‚æ— è®¢å•</div>';
                return;
            }

            container.innerHTML = orders.map(order => {
                const statusColors = {
                    'pending': '#f59e0b',
                    'processing': '#3b82f6',
                    'completed': '#10b981',
                    'cancelled': '#ef4444'
                };
                const statusTexts = {
                    'pending': 'å¾…å¤„ç†',
                    'processing': 'å¤„ç†ä¸­',
                    'completed': 'å·²å®Œæˆ',
                    'cancelled': 'å·²å–æ¶ˆ'
                };
                
                return `
                    <div style="background:#333;border:2px solid ${statusColors[order.status]};border-radius:10px;padding:15px;margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">
                            <div>
                                <span style="color:#ffd700;font-weight:bold;">è®¢å• #${order.id}</span>
                                <span style="color:#888;margin-left:10px;">${order.username} (${order.nickname})</span>
                            </div>
                            <span style="padding:4px 12px;border-radius:12px;background:${statusColors[order.status]};color:#fff;font-size:12px;font-weight:bold;">
                                ${statusTexts[order.status]}
                            </span>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:10px;">
                            <div><span style="color:#888;">å•†å“:</span> <span style="color:#fff;">${order.item_name}</span></div>
                            <div><span style="color:#888;">ç±»å‹:</span> <span style="color:#fff;">${order.item_type === 'skin' ? 'çš®è‚¤' : 'æŠ¤èˆª'}</span></div>
                            <div><span style="color:#888;">ä»·æ ¼:</span> <span style="color:#ffd700;">${parseFloat(order.price).toFixed(0)} é‡‘å¸</span></div>
                            <div><span style="color:#888;">ç©å®¶ID:</span> <span style="color:#fff;">${order.player_id}</span></div>
                            <div><span style="color:#888;">è´­ä¹°æ—¶é—´:</span> <span style="color:#fff;">${order.created_at}</span></div>
                            ${order.processed_at ? `<div><span style="color:#888;">å¤„ç†æ—¶é—´:</span> <span style="color:#fff;">${order.processed_at}</span></div>` : ''}
                        </div>
                        ${order.notes ? `<div style="color:#ccc;font-size:12px;margin-bottom:10px;">å¤‡æ³¨: ${order.notes}</div>` : ''}
                        ${order.status === 'pending' || order.status === 'processing' ? `
                            <div style="display:flex;gap:10px;justify-content:flex-end;">
                                <button onclick="processOrder(${order.id}, 'complete')" style="padding:6px 12px;border-radius:8px;background:#10b981;color:#fff;border:none;cursor:pointer;font-size:12px;">å®Œæˆè®¢å•</button>
                                <button onclick="processOrder(${order.id}, 'cancel')" style="padding:6px 12px;border-radius:8px;background:#ef4444;color:#fff;border:none;cursor:pointer;font-size:12px;">å–æ¶ˆè®¢å•</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // å¤„ç†è®¢å•
        async function processOrder(orderId, action) {
            const notes = action === 'cancel' ? 
                prompt('è¯·è¾“å…¥å–æ¶ˆåŸå› ï¼ˆå¯é€‰ï¼‰:') : 
                prompt('è¯·è¾“å…¥å¤„ç†å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰:');
            
            if (action === 'cancel' && notes === null) {
                return;
            }
            
            try {
                const response = await fetch(`../../server/api/shop.php?action=process_purchase`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        purchase_id: orderId,
                        action: action,
                        notes: notes || ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    loadShopOrders();
                } else {
                    alert('å¤„ç†å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('å¤„ç†è®¢å•å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // ========== å›¾æ ‡ç®¡ç†åŠŸèƒ½ ==========
        
        // åŠ è½½å•†åº—å›¾æ ‡åˆ—è¡¨
        async function loadShopIcons() {
            try {
                const response = await fetch('../../server/api/admin.php?action=get_shop_icons', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    renderShopIcons(data.icons);
                } else {
                    document.getElementById('shopIconsList').innerHTML = '<div style="color:#ef4444;text-align:center;padding:40px;">åŠ è½½å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('åŠ è½½å›¾æ ‡å¤±è´¥:', error);
                document.getElementById('shopIconsList').innerHTML = '<div style="color:#ef4444;text-align:center;padding:40px;">ç½‘ç»œé”™è¯¯</div>';
            }
        }

        // æ¸²æŸ“å›¾æ ‡åˆ—è¡¨
        function renderShopIcons(icons) {
            const container = document.getElementById('shopIconsList');
            
            if (icons.length === 0) {
                container.innerHTML = '<div style="color:#888;text-align:center;padding:40px;">æš‚æ— å›¾æ ‡é…ç½®</div>';
                return;
            }

            container.innerHTML = icons.map(icon => `
                <div style="background:#333;border:2px solid #ffd700;border-radius:15px;padding:20px;text-align:center;">
                    <div style="margin-bottom:15px;">
                        ${icon.icon_url ? 
                            `<img src="${icon.icon_url}" alt="${icon.icon_name}" style="max-width:150px;max-height:150px;border-radius:10px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                             <div style="font-size:80px;display:none;">${icon.fallback_icon}</div>` :
                            `<div style="font-size:80px;">${icon.fallback_icon}</div>`
                        }
                    </div>
                    <h3 style="color:#ffd700;margin-bottom:10px;">${icon.icon_name}</h3>
                    <p style="color:#ccc;font-size:14px;margin-bottom:15px;">${icon.description || ''}</p>
                    <button onclick="editShopIcon(${icon.id})" style="padding:8px 20px;border-radius:15px;background:#3b82f6;color:#fff;font-weight:bold;border:none;cursor:pointer;">ç¼–è¾‘å›¾æ ‡</button>
                </div>
            `).join('');
        }

        // ç¼–è¾‘å›¾æ ‡
        async function editShopIcon(id) {
            try {
                const response = await fetch('../../server/api/admin.php?action=get_shop_icons', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    const icon = data.icons.find(i => i.id == id);
                    if (!icon) {
                        alert('å›¾æ ‡ä¸å­˜åœ¨');
                        return;
                    }
                    
                    document.getElementById('iconEditModalTitle').textContent = 'ç¼–è¾‘å›¾æ ‡ - ' + icon.icon_name;
                    document.getElementById('iconEditId').value = icon.id;
                    document.getElementById('iconEditKey').value = icon.icon_key;
                    document.getElementById('iconEditName').value = icon.icon_name;
                    document.getElementById('iconEditUrl').value = icon.icon_url || '';
                    document.getElementById('iconEditFallback').value = icon.fallback_icon || '';
                    document.getElementById('iconEditDescription').value = icon.description || '';
                    
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    document.getElementById('iconEditModal').style.display = 'flex';
                    
                    // å»¶è¿Ÿæ›´æ–°é¢„è§ˆï¼Œç¡®ä¿æ¨¡æ€æ¡†å·²æ˜¾ç¤º
                    setTimeout(updateIconPreview, 100);
                }
            } catch (error) {
                console.error('åŠ è½½å›¾æ ‡ä¿¡æ¯å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥');
            }
        }

        // æ›´æ–°å›¾æ ‡é¢„è§ˆ
        function updateIconPreview() {
            const url = document.getElementById('iconEditUrl').value.trim();
            const fallback = document.getElementById('iconEditFallback').value.trim();
            const previewImg = document.getElementById('iconPreviewImg');
            const previewEmoji = document.getElementById('iconPreviewEmoji');
            
            if (url) {
                previewImg.src = url;
                previewImg.style.display = 'block';
                previewEmoji.style.display = 'none';
                
                // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå¤‡ç”¨å›¾æ ‡
                previewImg.onerror = function() {
                    previewImg.style.display = 'none';
                    previewEmoji.style.display = 'block';
                    previewEmoji.textContent = fallback || 'ğŸ';
                };
            } else {
                previewImg.style.display = 'none';
                previewEmoji.style.display = 'block';
                previewEmoji.textContent = fallback || 'ğŸ';
            }
        }

        // åˆå§‹åŒ–è¾“å…¥ç›‘å¬
        function initIconEditListeners() {
            const urlInput = document.getElementById('iconEditUrl');
            const fallbackInput = document.getElementById('iconEditFallback');
            
            if (urlInput) {
                urlInput.addEventListener('input', updateIconPreview);
                urlInput.addEventListener('change', updateIconPreview);
            }
            if (fallbackInput) {
                fallbackInput.addEventListener('input', updateIconPreview);
                fallbackInput.addEventListener('change', updateIconPreview);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initIconEditListeners();
        });

        // å…³é—­å›¾æ ‡ç¼–è¾‘æ¨¡æ€æ¡†
        function closeIconEditModal() {
            document.getElementById('iconEditModal').style.display = 'none';
        }

        // ä¿å­˜å›¾æ ‡é…ç½®
        document.getElementById('iconEditForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                id: document.getElementById('iconEditId').value,
                icon_key: document.getElementById('iconEditKey').value,
                icon_url: document.getElementById('iconEditUrl').value,
                fallback_icon: document.getElementById('iconEditFallback').value,
                description: document.getElementById('iconEditDescription').value
            };
            
            try {
                const response = await fetch('../../server/api/admin.php?action=update_shop_icon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('å›¾æ ‡æ›´æ–°æˆåŠŸï¼');
                    closeIconEditModal();
                    loadShopIcons();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('ä¿å­˜å›¾æ ‡å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯');
            }
        });
    </script>
</body>
</html>
