<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿé…ç½® - å¤§çº¢è¡ŒåŠ¨</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/neon.css">
    <script>
        // è¶…çº§ç®¡ç†å‘˜æƒé™éªŒè¯
        async function checkAdminAccess() {
            try {
                // æ£€æŸ¥æ˜¯å¦é€šè¿‡adminé¡µé¢è®¿é—®ï¼ˆæœ‰tokenå‚æ•°ï¼‰
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                
                if (!token) {
                    alert('ç¦æ­¢ç›´æ¥è®¿é—®ï¼è¯·é€šè¿‡ç®¡ç†åå°è¿›å…¥ã€‚');
                    window.location.href = 'admin.html';
                    return false;
                }
                
                // éªŒè¯token
                const response = await fetch('../../server/api/super-admin.php?action=verify_token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token: token })
                });
                
                const data = await response.json();
                if (!data.success || !data.authenticated) {
                    alert('è®¿é—®æƒé™éªŒè¯å¤±è´¥ï¼è¯·é‡æ–°ç™»å½•ã€‚');
                    window.location.href = 'admin.html';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('æƒé™éªŒè¯å¤±è´¥:', error);
                alert('ç³»ç»Ÿé”™è¯¯ï¼Œè¯·é‡æ–°è®¿é—®ï¼');
                window.location.href = 'admin.html';
                return false;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶ç«‹å³éªŒè¯
        checkAdminAccess();
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #0f1419 0%, #1a1a2e 50%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
        }
        
        .admin-header {
            background: rgba(20, 30, 60, 0.9);
            padding: 20px;
            border-bottom: 2px solid #ffd700;
            box-shadow: 0 2px 20px rgba(255, 215, 0, 0.3);
            text-align: center;
        }
        
        .admin-title {
            font-size: 32px;
            background: linear-gradient(45deg, #ffd700, #ffff00);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            margin: 0;
        }
        
        .config-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .config-section {
            background: rgba(20, 30, 60, 0.8);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
        }
        
        .config-section::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ffd700, #00ffff, #ff00ff, #ffd700);
            border-radius: 17px;
            z-index: -1;
            animation: borderGlow 3s linear infinite;
        }
        
        @keyframes borderGlow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        .section-title {
            font-size: 24px;
            color: #ffd700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-icon {
            font-size: 28px;
        }
        
        .config-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .config-card {
            background: rgba(30, 40, 70, 0.8);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .config-card:hover {
            transform: translateY(-5px);
            border-color: #ffd700;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }
        
        .config-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .config-card:hover::before {
            left: 100%;
        }
        
        .card-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }
        
        .card-title {
            font-size: 20px;
            color: #ffd700;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .card-description {
            color: #ccc;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .card-button {
            background: linear-gradient(45deg, #ffd700, #ffaa00);
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .card-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }
        
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(0, 255, 255, 0.8);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .back-button:hover {
            background: rgba(0, 255, 255, 1);
            transform: translateY(-2px);
        }
        
        .status-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .status-indicator.inactive {
            background: #ff6b6b;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        
        .feature-list li {
            padding: 5px 0;
            color: #aaa;
            position: relative;
            padding-left: 20px;
        }
        
        .feature-list li::before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: #00ff00;
            font-weight: bold;
        }
        
        /* å®¢æœé…ç½®è¡¨å•æ ·å¼ */
        .service-config-form {
            display: none;
            background: rgba(30, 40, 70, 0.9);
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            border: 2px solid #00ffff;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: #00ffff;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
        }
        
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .btn-save, .btn-cancel {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-save {
            background: linear-gradient(45deg, #00ff00, #00aa00);
            color: #000;
        }
        
                .btn-cancel {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: #fff;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: rgba(20, 30, 60, 0.95);
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            border: 2px solid #ffd700;
            box-shadow: 0 20px 60px rgba(255, 215, 0, 0.3);
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(30, 40, 70, 0.8);
        }
        
        .modal-header h2 {
            color: #ffd700;
            margin: 0;
            font-size: 24px;
        }
        
        .modal-close {
            color: #ffd700;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .assignment-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(30, 40, 70, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .assignment-section h3 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .assignment-form {
            margin-top: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #fff;
            font-weight: bold;
        }
        
        .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            background: rgba(20, 30, 60, 0.9);
            color: #fff;
            font-size: 14px;
        }
        
        .form-select:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .form-select option {
            background: rgba(20, 30, 60, 0.9);
            color: #fff;
            padding: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #ffd700, #ffb347);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #ffb347, #ffd700);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }
        
        .assignment-stats {
            background: rgba(0, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            margin-bottom: 20px;
        }
        
        .assignment-stats h4 {
            color: #00ffff;
            margin-bottom: 10px;
        }
        
        .assignment-stats p {
            margin: 5px 0;
            color: #fff;
        }
        
        .assignment-details {
            background: rgba(255, 0, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 0, 255, 0.3);
        }
        
        .assignment-details h4 {
            color: #ff00ff;
            margin-bottom: 10px;
        }
        
        .assignment-table th {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            font-weight: bold;
        }
        
        .assignment-table td {
            color: #fff;
        }
        
        /* æœç´¢ç»“æœæ ·å¼ */
        .search-result-item {
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            border-left: 4px solid;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .search-result-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .search-result-item.assigned {
            border-left-color: #ffa500;
        }
        
        .search-result-item.unassigned {
            border-left-color: #00ff00;
        }
        
        .remove-assignment-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            padding: 2px 8px;
            font-size: 10px;
            background: #ff6b6b;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .remove-assignment-btn:hover {
            background: #ff5252;
            transform: translateY(-50%) scale(1.05);
        }        .assignment-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(30, 40, 70, 0.6);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .assignment-section h3 {
            color: #00ffff;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .assignment-form {
            margin-top: 15px;
        }
        
        .assignment-status {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #ccc;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #00ffff, #0099cc);
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
        }
        
        /* ä¸»é¢˜è®¾ç½®é¢„è§ˆåˆ—è¡¨æ ·å¼ */
        .preview-list {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .preview-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #ffd700;
        }
        
        .preview-item:last-child {
            margin-bottom: 0;
        }
        
        .preview-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 40px;
            text-align: center;
        }
        
        .preview-content {
            flex: 1;
        }
        
        .preview-content strong {
            color: #ffd700;
            display: block;
            margin-bottom: 4px;
        }
        
        .preview-content p {
            color: #ccc;
            font-size: 14px;
            margin: 0;
        }
        
        .form-help {
            display: block;
            margin-top: 5px;
            color: #999;
            font-size: 12px;
            font-style: italic;
        }
    </style>
        
        .btn-save:hover, .btn-cancel:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <a href="admin.html" class="back-button">â† è¿”å›ç®¡ç†ä¸­å¿ƒ</a>
    
    <div class="admin-header">
        <h1 class="admin-title">ç³»ç»Ÿé…ç½®ä¸­å¿ƒ</h1>
    </div>
    
    <div class="config-container">
        <!-- ç”¨æˆ·ç®¡ç†é…ç½® -->
        <div class="config-section">
            <h2 class="section-title">
                <span class="section-icon">ğŸ‘¥</span>
                ç”¨æˆ·ç®¡ç†é…ç½®
            </h2>
            <div class="config-options">
                <div class="config-card" onclick="goToUserManagement()">
                    <div class="status-indicator"></div>
                    <span class="card-icon">ğŸ”</span>
                    <h3 class="card-title">ç”¨æˆ·åˆ›å»ºä¸ç®¡ç†</h3>
                    <p class="card-description">
                        åˆ›å»ºå’Œç®¡ç†ä¸åŒç±»å‹çš„ç”¨æˆ·è´¦æˆ·ï¼ŒåŒ…æ‹¬æ™®é€šç”¨æˆ·ã€å®¢æœç”¨æˆ·ã€ç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜ã€‚
                    </p>
                    <ul class="feature-list">
                        <li>åˆ›å»ºè¶…çº§ç®¡ç†å‘˜ï¼ˆéœ€è¦èº«ä»½ç éªŒè¯ï¼‰</li>
                        <li>åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·</li>
                        <li>åˆ›å»ºå®¢æœç”¨æˆ·è´¦æˆ·</li>
                        <li>åˆ›å»ºæ™®é€šç”¨æˆ·è´¦æˆ·</li>
                        <li>ç”¨æˆ·æƒé™ç®¡ç†</li>
                    </ul>
                    <button class="card-button">è¿›å…¥ç”¨æˆ·ç®¡ç†</button>
                </div>
            </div>
        </div>
        
        <!-- å®¢æœç³»ç»Ÿé…ç½® -->
        <div class="config-section">
            <h2 class="section-title">
                <span class="section-icon">ğŸ’¬</span>
                å®¢æœç³»ç»Ÿé…ç½®
            </h2>
            <div class="config-options">
                <div class="config-card" onclick="showServiceAssignment()">
                    <div class="status-indicator" id="onlineServiceStatus"></div>
                    <span class="card-icon">ğŸ‘¥</span>
                    <h3 class="card-title">å®¢æœäººå‘˜åˆ†é…</h3>
                    <p class="card-description">
                        ç®¡ç†å®¢æœäººå‘˜åˆ†é…ï¼Œå°†æ™®é€šç”¨æˆ·åˆ†é…ç»™å®¢æœè´¦å·è¿›è¡Œç®¡ç†ã€‚
                    </p>
                    <button class="card-button" onclick="showServiceAssignment()">ç®¡ç†å®¢æœåˆ†é…</button>
                </div>
                
                <div class="config-card" onclick="toggleServiceConfig('qq')">
                    <div class="status-indicator" id="qqServiceStatus"></div>
                    <span class="card-icon">ğŸ§</span>
                    <h3 class="card-title">QQå®¢æœé…ç½®</h3>
                    <p class="card-description">
                        è®¾ç½®å®˜æ–¹QQå®¢æœå·ç å’ŒäºŒç»´ç ï¼Œæ–¹ä¾¿ç”¨æˆ·é€šè¿‡QQè”ç³»å®¢æœã€‚
                    </p>
                    <button class="card-button">é…ç½®QQå®¢æœ</button>
                </div>
                
                <div class="config-card" onclick="toggleServiceConfig('wechat')">
                    <div class="status-indicator" id="wechatServiceStatus"></div>
                    <span class="card-icon">ğŸ’¬</span>
                    <h3 class="card-title">å¾®ä¿¡å®¢æœé…ç½®</h3>
                    <p class="card-description">
                        è®¾ç½®å®˜æ–¹å¾®ä¿¡å®¢æœå·å’ŒäºŒç»´ç ï¼Œæ–¹ä¾¿ç”¨æˆ·é€šè¿‡å¾®ä¿¡è”ç³»å®¢æœã€‚
                    </p>
                    <button class="card-button">é…ç½®å¾®ä¿¡å®¢æœ</button>
                </div>
            </div>
            
            <!-- å®¢æœé…ç½®è¡¨å• -->
            <div id="serviceConfigForm" class="service-config-form">
                <h3 id="configFormTitle">é…ç½®å®¢æœä¿¡æ¯</h3>
                <form id="configForm">
                    <input type="hidden" id="serviceType" name="serviceType">
                    
                    <div class="form-group">
                        <label class="form-label" for="serviceTitle">å®¢æœæ ‡é¢˜</label>
                        <input type="text" id="serviceTitle" name="title" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="serviceContent">æè¿°å†…å®¹</label>
                        <textarea id="serviceContent" name="content" class="form-textarea" placeholder="è¯·è¾“å…¥å®¢æœæè¿°ä¿¡æ¯..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="contactInfo">è”ç³»æ–¹å¼</label>
                        <input type="text" id="contactInfo" name="contact_info" class="form-input" placeholder="QQå·/å¾®ä¿¡å·ç­‰">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="qrCodeUrl">äºŒç»´ç å›¾ç‰‡URL</label>
                        <input type="url" id="qrCodeUrl" name="qr_code_url" class="form-input" placeholder="http://example.com/qr.png">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="isEnabled">å¯ç”¨çŠ¶æ€</label>
                        <select id="isEnabled" name="is_enabled" class="form-select">
                            <option value="1">å¯ç”¨</option>
                            <option value="0">ç¦ç”¨</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="cancelConfig()">å–æ¶ˆ</button>
                        <button type="button" class="btn-save" onclick="saveServiceConfig()">ä¿å­˜é…ç½®</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- ç³»ç»Ÿæ‰©å±•é…ç½® -->
        <div class="config-section">
            <h2 class="section-title">
                <span class="section-icon">âš™ï¸</span>
                ç³»ç»Ÿæ‰©å±•é…ç½®
            </h2>
            <div class="config-options">
                <div class="config-card" onclick="showSecretKeyChange()">
                    <div class="status-indicator active"></div>
                    <span class="card-icon">ğŸ”</span>
                    <h3 class="card-title">è¶…çº§ç®¡ç†å‘˜èº«ä»½ç </h3>
                    <p class="card-description">
                        æ›´æ”¹è¶…çº§ç®¡ç†å‘˜èº«ä»½ç ï¼Œéœ€è¦è¾“å…¥å½“å‰èº«ä»½ç å’Œè´¦å·å¯†ç è¿›è¡ŒéªŒè¯ã€‚
                    </p>
                    <button class="card-button">æ›´æ”¹èº«ä»½ç </button>
                </div>
                
                <div class="config-card">
                    <div class="status-indicator active"></div>
                    <span class="card-icon">ğŸ¨</span>
                    <h3 class="card-title">ç½‘ç«™ä¸»é¢˜è®¾ç½®</h3>
                    <p class="card-description">
                        ä¿®æ”¹æ•´ä¸ªç½‘ç«™çš„ä¸»é¢˜åç§°ï¼Œæ›´æ”¹åå°†åº”ç”¨åˆ°æ‰€æœ‰é¡µé¢ã€‚
                    </p>
                    <ul class="feature-list">
                        <li>ç½‘ç«™æ ‡é¢˜ä¿®æ”¹</li>
                        <li>å“ç‰Œåç§°è®¾ç½®</li>
                        <li>é¡µé¢æ ‡é¢˜ç»Ÿä¸€æ›´æ–°</li>
                        <li>å¯¼èˆªæ å“ç‰Œåä¿®æ”¹</li>
                        <li>å…¨ç«™ä¸»é¢˜åç§°åŒæ­¥</li>
                    </ul>
                    <button class="card-button" onclick="openThemeSettingsModal()">é…ç½®ä¸»é¢˜è®¾ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å®¢æœåˆ†é…å¼¹çª— -->
    <div id="serviceAssignmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>å®¢æœäººå‘˜åˆ†é…ç®¡ç†</h2>
                <span class="modal-close" onclick="closeServiceAssignmentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="assignment-section">
                    <h3>è‡ªåŠ¨å¹³å‡åˆ†é…</h3>
                    <p>å°†æ‰€æœ‰æ™®é€šç”¨æˆ·å¹³å‡åˆ†é…ç»™ç°æœ‰å®¢æœäººå‘˜</p>
                    <button class="btn-primary" onclick="autoAssignUsers()">æ‰§è¡Œè‡ªåŠ¨åˆ†é…</button>
                </div>
                
                <div class="assignment-section">
                    <h3>æ‰‹åŠ¨åˆ†é…ç”¨æˆ·</h3>
                    <div class="assignment-form">
                        <div class="form-group">
                            <label>é€‰æ‹©å®¢æœäººå‘˜</label>
                            <select id="serviceUserSelect" class="form-select">
                                <option value="">åŠ è½½ä¸­...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é€‰æ‹©æ™®é€šç”¨æˆ·</label>
                            <div style="margin-bottom: 10px;">
                                <input type="text" id="userSearchInput" class="form-input" placeholder="æœç´¢ç”¨æˆ·åæˆ–æ˜µç§°..." style="margin-bottom: 5px;">
                                <button class="btn-primary" onclick="searchUser()" style="padding: 8px 16px; font-size: 12px;">æœç´¢ç”¨æˆ·</button>
                                <button class="btn-primary" onclick="clearSearch()" style="padding: 8px 16px; font-size: 12px; margin-left: 5px; background: linear-gradient(45deg, #6c757d, #495057);">æ¸…ç©ºæœç´¢</button>
                            </div>
                            <select id="regularUserSelect" class="form-select" multiple size="5">
                                <option value="">åŠ è½½ä¸­...</option>
                            </select>
                            <div id="searchResult" style="margin-top: 10px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 5px; display: none;"></div>
                        </div>
                        <button class="btn-primary" onclick="manualAssignUsers()">æ‰§è¡Œæ‰‹åŠ¨åˆ†é…</button>
                        <button class="btn-primary" onclick="removeSelectedAssignments()" style="background: linear-gradient(45deg, #ff6b6b, #ff8e8e); margin-left: 10px;">ç§»é™¤é€‰ä¸­åˆ†é…</button>
                    </div>
                </div>
                
                <div class="assignment-section">
                    <h3>å½“å‰åˆ†é…æƒ…å†µ</h3>
                    <button class="btn-primary" onclick="loadAssignmentStatus()" style="float: right; margin-top: -35px;">åˆ·æ–°æ•°æ®</button>
                    <div id="assignmentStatus" class="assignment-status">
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- èº«ä»½ç æ›´æ”¹å¼¹çª— -->
    <div id="secretKeyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ›´æ”¹è¶…çº§ç®¡ç†å‘˜èº«ä»½ç </h2>
                <span class="modal-close" onclick="closeSecretKeyModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="secretKeyForm">
                    <div class="form-group">
                        <label for="currentSecretKey">å½“å‰èº«ä»½ç </label>
                        <input type="password" id="currentSecretKey" class="form-input" required placeholder="è¯·è¾“å…¥å½“å‰èº«ä»½ç ">
                    </div>
                    <div class="form-group">
                        <label for="newSecretKey">æ–°èº«ä»½ç </label>
                        <input type="password" id="newSecretKey" class="form-input" required placeholder="è¯·è¾“å…¥æ–°èº«ä»½ç ">
                    </div>
                    <div class="form-group">
                        <label for="confirmSecretKey">ç¡®è®¤æ–°èº«ä»½ç </label>
                        <input type="password" id="confirmSecretKey" class="form-input" required placeholder="è¯·å†æ¬¡è¾“å…¥æ–°èº«ä»½ç ">
                    </div>
                    <div class="form-group">
                        <label for="adminPassword">è¶…çº§ç®¡ç†å‘˜å¯†ç </label>
                        <input type="password" id="adminPassword" class="form-input" required placeholder="è¯·è¾“å…¥è¶…çº§ç®¡ç†å‘˜è´¦å·å¯†ç ">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeSecretKeyModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn-save">æ›´æ”¹èº«ä»½ç </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ä¸»é¢˜è®¾ç½®å¼¹çª— -->
    <div id="themeSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç½‘ç«™ä¸»é¢˜è®¾ç½®</h2>
                <span class="modal-close" onclick="closeThemeSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="themeSettingsForm">
                    <div class="form-group">
                        <label for="currentThemeName">å½“å‰ä¸»é¢˜åç§°</label>
                        <input type="text" id="currentThemeName" class="form-input" readonly placeholder="åŠ è½½ä¸­...">
                        <small class="form-help">å½“å‰ç½‘ç«™ä½¿ç”¨çš„ä¸»é¢˜åç§°</small>
                    </div>
                    <div class="form-group">
                        <label for="newThemeName">æ–°ä¸»é¢˜åç§°</label>
                        <input type="text" id="newThemeName" class="form-input" required placeholder="è¯·è¾“å…¥æ–°çš„ä¸»é¢˜åç§°" maxlength="20">
                        <small class="form-help">å»ºè®®ä½¿ç”¨ç®€æ´æ˜“è®°çš„åç§°ï¼Œå¦‚"å¤§çº¢è¡ŒåŠ¨"ã€"å¹¸è¿å¤§æŠ½å¥–"ç­‰</small>
                    </div>
                    <div class="form-group">
                        <label>å½±å“èŒƒå›´é¢„è§ˆ</label>
                        <div class="preview-list">
                            <div class="preview-item">
                                <span class="preview-icon">ğŸ </span>
                                <div class="preview-content">
                                    <strong>ä¸»é¡µæ ‡é¢˜</strong>
                                    <p>ç½‘ç«™æ ‡é¢˜æ å’Œå¯¼èˆªæ å“ç‰Œåç§°</p>
                                </div>
                            </div>
                            <div class="preview-item">
                                <span class="preview-icon">ğŸ®</span>
                                <div class="preview-content">
                                    <strong>æ¸¸æˆé¡µé¢</strong>
                                    <p>æ‰€æœ‰Luckyé¡µé¢çš„é¡µé¢æ ‡é¢˜</p>
                                </div>
                            </div>
                            <div class="preview-item">
                                <span class="preview-icon">ğŸ‘¥</span>
                                <div class="preview-content">
                                    <strong>ç”¨æˆ·ä¸­å¿ƒ</strong>
                                    <p>ä¸ªäººä¸­å¿ƒã€ç™»å½•æ³¨å†Œé¡µé¢æ ‡é¢˜</p>
                                </div>
                            </div>
                            <div class="preview-item">
                                <span class="preview-icon">âš™ï¸</span>
                                <div class="preview-content">
                                    <strong>ç®¡ç†åå°</strong>
                                    <p>æ‰€æœ‰ç®¡ç†é¡µé¢çš„æ ‡é¢˜å’Œå“ç‰Œæ˜¾ç¤º</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="confirmThemeChange" required style="margin-right: 8px;">
                            æˆ‘ç¡®è®¤è¦ä¿®æ”¹æ‰€æœ‰é¡µé¢çš„ä¸»é¢˜åç§°ï¼Œå¹¶ç†è§£æ­¤æ“ä½œå°†å½±å“æ•´ä¸ªç½‘ç«™
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeThemeSettingsModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn-save">åº”ç”¨æ–°ä¸»é¢˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../../js/api-client.js"></script>
    <script>
        let serviceConfigs = {};
        
        // è¶…çº§ç®¡ç†å‘˜éªŒè¯ - ä¸admin.htmlä¿æŒä¸€è‡´
        async function checkSuperAdminAccess() {
            try {
                const response = await fetch('../../server/api/super-admin.php?action=check');
                const data = await response.json();
                
                if (!data.authenticated) {
                    alert('éœ€è¦è¶…çº§ç®¡ç†å‘˜æƒé™è®¿é—®æ­¤é¡µé¢ï¼è¯·é‡æ–°è¿›è¡Œèº«ä»½éªŒè¯ã€‚');
                    window.location.href = '../../super-admin.html';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('éªŒè¯å¤±è´¥:', error);
                alert('éªŒè¯ç³»ç»Ÿé”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•ï¼');
                window.location.href = '../../super-admin.html';
                return false;
            }
        }
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // å…ˆæ£€æŸ¥è¶…çº§ç®¡ç†å‘˜æƒé™
            const hasAccess = await checkSuperAdminAccess();
            if (hasAccess) {
                loadServiceConfigs();
            }
        });
        
        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™ - å·²å¼ƒç”¨ï¼Œæ”¹ä¸ºä½¿ç”¨checkSuperAdminAccess
        async function checkAdminPermission() {
            // è¿™ä¸ªå‡½æ•°å·²è¢«checkSuperAdminAccessæ›¿ä»£
            return await checkSuperAdminAccess();
        }
        
        // åŠ è½½å®¢æœé…ç½®
        async function loadServiceConfigs() {
            try {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨APIè·å–å®¢æœé…ç½®
                // æš‚æ—¶ä½¿ç”¨é»˜è®¤é…ç½®
                serviceConfigs = {
                    online: {
                        title: 'åœ¨çº¿å®¢æœ',
                        content: '24å°æ—¶åœ¨çº¿å®¢æœä¸ºæ‚¨æœåŠ¡',
                        contact_info: '',
                        qr_code_url: '',
                        is_enabled: 1
                    },
                    qq: {
                        title: 'QQå®¢æœ',
                        content: 'å®˜æ–¹QQå®¢æœ',
                        contact_info: '123456789',
                        qr_code_url: '',
                        is_enabled: 1
                    },
                    wechat: {
                        title: 'å¾®ä¿¡å®¢æœ',
                        content: 'å®˜æ–¹å¾®ä¿¡å®¢æœ',
                        contact_info: 'lucky_service',
                        qr_code_url: '',
                        is_enabled: 1
                    }
                };
                
                updateServiceStatus();
            } catch (error) {
                console.error('åŠ è½½å®¢æœé…ç½®å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°å®¢æœçŠ¶æ€æŒ‡ç¤ºå™¨
        function updateServiceStatus() {
            ['online', 'qq', 'wechat'].forEach(type => {
                const indicator = document.getElementById(type + 'ServiceStatus');
                const config = serviceConfigs[type];
                if (indicator) {
                    if (config && config.is_enabled) {
                        indicator.classList.remove('inactive');
                    } else {
                        indicator.classList.add('inactive');
                    }
                }
            });
        }
        
        // å‰å¾€ç”¨æˆ·ç®¡ç†é¡µé¢
        function goToUserManagement() {
            window.location.href = '../../create-super-admin.html';
        }
        
        // åˆ‡æ¢å®¢æœé…ç½®è¡¨å•
        function toggleServiceConfig(type) {
            const form = document.getElementById('serviceConfigForm');
            const title = document.getElementById('configFormTitle');
            
            // è®¾ç½®è¡¨å•æ ‡é¢˜
            const titles = {
                online: 'é…ç½®åœ¨çº¿å®¢æœ',
                qq: 'é…ç½®QQå®¢æœ',
                wechat: 'é…ç½®å¾®ä¿¡å®¢æœ'
            };
            title.textContent = titles[type];
            
            // å¡«å……è¡¨å•æ•°æ®
            const config = serviceConfigs[type] || {};
            document.getElementById('serviceType').value = type;
            document.getElementById('serviceTitle').value = config.title || '';
            document.getElementById('serviceContent').value = config.content || '';
            document.getElementById('contactInfo').value = config.contact_info || '';
            document.getElementById('qrCodeUrl').value = config.qr_code_url || '';
            document.getElementById('isEnabled').value = config.is_enabled || 1;
            
            // æ˜¾ç¤ºè¡¨å•
            form.style.display = 'block';
            form.scrollIntoView({ behavior: 'smooth' });
        }
        
        // å–æ¶ˆé…ç½®
        function cancelConfig() {
            document.getElementById('serviceConfigForm').style.display = 'none';
        }
        
        // ä¿å­˜å®¢æœé…ç½®
        async function saveServiceConfig() {
            try {
                const form = document.getElementById('configForm');
                const formData = new FormData(form);
                const serviceType = formData.get('serviceType');
                
                const config = {
                    service_type: serviceType,
                    title: formData.get('title'),
                    content: formData.get('content'),
                    contact_info: formData.get('contact_info'),
                    qr_code_url: formData.get('qr_code_url'),
                    is_enabled: parseInt(formData.get('is_enabled'))
                };
                
                // è¿™é‡Œåº”è¯¥è°ƒç”¨APIä¿å­˜é…ç½®
                console.log('ä¿å­˜å®¢æœé…ç½®:', config);
                
                // æ›´æ–°æœ¬åœ°é…ç½®
                serviceConfigs[serviceType] = config;
                updateServiceStatus();
                
                // éšè—è¡¨å•
                document.getElementById('serviceConfigForm').style.display = 'none';
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showMessage('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                showMessage('ä¿å­˜é…ç½®å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // å®¢æœåˆ†é…ç›¸å…³å‡½æ•°
        function showServiceAssignment() {
            document.getElementById('serviceAssignmentModal').classList.add('show');
            loadServiceUsers();
            loadRegularUsers();
            loadAssignmentStatus();
        }
        
        function closeServiceAssignmentModal() {
            document.getElementById('serviceAssignmentModal').classList.remove('show');
        }
        
        async function loadServiceUsers() {
            try {
                const response = await fetch('../../server/api/service-assignment.php?action=get_service_users');
                const data = await response.json();
                
                const select = document.getElementById('serviceUserSelect');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©å®¢æœäººå‘˜</option>';
                
                if (data.success && data.service_users) {
                    data.service_users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.nickname || user.username} (å·²åˆ†é…: ${user.assigned_count}äºº)`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½å®¢æœç”¨æˆ·å¤±è´¥:', error);
                showMessage('åŠ è½½å®¢æœç”¨æˆ·å¤±è´¥', 'error');
            }
        }
        
        async function loadRegularUsers() {
            try {
                const response = await fetch('../../server/api/service-assignment.php?action=get_regular_users');
                const data = await response.json();
                
                const select = document.getElementById('regularUserSelect');
                select.innerHTML = '';
                
                if (data.success && data.regular_users) {
                    data.regular_users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        const status = user.is_assigned ? ` [å·²åˆ†é…ç»™: ${user.service_username}]` : ' [æœªåˆ†é…]';
                        option.textContent = `${user.nickname || user.username}${status}`;
                        option.style.color = user.is_assigned ? '#ffa500' : '#00ff00';
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ™®é€šç”¨æˆ·å¤±è´¥:', error);
                showMessage('åŠ è½½æ™®é€šç”¨æˆ·å¤±è´¥', 'error');
            }
        }
        
        async function loadAssignmentStatus() {
            try {
                const response = await fetch('../../server/api/service-assignment.php?action=get_assignment_status');
                const data = await response.json();
                
                const statusDiv = document.getElementById('assignmentStatus');
                
                if (data.success) {
                    let html = '<div class="assignment-stats">';
                    html += `<h4>åˆ†é…ç»Ÿè®¡</h4>`;
                    html += `<p>æ€»æ™®é€šç”¨æˆ·: ${data.stats.total_regular_users} | æ€»å®¢æœ: ${data.stats.total_service_users}</p>`;
                    html += `<p>å·²åˆ†é…: ${data.stats.total_assigned} | æœªåˆ†é…: ${data.stats.unassigned_users}</p>`;
                    html += '</div>';
                    
                    html += '<div class="assignment-details">';
                    html += '<h4>å®¢æœåˆ†é…ç»Ÿè®¡</h4>';
                    
                    if (data.assignments && data.assignments.length > 0) {
                        html += '<table class="assignment-table" style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                        html += '<tr style="background: rgba(255, 215, 0, 0.2);"><th style="padding: 8px; border: 1px solid #ffd700;">å®¢æœ</th><th style="padding: 8px; border: 1px solid #ffd700;">åˆ†é…ç”¨æˆ·æ•°</th></tr>';
                        
                        data.assignments.forEach(assignment => {
                            html += '<tr style="border-bottom: 1px solid rgba(255, 215, 0, 0.3);">';
                            html += `<td style="padding: 8px; border: 1px solid rgba(255, 215, 0, 0.3);">${assignment.service_nickname || assignment.service_username}</td>`;
                            html += `<td style="padding: 8px; border: 1px solid rgba(255, 215, 0, 0.3); text-align: center;">${assignment.assigned_count}</td>`;
                            html += '</tr>';
                        });
                        
                        html += '</table>';
                        html += '<p style="margin-top: 10px; color: #aaa; font-size: 12px;">ğŸ’¡ æç¤º: ä½¿ç”¨ä¸Šæ–¹æœç´¢åŠŸèƒ½æŸ¥è¯¢ç‰¹å®šç”¨æˆ·çš„åˆ†é…æƒ…å†µ</p>';
                    } else {
                        html += '<p>æš‚æ— å®¢æœåˆ†é…æ•°æ®</p>';
                    }
                    
                    html += '</div>';
                    statusDiv.innerHTML = html;
                } else {
                    statusDiv.innerHTML = '<p style="color: #ff6b6b;">åŠ è½½åˆ†é…çŠ¶æ€å¤±è´¥</p>';
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†é…çŠ¶æ€å¤±è´¥:', error);
                document.getElementById('assignmentStatus').innerHTML = '<p style="color: #ff6b6b;">åŠ è½½åˆ†é…çŠ¶æ€å¤±è´¥</p>';
            }
        }
        
        async function autoAssignUsers() {
            if (!confirm('ç¡®å®šè¦æ‰§è¡Œè‡ªåŠ¨å¹³å‡åˆ†é…å—ï¼Ÿæ­¤æ“ä½œå°†æŠŠæœªåˆ†é…çš„ç”¨æˆ·å¹³å‡åˆ†é…ç»™æ‰€æœ‰å®¢æœã€‚')) {
                return;
            }
            
            // è¯¢é—®æ˜¯å¦é‡æ–°åˆ†é…æ‰€æœ‰ç”¨æˆ·
            const reassign = confirm('æ˜¯å¦é‡æ–°åˆ†é…æ‰€æœ‰ç”¨æˆ·ï¼Ÿ\n\né€‰æ‹©"ç¡®å®š"å°†æ¸…ç©ºç°æœ‰åˆ†é…å¹¶é‡æ–°åˆ†é…æ‰€æœ‰ç”¨æˆ·\né€‰æ‹©"å–æ¶ˆ"å°†åªåˆ†é…æœªåˆ†é…çš„ç”¨æˆ·');
            
            try {
                showMessage('æ­£åœ¨æ‰§è¡Œè‡ªåŠ¨åˆ†é…...', 'success');
                
                const response = await fetch('../../server/api/service-assignment.php?action=auto_assign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reassign: reassign,
                        admin_id: getCurrentUserId() // éœ€è¦å®ç°è·å–å½“å‰ç®¡ç†å‘˜IDçš„å‡½æ•°
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    // åˆ·æ–°æ˜¾ç¤º
                    loadServiceUsers();
                    loadRegularUsers();
                    loadAssignmentStatus();
                } else {
                    showMessage('è‡ªåŠ¨åˆ†é…å¤±è´¥ï¼š' + data.error, 'error');
                }
            } catch (error) {
                console.error('è‡ªåŠ¨åˆ†é…å¤±è´¥:', error);
                showMessage('è‡ªåŠ¨åˆ†é…å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        async function manualAssignUsers() {
            const serviceUserId = document.getElementById('serviceUserSelect').value;
            const selectedUsers = Array.from(document.getElementById('regularUserSelect').selectedOptions).map(opt => opt.value);
            
            if (!serviceUserId) {
                showMessage('è¯·é€‰æ‹©å®¢æœäººå‘˜', 'error');
                return;
            }
            
            if (selectedUsers.length === 0) {
                showMessage('è¯·é€‰æ‹©è¦åˆ†é…çš„ç”¨æˆ·', 'error');
                return;
            }
            
            try {
                showMessage('æ­£åœ¨æ‰§è¡Œæ‰‹åŠ¨åˆ†é…...', 'success');
                
                const response = await fetch('../../server/api/service-assignment.php?action=manual_assign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        service_user_id: serviceUserId,
                        regular_user_ids: selectedUsers,
                        admin_id: getCurrentUserId() // éœ€è¦å®ç°è·å–å½“å‰ç®¡ç†å‘˜IDçš„å‡½æ•°
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    // åˆ·æ–°æ˜¾ç¤º
                    loadServiceUsers();
                    loadRegularUsers();
                    loadAssignmentStatus();
                    // æ¸…ç©ºé€‰æ‹©
                    document.getElementById('serviceUserSelect').value = '';
                    document.getElementById('regularUserSelect').selectedIndex = -1;
                } else {
                    showMessage('æ‰‹åŠ¨åˆ†é…å¤±è´¥ï¼š' + data.error, 'error');
                }
            } catch (error) {
                console.error('æ‰‹åŠ¨åˆ†é…å¤±è´¥:', error);
                showMessage('æ‰‹åŠ¨åˆ†é…å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // ç§»é™¤é€‰ä¸­ç”¨æˆ·çš„åˆ†é…
        async function removeSelectedAssignments() {
            const selectedUsers = Array.from(document.getElementById('regularUserSelect').selectedOptions).map(opt => opt.value);
            
            if (selectedUsers.length === 0) {
                showMessage('è¯·é€‰æ‹©è¦ç§»é™¤åˆ†é…çš„ç”¨æˆ·', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦ç§»é™¤é€‰ä¸­çš„ ${selectedUsers.length} ä¸ªç”¨æˆ·çš„åˆ†é…å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                let removedCount = 0;
                
                for (const userId of selectedUsers) {
                    const response = await fetch('../../server/api/service-assignment.php?action=remove_assignment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            regular_user_id: userId
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        removedCount++;
                    }
                }
                
                showMessage(`æˆåŠŸç§»é™¤ ${removedCount} ä¸ªç”¨æˆ·çš„åˆ†é…`, 'success');
                
                // åˆ·æ–°æ˜¾ç¤º
                loadServiceUsers();
                loadRegularUsers();
                loadAssignmentStatus();
                
                // æ¸…ç©ºé€‰æ‹©
                document.getElementById('regularUserSelect').selectedIndex = -1;
                
            } catch (error) {
                console.error('ç§»é™¤åˆ†é…å¤±è´¥:', error);
                showMessage('ç§»é™¤åˆ†é…å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // æœç´¢ç”¨æˆ·åŠŸèƒ½
        async function searchUser() {
            const searchTerm = document.getElementById('userSearchInput').value.trim();
            const resultDiv = document.getElementById('searchResult');
            
            if (!searchTerm) {
                showMessage('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error');
                return;
            }
            
            try {
                const response = await fetch('../../server/api/service-assignment.php?action=search_user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        search_term: searchTerm
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.style.display = 'block';
                    
                    if (data.users && data.users.length > 0) {
                        let html = '<h5 style="color: #00ffff; margin-bottom: 10px;">æœç´¢ç»“æœ:</h5>';
                        
                        data.users.forEach(user => {
                            const isAssigned = user.is_assigned;
                            const statusClass = isAssigned ? 'assigned' : 'unassigned';
                            const statusColor = isAssigned ? '#ffa500' : '#00ff00';
                            const statusText = isAssigned ? `å·²åˆ†é…ç»™: ${user.service_username}` : 'æœªåˆ†é…';
                            
                            html += `<div class="search-result-item ${statusClass}">`;
                            html += `<strong>${user.nickname || user.username}</strong> (ID: ${user.id})`;
                            html += `<br><span style="color: ${statusColor}; font-size: 12px;">${statusText}</span>`;
                            if (isAssigned) {
                                html += `<button class="remove-assignment-btn" onclick="removeUserAssignment(${user.id})" title="ç§»é™¤åˆ†é…">ç§»é™¤</button>`;
                            }
                            html += `</div>`;
                        });
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = '<p style="color: #ff6b6b;">æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·</p>';
                    }
                } else {
                    resultDiv.innerHTML = '<p style="color: #ff6b6b;">æœç´¢å¤±è´¥: ' + data.error + '</p>';
                }
            } catch (error) {
                console.error('æœç´¢ç”¨æˆ·å¤±è´¥:', error);
                resultDiv.innerHTML = '<p style="color: #ff6b6b;">æœç´¢å‡ºé”™: ' + error.message + '</p>';
            }
        }
        
        // æ¸…ç©ºæœç´¢
        function clearSearch() {
            document.getElementById('userSearchInput').value = '';
            document.getElementById('searchResult').style.display = 'none';
        }
        
        // ä¸ºæœç´¢è¾“å…¥æ¡†æ·»åŠ å›è½¦é”®æ”¯æŒ
        document.addEventListener('DOMContentLoaded', function() {
            // æœç´¢è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            document.addEventListener('keydown', function(e) {
                if (e.target.id === 'userSearchInput' && e.key === 'Enter') {
                    e.preventDefault();
                    searchUser();
                }
            });
        });
        
        // ç§»é™¤å•ä¸ªç”¨æˆ·çš„åˆ†é…
        async function removeUserAssignment(userId) {
            if (!confirm('ç¡®å®šè¦ç§»é™¤è¿™ä¸ªç”¨æˆ·çš„åˆ†é…å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('../../server/api/service-assignment.php?action=remove_assignment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        regular_user_id: userId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('æˆåŠŸç§»é™¤ç”¨æˆ·åˆ†é…', 'success');
                    // é‡æ–°æœç´¢ä»¥æ›´æ–°ç»“æœ
                    searchUser();
                    // åˆ·æ–°å…¶ä»–æ˜¾ç¤º
                    loadServiceUsers();
                    loadRegularUsers();
                    loadAssignmentStatus();
                } else {
                    showMessage('ç§»é™¤åˆ†é…å¤±è´¥ï¼š' + data.error, 'error');
                }
            } catch (error) {
                console.error('ç§»é™¤åˆ†é…å¤±è´¥:', error);
                showMessage('ç§»é™¤åˆ†é…å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        // è·å–å½“å‰ç”¨æˆ·IDçš„è¾…åŠ©å‡½æ•°
        function getCurrentUserId() {
            // è¿™é‡Œåº”è¯¥ä»sessionæˆ–localStorageè·å–å½“å‰ç™»å½•çš„ç®¡ç†å‘˜ID
            // æš‚æ—¶è¿”å›nullï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦æ ¹æ®å…·ä½“çš„è®¤è¯æ–¹å¼å®ç°
            return null;
        }
        
        // èº«ä»½ç æ›´æ”¹ç›¸å…³å‡½æ•°
        function showSecretKeyChange() {
            document.getElementById('secretKeyModal').classList.add('show');
        }
        
        function closeSecretKeyModal() {
            document.getElementById('secretKeyModal').classList.remove('show');
            document.getElementById('secretKeyForm').reset();
        }
        
        // å¤„ç†èº«ä»½ç æ›´æ”¹è¡¨å•æäº¤
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('secretKeyForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const currentSecretKey = document.getElementById('currentSecretKey').value;
                const newSecretKey = document.getElementById('newSecretKey').value;
                const confirmSecretKey = document.getElementById('confirmSecretKey').value;
                const adminPassword = document.getElementById('adminPassword').value;
                
                if (newSecretKey !== confirmSecretKey) {
                    showMessage('æ–°èº«ä»½ç ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´', 'error');
                    return;
                }
                
                if (newSecretKey.length < 3) {
                    showMessage('æ–°èº«ä»½ç é•¿åº¦è‡³å°‘3ä½', 'error');
                    return;
                }
                
                try {
                    const response = await fetch('../../server/api/super-admin.php?action=changeSecretKey', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            currentSecretKey: currentSecretKey,
                            newSecretKey: newSecretKey,
                            adminPassword: adminPassword
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showMessage('èº«ä»½ç æ›´æ”¹æˆåŠŸï¼', 'success');
                        closeSecretKeyModal();
                    } else {
                        showMessage('æ›´æ”¹å¤±è´¥ï¼š' + data.error, 'error');
                    }
                } catch (error) {
                    console.error('æ›´æ”¹èº«ä»½ç å¤±è´¥:', error);
                    showMessage('æ›´æ”¹èº«ä»½ç å¤±è´¥ï¼š' + error.message, 'error');
                }
            });
        });
        
        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(text, type = 'success') {
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: #fff;
                font-weight: bold;
                z-index: 9999;
                animation: slideIn 0.3s ease;
                ${type === 'success' ? 'background: linear-gradient(45deg, #00ff00, #00aa00);' : 'background: linear-gradient(45deg, #ff6b6b, #ff8e8e);'}
            `;
            message.textContent = text;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(message);
            
            // 3ç§’åç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                message.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    document.body.removeChild(message);
                    document.head.removeChild(style);
                }, 300);
            }, 3000);
        }

        // ä¸»é¢˜è®¾ç½®ç›¸å…³å‡½æ•°
        async function openThemeSettingsModal() {
            await loadCurrentTheme();
            document.getElementById('themeSettingsModal').style.display = 'flex';
        }

        function closeThemeSettingsModal() {
            document.getElementById('themeSettingsModal').style.display = 'none';
            document.getElementById('themeSettingsForm').reset();
        }

        // åŠ è½½å½“å‰ä¸»é¢˜åç§°
        async function loadCurrentTheme() {
            try {
                const response = await fetch('../../server/api/admin.php?action=get_theme_settings');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('currentThemeName').value = data.theme.name || 'å¹¸è¿é™ä¸´';
                } else {
                    document.getElementById('currentThemeName').value = 'å¹¸è¿é™ä¸´';
                }
            } catch (error) {
                console.error('åŠ è½½å½“å‰ä¸»é¢˜å¤±è´¥:', error);
                document.getElementById('currentThemeName').value = 'å¹¸è¿é™ä¸´';
            }
        }

        // å¤„ç†ä¸»é¢˜è®¾ç½®è¡¨å•æäº¤
        document.getElementById('themeSettingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const newThemeName = document.getElementById('newThemeName').value.trim();
            const confirmCheckbox = document.getElementById('confirmThemeChange');
            
            if (!newThemeName) {
                showMessage('è¯·è¾“å…¥æ–°çš„ä¸»é¢˜åç§°ï¼', 'error');
                return;
            }
            
            if (!confirmCheckbox.checked) {
                showMessage('è¯·ç¡®è®¤æ‚¨è¦ä¿®æ”¹æ‰€æœ‰é¡µé¢çš„ä¸»é¢˜åç§°ï¼', 'error');
                return;
            }
            
            if (newThemeName === document.getElementById('currentThemeName').value) {
                showMessage('æ–°ä¸»é¢˜åç§°ä¸å½“å‰åç§°ç›¸åŒï¼', 'error');
                return;
            }
            
            // ç¡®è®¤å¯¹è¯æ¡†
            if (!confirm(`ç¡®å®šè¦å°†ç½‘ç«™ä¸»é¢˜åç§°ä»"${document.getElementById('currentThemeName').value}"æ›´æ”¹ä¸º"${newThemeName}"å—ï¼Ÿ\n\næ­¤æ“ä½œå°†å½±å“æ‰€æœ‰é¡µé¢ï¼ŒåŒ…æ‹¬ï¼š\nâ€¢ ç½‘ç«™æ ‡é¢˜å’Œå¯¼èˆªæ \nâ€¢ æ‰€æœ‰æ¸¸æˆé¡µé¢æ ‡é¢˜\nâ€¢ ç”¨æˆ·ä¸­å¿ƒé¡µé¢\nâ€¢ ç®¡ç†åå°é¡µé¢\n\næ›´æ”¹åéœ€è¦ç­‰å¾…å‡ ç§’é’Ÿå®Œæˆå…¨ç«™æ›´æ–°ã€‚`)) {
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'æ­£åœ¨åº”ç”¨ä¸»é¢˜...';
                
                const response = await fetch('../../server/api/admin.php?action=update_theme_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        themeName: newThemeName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`ä¸»é¢˜å·²æˆåŠŸæ›´æ”¹ä¸º"${newThemeName}"ï¼\næ›´æ–°äº†${data.updated_files || 0}ä¸ªæ–‡ä»¶ã€‚`, 'success');
                    closeThemeSettingsModal();
                    
                    // 3ç§’ååˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°ä¸»é¢˜
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    showMessage('ä¸»é¢˜æ›´æ–°å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
                
            } catch (error) {
                console.error('æ›´æ–°ä¸»é¢˜å¤±è´¥:', error);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ï¼', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    </script>
</body>
</html>
