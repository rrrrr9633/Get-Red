<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏™‰∫∫‰∏≠ÂøÉ - Âπ∏ËøêÈôç‰∏¥</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/neon.css">
</head>
<body>
    <div class="particles"></div>
    
    <!-- ÂØºËà™Ê†è -->
    <nav class="navbar">
        <div class="nav-brand">
            <h1 class="neon-text gold">Âπ∏ËøêÈôç‰∏¥</h1>
        </div>
        
        <div class="nav-user">
            <div class="nav-links">
                <a href="../main.html" class="neon-text">ËøîÂõû‰∏ªÈ°µ</a>
                <a href="#" onclick="logout()" class="neon-text">ÈÄÄÂá∫ÁôªÂΩï</a>
            </div>
        </div>
    </nav>

    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-avatar-section">
                <div class="avatar-container">
                    <img id="profileAvatar" src="" alt="Â§¥ÂÉè" class="profile-avatar">
                    <button class="avatar-edit-btn" onclick="showAvatarSelector()">
                        <span>üé≠</span>
                    </button>
                </div>
            </div>
            
            <div class="profile-info">
                <h2 id="profileNickname" class="neon-text gold"></h2>
                <p id="profileUsername" class="neon-text"></p>
                <div class="balance-info">
                    <span class="neon-text">ÂΩìÂâç‰ΩôÈ¢ù: </span>
                    <span id="profileBalance" class="neon-text gold"></span>
                </div>
            </div>
        </div>

        <div class="profile-tabs">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showTab('account')">Ë¥¶Êà∑‰ø°ÊÅØ</button>
                <button class="tab-btn" onclick="showTab('transactions')">‰∫§ÊòìËÆ∞ÂΩï</button>
                <button class="tab-btn" onclick="showTab('checkin')">Á≠æÂà∞ËÆ∞ÂΩï</button>
            </div>

            <!-- Ë¥¶Êà∑‰ø°ÊÅØÊ†áÁ≠æÈ°µ -->
            <div id="accountTab" class="tab-content active">
                <div class="info-card">
                    <h3 class="neon-text gold">‰∏™‰∫∫ËµÑÊñô</h3>
                    <div id="profileInfo" class="profile-info-display">
                        <!-- ËµÑÊñô‰ø°ÊÅØÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                    </div>
                    <button id="editProfileBtn" class="btn-neon" onclick="toggleEditMode()">ÁºñËæëËµÑÊñô</button>
                    
                    <form id="profileForm" style="display: none;">
                        <div class="form-group">
                            <label class="neon-text">ÊòµÁß∞:</label>
                            <input type="text" id="editNickname" placeholder="ËØ∑ËæìÂÖ•ÊòµÁß∞">
                        </div>
                        
                        <div class="form-group">
                            <label class="neon-text">Áî®Êà∑Âêç:</label>
                            <input type="text" id="editUsername" disabled>
                        </div>
                        
                        <div class="form-group">
                            <label class="neon-text">ÈÇÆÁÆ±:</label>
                            <input type="email" id="editEmail" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±">
                        </div>
                        
                        <div class="form-buttons">
                            <button type="submit" class="btn-neon">‰øùÂ≠ò‰øÆÊîπ</button>
                            <button type="button" class="btn-neon secondary" onclick="cancelEdit()">ÂèñÊ∂à</button>
                        </div>
                    </form>
                </div>
                
                <div class="info-card">
                    <h3 class="neon-text gold">‰øÆÊîπÂØÜÁ†Å</h3>
                    <form id="passwordForm">
                        <div class="form-group">
                            <input type="password" id="currentPassword" placeholder="ÂΩìÂâçÂØÜÁ†Å">
                        </div>
                        
                        <div class="form-group">
                            <input type="password" id="newPassword" placeholder="Êñ∞ÂØÜÁ†Å">
                        </div>
                        
                        <div class="form-group">
                            <input type="password" id="confirmNewPassword" placeholder="Á°ÆËÆ§Êñ∞ÂØÜÁ†Å">
                        </div>
                        
                        <button type="submit" class="btn-neon">‰øÆÊîπÂØÜÁ†Å</button>
                    </form>
                </div>
            </div>

            <!-- ‰∫§ÊòìËÆ∞ÂΩïÊ†áÁ≠æÈ°µ -->
            <div id="transactionsTab" class="tab-content">
                <div class="info-card">
                    <h3 class="neon-text gold">‰∫§ÊòìËÆ∞ÂΩï</h3>
                    <div class="tab-sub-nav">
                        <button class="sub-tab-btn active" onclick="showTransactionType('all')">ÂÖ®ÈÉ®ËÆ∞ÂΩï</button>
                        <button class="sub-tab-btn" onclick="showTransactionType('draws')">ÊäΩÂ•ñËé∑Âæó</button>
                        <button class="sub-tab-btn" onclick="showTransactionType('decompose')">ÂàÜËß£Áâ©ÂìÅ</button>
                        <button class="sub-tab-btn" onclick="showTransactionType('financial')">ËµÑÈáëÊµÅÊ∞¥</button>
                        <button class="sub-tab-btn" onclick="showTransactionType('recharge')">ÂÖÖÂÄºËÆ∞ÂΩï</button>
                    </div>
                    
                    <div id="transactionsList" class="transactions-list">
                        <!-- ‰∫§ÊòìËÆ∞ÂΩïÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                    </div>
                    
                    <div class="pagination-controls">
                        <button class="btn-pagination" onclick="previousPage()" id="prevBtn">‰∏ä‰∏ÄÈ°µ</button>
                        <div class="page-info">
                            <span>Á¨¨</span>
                            <input type="number" id="pageInput" min="1" value="1" onchange="goToPage(this.value)">
                            <span>È°µÔºåÂÖ± <span id="totalPages">1</span> È°µ</span>
                        </div>
                        <button class="btn-pagination" onclick="nextPage()" id="nextBtn">‰∏ã‰∏ÄÈ°µ</button>
                    </div>
                </div>
            </div>

            <!-- Á≠æÂà∞ËÆ∞ÂΩïÊ†áÁ≠æÈ°µ -->
            <div id="checkinTab" class="tab-content">
                <div class="info-card">
                    <h3 class="neon-text gold">Á≠æÂà∞ËÆ∞ÂΩï</h3>
                    <div id="checkinStats" class="checkin-stats">
                        <div class="stat-item">
                            <span class="neon-text">ÊÄªÁ≠æÂà∞Â§©Êï∞:</span>
                            <span id="totalCheckins" class="neon-text gold">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="neon-text">ËøûÁª≠Á≠æÂà∞:</span>
                            <span id="consecutiveCheckins" class="neon-text gold">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="neon-text">Êú¨ÊúàÁ≠æÂà∞:</span>
                            <span id="monthlyCheckins" class="neon-text gold">0</span>
                        </div>
                    </div>
                    <div id="checkinList" class="checkin-list">
                        <!-- Á≠æÂà∞ËÆ∞ÂΩïÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Â§¥ÂÉèÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü -->
    <div id="avatarSelector" class="avatar-modal" style="display: none;">
        <div class="avatar-modal-content">
            <div class="avatar-modal-header">
                <h3 class="neon-text gold">ÈÄâÊã©Â§¥ÂÉè</h3>
                <button class="close-btn" onclick="closeAvatarSelector()">&times;</button>
            </div>
            <div class="avatar-grid">
                <!-- ÂÜÖÁΩÆÂ§¥ÂÉèÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div class="avatar-modal-footer">
                <button class="btn-neon secondary" onclick="closeAvatarSelector()">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <style>
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #ffd700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 1000;
        }
        
        .nav-brand h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .nav-links a {
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .nav-links a:hover {
            background: rgba(255, 215, 0, 0.1);
            text-shadow: 0 0 10px currentColor;
        }
        
        .profile-container {
            margin-top: 70px;
            padding: 40px 20px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .profile-header {
            display: flex;
            gap: 40px;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            border-radius: 20px;
        }
        
        .profile-avatar-section {
            flex-shrink: 0;
        }
        
        .avatar-container {
            position: relative;
            display: inline-block;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #ffd700;
            object-fit: cover;
        }
        
        .avatar-edit-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #ffd700;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .avatar-edit-btn:hover {
            background: #fff;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-info h2 {
            font-size: 32px;
            margin-bottom: 15px;
        }
        
        .profile-info p {
            margin: 8px 0;
            font-size: 16px;
            opacity: 0.8;
        }
        
        .balance-info {
            margin-top: 20px;
            font-size: 18px;
        }
        
        .profile-tabs {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            border-radius: 20px;
            overflow: hidden;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ffd700;
        }
        
        .tab-btn {
            flex: 1;
            padding: 20px;
            background: transparent;
            border: none;
            color: #ffd700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-right: 1px solid #ffd700;
        }
        
        .tab-btn:last-child {
            border-right: none;
        }
        
        .tab-btn:hover {
            background: rgba(255, 215, 0, 0.1);
        }
        
        .tab-btn.active {
            background: rgba(255, 215, 0, 0.2);
            text-shadow: 0 0 10px currentColor;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .info-card {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .info-card h3 {
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #ffd700;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }
        
        .form-group input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .profile-info-display {
            margin-bottom: 20px;
        }
        
        .profile-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .profile-info-item:last-child {
            border-bottom: none;
        }
        
        .profile-info-label {
            font-weight: bold;
            min-width: 100px;
        }
        
        .profile-info-value {
            color: #ffd700;
        }
        
        .form-buttons {
            display: flex;
            gap: 15px;
        }
        
        .btn-neon.secondary {
            background: transparent;
            border: 2px solid #666;
            color: #666;
        }
        
        .btn-neon.secondary:hover {
            border-color: #ffd700;
            color: #ffd700;
        }
        
        .tab-sub-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .sub-tab-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: #ffd700;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .sub-tab-btn:hover {
            background: rgba(255, 215, 0, 0.1);
        }
        
        .sub-tab-btn.active {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
        }
        
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            border-top: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .btn-pagination {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid #ffd700;
            color: #ffd700;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-pagination:hover:not(:disabled) {
            background: rgba(255, 215, 0, 0.1);
        }
        
        .btn-pagination:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffd700;
        }
        
        .page-info input {
            width: 60px;
            padding: 5px 8px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #ffd700;
            border-radius: 3px;
            color: #fff;
            text-align: center;
        }
        
        .neon-text.green {
            color: #00ff88;
        }
        
        .neon-text.red {
            color: #ff4444;
        }
        
        .transactions-list,
        .checkin-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .transaction-item,
        .checkin-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .transaction-item:last-child,
        .checkin-item:last-child {
            border-bottom: none;
        }
        
        .checkin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        /* Â§¥ÂÉèÈÄâÊã©Âô®Ê†∑Âºè */
        .avatar-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .avatar-modal-content {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .avatar-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #ffd700;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(255, 215, 0, 0.2);
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .avatar-option {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: cover;
        }
        
        .avatar-option:hover {
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            transform: scale(1.05);
        }
        
        .avatar-option.selected {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        }
        
        .avatar-modal-footer {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .tab-buttons {
                flex-direction: column;
            }
            
            .tab-btn {
                border-right: none;
                border-bottom: 1px solid #ffd700;
            }
            
            .tab-btn:last-child {
                border-bottom: none;
            }
            
            .checkin-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script src="../../js/effects.js"></script>
    <script>
        let currentUser = null;
        let isEditMode = false;
        let currentTransactionType = 'all';
        let currentPage = 1;
        let totalPages = 1;
        const pageSize = 10;

        // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
        function checkLogin() {
            const userData = localStorage.getItem('currentUser');
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            
            if (!userData || isLoggedIn !== 'true') {
                alert('ËØ∑ÂÖàÁôªÂΩïÔºÅ');
                window.location.href = '../auth/login.html';
                return null;
            }
            
            return JSON.parse(userData);
        }

        // Âä†ËΩΩÁî®Êà∑ËµÑÊñô
        async function loadProfile() {
            currentUser = checkLogin();
            if (!currentUser) return;

            try {
                const response = await fetch('../../server/api/users.php?action=profile', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const user = data.user;
                    
                    // ËÆæÁΩÆÂ§¥ÂÉè
                    document.getElementById('profileAvatar').src = user.avatar || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iNTAiIGZpbGw9IiNmZmQ3MDAiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCI+CjxjaXJjbGUgY3g9IjI1IiBjeT0iMjAiIHI9IjE1IiBmaWxsPSIjMTExIi8+CjxlbGxpcHNlIGN4PSIyNSIgY3k9IjUwIiByeD0iMjAiIHJ5PSIxNSIgZmlsbD0iIzExMSIvPgo8L3N2Zz4KPC9zdmc+';
                    
                    // ËÆæÁΩÆÂü∫Êú¨‰ø°ÊÅØ
                    document.getElementById('profileNickname').textContent = user.nickname || 'Êú™ËÆæÁΩÆÊòµÁß∞';
                    document.getElementById('profileUsername').textContent = `@${user.username}`;
                    document.getElementById('profileBalance').textContent = `${user.balance || 0} ÈáëÂ∏Å`;
                    
                    // Ê∏≤ÊüìËµÑÊñô‰ø°ÊÅØ
                    renderProfileInfo(user);
                    
                    // Â°´ÂÖÖÁºñËæëË°®Âçï
                    document.getElementById('editNickname').value = user.nickname || '';
                    document.getElementById('editUsername').value = user.username;
                    document.getElementById('editEmail').value = user.email || '';
                } else {
                    console.error('Ëé∑ÂèñÁî®Êà∑ËµÑÊñôÂ§±Ë¥•:', data.error);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁî®Êà∑ËµÑÊñôÂ§±Ë¥•:', error);
            }
        }

        // Ê∏≤ÊüìËµÑÊñô‰ø°ÊÅØ
        function renderProfileInfo(user) {
            const profileInfo = document.getElementById('profileInfo');
            profileInfo.innerHTML = `
                <div class="profile-info-item">
                    <span class="profile-info-label neon-text">Áî®Êà∑ID:</span>
                    <span class="profile-info-value neon-text">${user.id}</span>
                </div>
                <div class="profile-info-item">
                    <span class="profile-info-label neon-text">Áî®Êà∑Âêç:</span>
                    <span class="profile-info-value neon-text">${user.username}</span>
                </div>
                <div class="profile-info-item">
                    <span class="profile-info-label neon-text">ÊòµÁß∞:</span>
                    <span class="profile-info-value neon-text">${user.nickname || 'Êú™ËÆæÁΩÆ'}</span>
                </div>
                <div class="profile-info-item">
                    <span class="profile-info-label neon-text">ÈÇÆÁÆ±:</span>
                    <span class="profile-info-value neon-text">${user.email || 'Êú™ËÆæÁΩÆ'}</span>
                </div>
                <div class="profile-info-item">
                    <span class="profile-info-label neon-text">‰ΩôÈ¢ù:</span>
                    <span class="profile-info-value neon-text">${user.balance || 0} ÈáëÂ∏Å</span>
                </div>
                <div class="profile-info-item">
                    <span class="profile-info-label neon-text">Ê≥®ÂÜåÊó∂Èó¥:</span>
                    <span class="profile-info-value neon-text">${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Êú™Áü•'}</span>
                </div>
            `;
        }

        // ÂÜÖÁΩÆÂ§¥ÂÉèÊï∞ÊçÆ
        const builtinAvatars = [
            // ÈªòËÆ§Â§¥ÂÉè
            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iNTAiIGZpbGw9IiNmZmQ3MDAiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCI+CjxjaXJjbGUgY3g9IjI1IiBjeT0iMjAiIHI9IjE1IiBmaWxsPSIjMTExIi8+CjxlbGxpcHNlIGN4PSIyNSIgY3k9IjUwIiByeD0iMjAiIHJ5PSIxNSIgZmlsbD0iIzExMSIvPgo8L3N2Zz4KPC9zdmc+',
            // ËìùËâ≤Â§¥ÂÉè
            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iNTAiIGZpbGw9IiMwMDc3ZmYiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCI+CjxjaXJjbGUgY3g9IjI1IiBjeT0iMjAiIHI9IjE1IiBmaWxsPSIjZmZmIi8+CjxlbGxpcHNlIGN4PSIyNSIgY3k9IjUwIiByeD0iMjAiIHJ5PSIxNSIgZmlsbD0iI2ZmZiIvPgo8L3N2Zz4KPC9zdmc+',
            // ÁªøËâ≤Â§¥ÂÉè
            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iNTAiIGZpbGw9IiMwMGZmODgiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCI+CjxjaXJjbGUgY3g9IjI1IiBjeT0iMjAiIHI9IjE1IiBmaWxsPSIjMTExIi8+CjxlbGxpcHNlIGN4PSIyNSIgY3k9IjUwIiByeD0iMjAiIHJ5PSIxNSIgZmlsbD0iIzExMSIvPgo8L3N2Zz4KPC9zdmc+',
            // Á∫¢Ëâ≤Â§¥ÂÉè
            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iNTAiIGZpbGw9IiNmZjQ0NjIiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCI+CjxjaXJjbGUgY3g9IjI1IiBjeT0iMjAiIHI9IjE1IiBmaWxsPSIjZmZmIi8+CjxlbGxpcHNlIGN4PSIyNSIgY3k9IjUwIiByeD0iMjAiIHJ5PSIxNSIgZmlsbD0iI2ZmZiIvPgo8L3N2Zz4KPC9zdmc+',
            // Á¥´Ëâ≤Â§¥ÂÉè
            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iNTAiIGZpbGw9IiM4ODQ0ZmYiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCI+CjxjaXJjbGUgY3g9IjI1IiBjeT0iMjAiIHI9IjE1IiBmaWxsPSIjZmZmIi8+CjxlbGxpcHNlIGN4PSIyNSIgY3k9IjUwIiByeD0iMjAiIHJ5PSIxNSIgZmlsbD0iI2ZmZiIvPgo8L3N2Zz4KPC9zdmc+',
            // Ê©ôËâ≤Â§¥ÂÉè
            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iNTAiIGZpbGw9IiNmZjg4MDAiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCI+CjxjaXJjbGUgY3g9IjI1IiBjeT0iMjAiIHI9IjE1IiBmaWxsPSIjZmZmIi8+CjxlbGxpcHNlIGN4PSIyNSIgY3k9IjUwIiByeD0iMjAiIHJ5PSIxNSIgZmlsbD0iI2ZmZiIvPgo8L3N2Zz4KPC9zdmc+',
            // Á≤âËâ≤Â§¥ÂÉè
            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iNTAiIGZpbGw9IiNmZjQ0YjgiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCI+CjxjaXJjbGUgY3g9IjI1IiBjeT0iMjAiIHI9IjE1IiBmaWxsPSIjZmZmIi8+CjxlbGxpcHNlIGN4PSIyNSIgY3k9IjUwIiByeD0iMjAiIHJ5PSIxNSIgZmlsbD0iI2ZmZiIvPgo8L3N2Zz4KPC9zdmc+',
            // ÈùíËâ≤Â§¥ÂÉè
            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iNTAiIGZpbGw9IiMwMGZmZmYiLz4KPHN2ZyB4PSIyNSIgeT0iMjAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI2MCI+CjxjaXJjbGUgY3g9IjI1IiBjeT0iMjAiIHI9IjE1IiBmaWxsPSIjMTExIi8+CjxlbGxpcHNlIGN4PSIyNSIgY3k9IjUwIiByeD0iMjAiIHJ5PSIxNSIgZmlsbD0iIzExMSIvPgo8L3N2Zz4KPC9zdmc+'
        ];
        
        let selectedAvatar = null;

        // ÊòæÁ§∫Â§¥ÂÉèÈÄâÊã©Âô®
        function showAvatarSelector() {
            const modal = document.getElementById('avatarSelector');
            const grid = modal.querySelector('.avatar-grid');
            
            // ÁîüÊàêÂ§¥ÂÉèÈÄâÈ°π
            grid.innerHTML = builtinAvatars.map((avatar, index) => 
                `<img src="${avatar}" alt="Â§¥ÂÉèÈÄâÈ°π ${index + 1}" class="avatar-option" data-avatar="${avatar}" onclick="selectAvatar('${avatar}')">`
            ).join('');
            
            // È´ò‰∫ÆÂΩìÂâçÂ§¥ÂÉè
            const currentAvatar = document.getElementById('profileAvatar').src;
            const currentOption = grid.querySelector(`[data-avatar="${currentAvatar}"]`);
            if (currentOption) {
                currentOption.classList.add('selected');
                selectedAvatar = currentAvatar;
            }
            
            modal.style.display = 'flex';
        }
        
        // ÂÖ≥Èó≠Â§¥ÂÉèÈÄâÊã©Âô®
        function closeAvatarSelector() {
            document.getElementById('avatarSelector').style.display = 'none';
            selectedAvatar = null;
        }
        
        // ÈÄâÊã©Â§¥ÂÉè
        function selectAvatar(avatar) {
            // ÁßªÈô§‰πãÂâçÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Ê∑ªÂä†Êñ∞ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            const selectedOption = document.querySelector(`[data-avatar="${avatar}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            selectedAvatar = avatar;
            
            // Á´ãÂç≥Êõ¥Êñ∞Â§¥ÂÉèÂπ∂‰øùÂ≠ò
            updateAvatar(avatar);
        }
        
        // Êõ¥Êñ∞Â§¥ÂÉè
        async function updateAvatar(avatar) {
            try {
                const response = await fetch('../../server/api/users.php?action=profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ avatar: avatar })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫ÁöÑÂ§¥ÂÉè
                    document.getElementById('profileAvatar').src = avatar;
                    closeAvatarSelector();
                    alert('Â§¥ÂÉèÊõ¥Êñ∞ÊàêÂäüÔºÅ');
                } else {
                    alert('Â§¥ÂÉèÊõ¥Êñ∞Â§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                console.error('Â§¥ÂÉèÊõ¥Êñ∞Â§±Ë¥•:', error);
                alert('Â§¥ÂÉèÊõ¥Êñ∞Â§±Ë¥•ÔºÅ');
            }
        }

        // ÂàáÊç¢ÁºñËæëÊ®°Âºè
        function toggleEditMode() {
            isEditMode = !isEditMode;
            
            const profileInfo = document.getElementById('profileInfo');
            const profileForm = document.getElementById('profileForm');
            const editBtn = document.getElementById('editProfileBtn');
            
            if (isEditMode) {
                profileInfo.style.display = 'none';
                profileForm.style.display = 'block';
                editBtn.style.display = 'none';
            } else {
                profileInfo.style.display = 'block';
                profileForm.style.display = 'none';
                editBtn.style.display = 'block';
            }
        }

        // ÂèñÊ∂àÁºñËæë
        function cancelEdit() {
            toggleEditMode();
            // ÈáçÊñ∞Âä†ËΩΩÂéüÂßãÊï∞ÊçÆ
            loadProfile();
        }

        // ÊòæÁ§∫Ê†áÁ≠æÈ°µ
        function showTab(tabName) {
            // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÈ°µ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÈ°µ
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Âä†ËΩΩÂØπÂ∫îÁöÑÊï∞ÊçÆ
            if (tabName === 'transactions') {
                loadTransactions();
            } else if (tabName === 'checkin') {
                loadCheckinRecords();
            }
        }

        // ÊòæÁ§∫‰∫§ÊòìËÆ∞ÂΩïÁ±ªÂûã
        function showTransactionType(type) {
            currentTransactionType = type;
            currentPage = 1;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadTransactions();
        }

        // Âä†ËΩΩ‰∫§ÊòìËÆ∞ÂΩï
        async function loadTransactions(page = 1) {
            try {
                let url;
                let transactions = [];
                let totalPagesCount = 1;
                
                if (currentTransactionType === 'recharge') {
                    // Âä†ËΩΩÂÖÖÂÄºËÆ∞ÂΩï
                    const response = await fetch(`../../server/api/recharge.php?action=get_user_recharge_history`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({ 
                            page: page, 
                            limit: pageSize 
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        transactions = (data.history || []).map(record => ({
                            description: `ÂÖÖÂÄº - ${record.payment_method === 'alipay' ? 'ÊîØ‰ªòÂÆù' : record.payment_method === 'wechat' ? 'ÂæÆ‰ø°ÊîØ‰ªò' : record.payment_method}`,
                            amount: record.coins_gained,
                            created_at: record.created_at,
                            type: 'recharge',
                            status: record.status
                        }));
                        totalPagesCount = Math.ceil((data.total || 0) / pageSize);
                    }
                } else {
                    // Âä†ËΩΩÂÖ∂‰ªñÁ±ªÂûãÁöÑ‰∫§ÊòìËÆ∞ÂΩï
                    const response = await fetch(`../../server/api/users.php?action=transactions&type=${currentTransactionType}&page=${page}&limit=${pageSize}`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        transactions = data.transactions || [];
                        totalPagesCount = data.pagination ? data.pagination.total_pages : (data.totalPages || 1);
                    }
                }
                
                const container = document.getElementById('transactionsList');
                
                currentPage = page;
                totalPages = totalPagesCount;
                
                // Êõ¥Êñ∞ÂàÜÈ°µÊéß‰ª∂
                updatePaginationControls();
                
                if (transactions.length === 0) {
                    container.innerHTML = '<p class="neon-text" style="text-align: center; opacity: 0.6;">ÊöÇÊó†‰∫§ÊòìËÆ∞ÂΩï</p>';
                    return;
                }
                
                container.innerHTML = transactions.map(transaction => {
                    const date = new Date(transaction.created_at).toLocaleString();
                    const amount = parseFloat(transaction.amount);
                    const amountClass = amount > 0 ? 'green' : 'red';
                    const amountText = amount > 0 ? `+${amount}` : amount;
                    
                    let statusText = '';
                    if (transaction.type === 'recharge' && transaction.status) {
                        const statusMap = {
                            'pending': 'ÂæÖÊîØ‰ªò',
                            'completed': 'Â∑≤ÂÆåÊàê',
                            'failed': 'Â§±Ë¥•',
                            'cancelled': 'Â∑≤ÂèñÊ∂à'
                        };
                        statusText = ` (${statusMap[transaction.status] || transaction.status})`;
                    }
                    
                    return `
                        <div class="transaction-item">
                            <div>
                                <div class="neon-text">${transaction.description}${statusText}</div>
                                <div style="font-size: 12px; opacity: 0.6; margin-top: 5px;">
                                    ${date}
                                </div>
                            </div>
                            <div class="neon-text ${amountClass}">
                                ${amountText} ÈáëÂ∏Å
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Âä†ËΩΩ‰∫§ÊòìËÆ∞ÂΩïÂ§±Ë¥•:', error);
                const container = document.getElementById('transactionsList');
                container.innerHTML = '<p class="neon-text" style="text-align: center; opacity: 0.6;">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï</p>';
            }
        }

        // Êõ¥Êñ∞ÂàÜÈ°µÊéß‰ª∂
        function updatePaginationControls() {
            document.getElementById('pageInput').value = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }

        // ‰∏ä‰∏ÄÈ°µ
        function previousPage() {
            if (currentPage > 1) {
                loadTransactions(currentPage - 1);
            }
        }

        // ‰∏ã‰∏ÄÈ°µ
        function nextPage() {
            if (currentPage < totalPages) {
                loadTransactions(currentPage + 1);
            }
        }

        // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÈ°µ
        function goToPage(page) {
            const pageNum = parseInt(page);
            if (pageNum >= 1 && pageNum <= totalPages && pageNum !== currentPage) {
                loadTransactions(pageNum);
            }
        }

        // Âä†ËΩΩÁ≠æÂà∞ËÆ∞ÂΩï
        async function loadCheckinRecords() {
            try {
                const response = await fetch('../../server/api/checkin.php?action=status', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Êõ¥Êñ∞ÁªüËÆ°ÊòæÁ§∫
                    document.getElementById('totalCheckins').textContent = data.totalDays || 0;
                    document.getElementById('consecutiveCheckins').textContent = data.consecutiveDays || 0;
                    document.getElementById('monthlyCheckins').textContent = data.monthlyDays || 0;
                    
                    // Âä†ËΩΩÁ≠æÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
                    loadCheckinHistory();
                } else {
                    console.error('Âä†ËΩΩÁ≠æÂà∞Êï∞ÊçÆÂ§±Ë¥•:', data.error);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁ≠æÂà∞ËÆ∞ÂΩïÂ§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩÁ≠æÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
        async function loadCheckinHistory() {
            try {
                const response = await fetch('../../server/api/checkin.php?action=history', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('checkinList');
                    const records = data.records || [];
                    
                    if (records.length === 0) {
                        container.innerHTML = '<p class="neon-text" style="text-align: center; opacity: 0.6;">ÊöÇÊó†Á≠æÂà∞ËÆ∞ÂΩï</p>';
                        return;
                    }
                    
                    container.innerHTML = records.slice(0, 20).map(record => `
                        <div class="checkin-item">
                            <div>
                                <div class="neon-text">Á≠æÂà∞Â•ñÂä±</div>
                                <div style="font-size: 12px; opacity: 0.6; margin-top: 5px;">
                                    ${new Date(record.checkin_date).toLocaleDateString()}
                                </div>
                            </div>
                            <div class="neon-text gold">+${record.reward_amount || 10} ÈáëÂ∏Å</div>
                        </div>
                    `).join('');
                } else {
                    console.error('Âä†ËΩΩÁ≠æÂà∞ÂéÜÂè≤Â§±Ë¥•:', data.error);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁ≠æÂà∞ÂéÜÂè≤Â§±Ë¥•:', error);
            }
        }

        // ‰øùÂ≠òËµÑÊñô
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nickname = document.getElementById('editNickname').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            
            if (!nickname) {
                alert('ÊòµÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
                return;
            }
            
            try {
                const response = await fetch('../../server/api/users.php?action=profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ nickname, email })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('ËµÑÊñôÊõ¥Êñ∞ÊàêÂäüÔºÅ');
                    toggleEditMode();
                    loadProfile(); // ÈáçÊñ∞Âä†ËΩΩËµÑÊñô
                } else {
                    alert('ËµÑÊñôÊõ¥Êñ∞Â§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                console.error('ËµÑÊñôÊõ¥Êñ∞Â§±Ë¥•:', error);
                alert('ËµÑÊñôÊõ¥Êñ∞Â§±Ë¥•ÔºÅ');
            }
        });

        // ‰øÆÊîπÂØÜÁ†Å
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                alert('ËØ∑Â°´ÂÜôÊâÄÊúâÂØÜÁ†ÅÂ≠óÊÆµÔºÅ');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                alert('Êñ∞ÂØÜÁ†Å‰∏§Ê¨°ËæìÂÖ•‰∏ç‰∏ÄËá¥ÔºÅ');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Êñ∞ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë6‰ΩçÔºÅ');
                return;
            }
            
            try {
                const response = await fetch('../../server/api/users.php?action=password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('ÂØÜÁ†Å‰øÆÊîπÊàêÂäüÔºÅ');
                    document.getElementById('passwordForm').reset();
                } else {
                    alert('ÂØÜÁ†Å‰øÆÊîπÂ§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                console.error('ÂØÜÁ†Å‰øÆÊîπÂ§±Ë¥•:', error);
                alert('ÂØÜÁ†Å‰øÆÊîπÂ§±Ë¥•ÔºÅ');
            }
        });

        // ÈÄÄÂá∫ÁôªÂΩï
        function logout() {
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('isLoggedIn');
                window.location.href = '../auth/login.html';
            }
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊâßË°å
        document.addEventListener('DOMContentLoaded', function() {
            loadProfile();
            createParticles();
        });
    </script>
</body>
</html>
