<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸è¿æ‰è½ - å¹¸è¿é™ä¸´</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/neon.css">
    <link rel="stylesheet" href="../../css/slot-machine.css">
</head>
<body>
    <div class="particles"></div>
    
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-brand">
            <h1 class="neon-text gold" onclick="goToHome()" style="cursor: pointer;" title="è¿”å›ä¸»é¡µ">å¹¸è¿é™ä¸´</h1>
        </div>
        
        <div class="nav-user">
            <!-- ä»“åº“åŠŸèƒ½ -->
            <div class="nav-item warehouse-btn" onclick="window.location.href='modules/container.html'" title="å®ç®±å¯»å®">
                <i class="icon">ğŸ“¦</i>
                <span>ä»“åº“</span>
            </div>
            
            <!-- æ¯æ—¥ç­¾åˆ° -->
            <div class="nav-item checkin-btn" onclick="window.location.href='modules/checkin.html'" title="æ¯æ—¥ç­¾åˆ°">
                <i class="icon">ğŸ“…</i>
                <span>ç­¾åˆ°</span>
            </div>
            
            <div class="user-info" id="userInfo">
                <img id="userAvatar" src="" alt="å¤´åƒ" class="user-avatar">
                <span id="userNickname" class="neon-text"></span>
                <span id="userBalance" class="neon-text gold"></span>
                <div class="user-dropdown">
                    <a href="user/profile.html" class="neon-text">ä¸ªäººä¸­å¿ƒ</a>
                    <a href="main.html" class="neon-text">è¿”å›ä¸»é¡µ</a>
                    <a href="#" onclick="logout()" class="neon-text">é€€å‡ºç™»å½•</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="game-container">
        <div class="game-header">
            <h2 class="neon-text rainbow">å¹¸è¿æ‰è½</h2>
            <p class="neon-text">ç¥ç§˜ç¤¼å“ç­‰ä½ æ¥æŠ½ï¼Œè¿æ°”å†³å®šä¸€åˆ‡ï¼</p>
        </div>

        <!-- æŠ½å¥–è®¾ç½® -->
        <div class="draw-settings">
            <div class="draw-mode-selector">
                <button class="mode-btn active" data-mode="1">å•æŠ½</button>
                <button class="mode-btn" data-mode="3">ä¸‰è¿æŠ½</button>
                <button class="mode-btn" data-mode="5">äº”è¿æŠ½</button>
            </div>
        </div>

        <!-- æ¨ªå‘æ»šåŠ¨è€è™æœº -->
        <div class="horizontal-slot-container">
            <div class="slot-rows" id="slotRows">
                <!-- æŠ½å¥–è¡Œå°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="slot-controls">
                <button id="spinBtn" class="btn-spin">
                    <span class="btn-text">å¼€å§‹æŠ½å¥–</span>
                    <span class="btn-cost" id="btnCost">(æ¶ˆè€—: 10)</span>
                </button>
            </div>
        </div>

        <!-- å¥–å“è¯´æ˜ -->
        <div class="prize-info">
            <h3 class="neon-text gold">å¥–å“è¯´æ˜</h3>
            <div class="prize-grid" id="prizeGrid">
                <!-- å¥–å“è¯´æ˜å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æ¯æ—¥ç­¾åˆ°å¼¹çª— -->
    <div id="checkinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="neon-text gold">æ¯æ—¥ç­¾åˆ°</h3>
                <span class="close" onclick="closeCheckinModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="checkinContent">
                    <div class="checkin-calendar">
                        <div class="calendar-header">
                            <h4 class="neon-text">æœ¬æœˆç­¾åˆ°è®°å½•</h4>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- æ—¥å†ç½‘æ ¼å°†é€šè¿‡JSç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="checkin-rewards">
                        <h4 class="neon-text gold">ç­¾åˆ°å¥–åŠ±</h4>
                        <div class="reward-item">
                            <span>è¿ç»­ç­¾åˆ°1å¤©ï¼šé‡‘å¸ +10</span>
                        </div>
                        <div class="reward-item">
                            <span>è¿ç»­ç­¾åˆ°7å¤©ï¼šé‡‘å¸ +100</span>
                        </div>
                        <div class="reward-item">
                            <span>è¿ç»­ç­¾åˆ°30å¤©ï¼šç¥ç§˜ç¤¼å“</span>
                        </div>
                    </div>
                    <button id="checkinBtn" class="btn-checkin" onclick="performCheckin()">
                        ç«‹å³ç­¾åˆ°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä»“åº“å¼¹çª— -->
    <div id="warehouseModal" class="modal">
        <div class="modal-content warehouse-modal">
            <div class="modal-header">
                <h3 class="neon-text gold">æˆ‘çš„ä»“åº“</h3>
                <span class="close" onclick="closeWarehouseModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="warehouse-tabs">
                    <button class="tab-btn active" data-tab="items">ç‰©å“</button>
                    <button class="tab-btn" data-tab="rewards">å¥–åŠ±</button>
                    <button class="tab-btn" data-tab="gifts">ç¤¼å“</button>
                </div>
                <div class="warehouse-content">
                    <div id="warehouseItems" class="warehouse-grid">
                        <!-- ä»“åº“ç‰©å“å°†é€šè¿‡JSç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸­å¥–æç¤º -->
    <div id="winModal" class="modal">
        <div class="modal-content">
            <h3 class="neon-text gold">æ­å–œä¸­å¥–ï¼</h3>
            <div id="winResult" class="win-result"></div>
            <button onclick="closeWinModal()" class="btn-neon">ç¡®å®š</button>
        </div>
    </div>

    <style>
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #ffd700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 1000;
        }
        
        .nav-brand h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .nav-user {
            position: relative;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            border-radius: 15px;
            background: rgba(255, 215, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .nav-item:hover {
            background: rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }
        
        .nav-item .icon {
            font-size: 18px;
        }
        
        .nav-item span {
            font-size: 12px;
            color: #ffd700;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            padding: 10px;
            border-radius: 25px;
            background: rgba(255, 215, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .user-info:hover {
            background: rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ffd700;
            object-fit: cover;
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 10px 0;
            min-width: 150px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1001;
        }
        
        .user-info:hover .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .user-dropdown a {
            display: block;
            padding: 10px 20px;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .user-dropdown a:hover {
            background: rgba(255, 215, 0, 0.1);
            text-shadow: 0 0 10px currentColor;
        }
        
        .game-container {
            margin-top: 70px;
            padding: 40px 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
        
        .game-header {
            margin-bottom: 40px;
        }
        
        .game-header h2 {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .game-header p {
            font-size: 18px;
            opacity: 0.8;
        }

        /* æŠ½å¥–è®¾ç½®æ ·å¼ */
        .draw-settings {
            margin: 30px 0;
        }
        
        .draw-mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .mode-btn {
            padding: 10px 25px;
            border: 2px solid #ffd700;
            background: transparent;
            color: #ffd700;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .mode-btn:hover {
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        
        .mode-btn.active {
            background: #ffd700;
            color: #000;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        /* æ¨ªå‘æ»šåŠ¨è€è™æœºæ ·å¼ */
        .horizontal-slot-container {
            margin: 40px 0;
        }
        
        .slot-rows {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .slot-row {
            position: relative;
            height: 80px;
            border: 2px solid #ffd700;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.8);
        }
        
        .slot-strip {
            display: flex;
            height: 100%;
            transform: translateX(0px);
            transition: none;
            will-change: transform;
        }
        
        .slot-item {
            flex: 0 0 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 1px solid rgba(255, 215, 0, 0.3);
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
        }
        
        .slot-item:last-child {
            border-right: none;
        }
        
        .slot-item .icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .slot-item .name {
            font-size: 10px;
            color: #ffd700;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        
        /* ä¸­å¿ƒæŒ‡é’ˆ */
        .slot-pointer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 60px;
            background: linear-gradient(to bottom, #ff0000, #ff4444);
            border-radius: 2px;
            box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
            z-index: 10;
            animation: pointer-glow 2s ease-in-out infinite alternate;
        }
        
        .slot-pointer::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 10px solid #ff0000;
        }
        
        .slot-pointer::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 10px solid #ff0000;
        }
        
        @keyframes pointer-glow {
            0% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
            100% { box-shadow: 0 0 15px #ff0000, 0 0 30px #ff0000; }
        }
        
        .slot-machine-container {
            margin: 40px 0;
        }
        
        .slot-controls {
            margin-top: 30px;
        }
        
        .btn-spin {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            color: #000;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-spin:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }
        
        .btn-spin:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-cost {
            display: block;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .prize-info {
            margin-top: 60px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
        }
        
        .prize-info h3 {
            font-size: 24px;
            margin-bottom: 30px;
        }
        
        .prize-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .prize-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            transition: all 0.3s ease;
        }
        
        .prize-item:hover {
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }
        
        .prize-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .prize-name {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .prize-value {
            color: #4ade80;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .warehouse-modal {
            max-width: 600px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 30px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close:hover {
            color: #ffd700;
        }

        /* ç­¾åˆ°å¼¹çª—æ ·å¼ */
        .checkin-calendar {
            margin: 20px 0;
        }

        .calendar-header {
            margin-bottom: 15px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .calendar-day {
            padding: 8px;
            border: 1px solid #444;
            border-radius: 5px;
            font-size: 12px;
            text-align: center;
        }

        .calendar-day.checked {
            background: #4ade80;
            color: #000;
        }

        .calendar-day.today {
            border-color: #ffd700;
        }

        .checkin-rewards {
            margin: 20px 0;
            text-align: left;
        }

        .reward-item {
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .btn-checkin {
            background: linear-gradient(45deg, #4ade80, #22c55e);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-checkin:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 222, 128, 0.4);
        }

        .btn-checkin:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ä»“åº“å¼¹çª—æ ·å¼ */
        .warehouse-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .tab-btn {
            padding: 8px 20px;
            border: 2px solid #444;
            background: transparent;
            color: #fff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            border-color: #ffd700;
            color: #ffd700;
        }

        .warehouse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .warehouse-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #444;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .warehouse-item:hover {
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .warehouse-item-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .warehouse-item-name {
            font-size: 12px;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .warehouse-item-count {
            font-size: 10px;
            opacity: 0.7;
        }
        
        .modal-content h3 {
            font-size: 28px;
            margin-bottom: 20px;
        }
        
        .win-result {
            margin: 30px 0;
            font-size: 48px;
        }
        
        .prize-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .slot-item-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .slot-item .prize-name {
            font-size: 10px;
            color: #ffd700;
            text-align: center;
            margin-top: 5px;
        }
        
        .slot-item.active {
            background: rgba(255, 215, 0, 0.3);
            border: 2px solid #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        .prize-item .prize-display {
            margin-bottom: 15px;
        }
        
        .prize-item .prize-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .prize-item .prize-rarity {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.7);
        }
        
        .prize-item.common .prize-rarity {
            color: #9ca3af;
        }
        
        .prize-item.rare .prize-rarity {
            color: #3b82f6;
        }
        
        .prize-item.epic .prize-rarity {
            color: #8b5cf6;
        }
        
        .prize-item.legendary .prize-rarity {
            color: #f59e0b;
        }
        
        @keyframes spin {
            0% { transform: translateY(0); }
            100% { transform: translateY(-400%); }
        }
        
        @media (max-width: 768px) {
            .navbar {
                padding: 0 15px;
            }
            
            .nav-brand h1 {
                font-size: 20px;
            }
            
            .user-info {
                gap: 10px;
                padding: 8px;
            }
            
            .user-avatar {
                width: 35px;
                height: 35px;
            }
            
            .game-container {
                padding: 20px 15px;
            }
            
            .game-header h2 {
                font-size: 36px;
            }
            
            .prize-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script src="../../js/api-client.js"></script>
    <script src="../../js/effects.js"></script>
    <script>
        let currentUser = null;
        let prizeData = [];
        let currentMode = 1; // å½“å‰æŠ½å¥–æ¨¡å¼ï¼š1å•æŠ½ï¼Œ3ä¸‰è¿æŠ½ï¼Œ5äº”è¿æŠ½

        // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶åŠ è½½æ•°æ®
        async function initPage() {
            // ç›´æ¥æ£€æŸ¥localStorageä¸­çš„ç™»å½•çŠ¶æ€
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const currentUserData = localStorage.getItem('currentUser');
            
            if (isLoggedIn !== 'true' || !currentUserData) {
                alert('è¯·å…ˆç™»å½•ï¼');
                window.location.href = 'auth/login.html';
                return;
            }
            
            try {
                currentUser = JSON.parse(currentUserData);
                console.log('å½“å‰ç”¨æˆ·:', currentUser);
            } catch (e) {
                alert('ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•ï¼');
                window.location.href = 'auth/login.html';
                return;
            }
            
            await loadUserInfo();
            await loadPrizes();
            initSlotMachine();
            bindEvents();
            createParticles();
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const result = await api.getUserProfile();
                if (result.success) {
                    const user = result.user;
                    document.getElementById('userAvatar').src = user.avatar;
                    document.getElementById('userNickname').textContent = user.nickname;
                    document.getElementById('userBalance').textContent = `ä½™é¢: ${user.balance}`;
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½å¥–å“æ•°æ®
        async function loadPrizes() {
            try {
                const result = await api.getPrizes('lucky_drop');
                if (result.success) {
                    prizeData = result.prizes;
                }
            } catch (error) {
                console.error('åŠ è½½å¥–å“æ•°æ®å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤æ•°æ®
                prizeData = [
                    { id: 1, name: 'iPhone 15 Pro', icon: 'ğŸ“±', image_url: '/uploads/prizes/iphone15.jpg', value: 8000, rarity: 'legendary', probability: 1 },
                    { id: 2, name: 'MacBook Air', icon: 'ğŸ’»', image_url: '/uploads/prizes/macbook.jpg', value: 7000, rarity: 'legendary', probability: 1 },
                    { id: 3, name: 'AirPods Pro', icon: 'ğŸ§', image_url: '/uploads/prizes/airpods.jpg', value: 1500, rarity: 'epic', probability: 5 },
                    { id: 4, name: 'iPad', icon: 'ğŸ“±', image_url: '/uploads/prizes/ipad.jpg', value: 3000, rarity: 'epic', probability: 3 },
                    { id: 5, name: 'Apple Watch', icon: 'âŒš', image_url: '/uploads/prizes/watch.jpg', value: 2500, rarity: 'rare', probability: 8 },
                    { id: 6, name: 'è“ç‰™éŸ³å“', icon: 'ğŸ”Š', image_url: '/uploads/prizes/speaker.jpg', value: 500, rarity: 'rare', probability: 15 },
                    { id: 7, name: 'å……ç”µå®', icon: 'ğŸ”‹', image_url: '/uploads/prizes/powerbank.jpg', value: 100, rarity: 'common', probability: 30 },
                    { id: 8, name: 'æ•°æ®çº¿', icon: 'ğŸ”Œ', image_url: '/uploads/prizes/cable.jpg', value: 50, rarity: 'common', probability: 37 }
                ];
            }
            
            generatePrizeGrid();
        }

        // åˆå§‹åŒ–æ¨ªå‘æ»šåŠ¨è€è™æœº
        function initSlotMachine() {
            updateSlotRows();
        }

        // æ›´æ–°è€è™æœºè¡Œæ•°
        function updateSlotRows() {
            const slotRows = document.getElementById('slotRows');
            slotRows.innerHTML = '';
            
            for (let i = 0; i < currentMode; i++) {
                const row = createSlotRow();
                slotRows.appendChild(row);
            }
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤ºçš„æ¶ˆè€—
            const cost = currentMode * 10;
            document.getElementById('btnCost').textContent = `(æ¶ˆè€—: ${cost})`;
        }

        // åˆ›å»ºä¸€è¡Œè€è™æœº
        function createSlotRow() {
            const row = document.createElement('div');
            row.className = 'slot-row';
            
            // åˆ›å»ºæ»šåŠ¨æ¡
            const strip = document.createElement('div');
            strip.className = 'slot-strip';
            
            // åˆ›å»ºä¸­å¿ƒæŒ‡é’ˆ
            const pointer = document.createElement('div');
            pointer.className = 'slot-pointer';
            
            // ç”Ÿæˆå¥–å“é¡¹ç›®ï¼ˆé‡å¤å¤šæ¬¡ä»¥ä¾¿æ»šåŠ¨ï¼‰
            // ç¡®ä¿æœ‰è¶³å¤Ÿçš„é¡¹ç›®è®©æ»šåŠ¨çœ‹èµ·æ¥çœŸå®
            const repeatTimes = 8; // å°†å¥–å“åˆ—è¡¨é‡å¤8æ¬¡
            for (let repeat = 0; repeat < repeatTimes; repeat++) {
                for (let i = 0; i < prizeData.length; i++) {
                    const prize = prizeData[i];
                    const item = createSlotItem(prize);
                    strip.appendChild(item);
                }
            }
            
            row.appendChild(strip);
            row.appendChild(pointer);
            
            return row;
        }

        // åˆ›å»ºè€è™æœºé¡¹ç›®
        function createSlotItem(prize) {
            const item = document.createElement('div');
            item.className = 'slot-item';
            item.dataset.prizeId = prize.id;
            
            const icon = document.createElement('div');
            icon.className = 'icon';
            
            if (prize.image_url) {
                const img = document.createElement('img');
                img.src = prize.image_url;
                img.alt = prize.name;
                img.style.width = '32px';
                img.style.height = '32px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '4px';
                img.onerror = () => {
                    img.style.display = 'none';
                    icon.textContent = prize.icon;
                };
                icon.appendChild(img);
            } else {
                icon.textContent = prize.icon;
            }
            
            const name = document.createElement('div');
            name.className = 'name';
            name.textContent = prize.name;
            
            item.appendChild(icon);
            item.appendChild(name);
            
            return item;
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // æ¨¡å¼é€‰æ‹©æŒ‰é’®
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    // æ·»åŠ æ´»åŠ¨çŠ¶æ€
                    e.target.classList.add('active');
                    // è®¾ç½®å½“å‰æ¨¡å¼
                    currentMode = parseInt(e.target.dataset.mode);
                    updateSlotRows();
                });
            });

            // æŠ½å¥–æŒ‰é’®
            document.getElementById('spinBtn').addEventListener('click', startSpin);
        }

        // å¼€å§‹æŠ½å¥–
        async function startSpin() {
            const spinBtn = document.getElementById('spinBtn');
            spinBtn.disabled = true;
            spinBtn.querySelector('.btn-text').textContent = 'æŠ½å¥–ä¸­...';

            try {
                // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
                if (!currentUser || !currentUser.id) {
                    throw new Error('ç”¨æˆ·ä¿¡æ¯æ— æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
                
                console.log('å¼€å§‹æŠ½å¥–ï¼Œç”¨æˆ·ID:', currentUser.id);
                
                // è°ƒç”¨åç«¯æŠ½å¥–API
                const drawResult = await api.drawPrizes('lucky_drop', currentMode);
                console.log('æŠ½å¥–APIè¿”å›:', drawResult);
                
                if (!drawResult.success) {
                    throw new Error(drawResult.message || drawResult.error || 'æŠ½å¥–å¤±è´¥');
                }
                
                // æ’­æ”¾æ»šåŠ¨åŠ¨ç”»ï¼Œä½¿ç”¨åç«¯è¿”å›çš„ç»“æœ
                await performSpinWithResults(drawResult.prizes || drawResult.results);
                
                // æ˜¾ç¤ºç»“æœ
                setTimeout(() => {
                    showWinResult(drawResult.prizes || drawResult.results, drawResult.total_value);
                    
                    // é‡ç½®æŒ‰é’®
                    spinBtn.disabled = false;
                    spinBtn.querySelector('.btn-text').textContent = 'å¼€å§‹æŠ½å¥–';
                    
                    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
                    loadUserInfo();
                    
                    // é‡ç½®æ‰€æœ‰stripåˆ°åˆå§‹ä½ç½®ï¼Œä¸ºä¸‹æ¬¡æŠ½å¥–åšå‡†å¤‡
                    setTimeout(() => {
                        const allStrips = document.querySelectorAll('.slot-strip');
                        allStrips.forEach(strip => {
                            strip.style.transition = 'none';
                            strip.style.transform = 'translateX(0px)';
                        });
                    }, 1000); // ç­‰å¾…1ç§’åé‡ç½®
                    
                }, 4000); // å¢åŠ ç­‰å¾…æ—¶é—´åˆ°4ç§’
                
            } catch (error) {
                console.error('æŠ½å¥–å¤±è´¥:', error);
                alert(error.message || 'æŠ½å¥–å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼');
                
                spinBtn.disabled = false;
                spinBtn.querySelector('.btn-text').textContent = 'å¼€å§‹æŠ½å¥–';
            }
        }

        // æ‰§è¡ŒæŠ½å¥–åŠ¨ç”»
        async function performSpin() {
            const rows = document.querySelectorAll('.slot-row');
            const results = [];
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const strip = row.querySelector('.slot-strip');
                const items = strip.querySelectorAll('.slot-item');
                
                // éšæœºé€‰æ‹©ä¸­å¥–é¡¹ç›®ï¼ˆåŸºäºæ¦‚ç‡ï¼‰
                const winningPrize = selectPrizeByProbability();
                results.push(winningPrize);
                
                // å¼ºåˆ¶é‡ç½®åˆ°åˆå§‹ä½ç½®ï¼Œç¡®ä¿æ¯æ¬¡éƒ½ä»å¤´å¼€å§‹
                strip.style.transition = 'none';
                strip.style.transform = 'translateX(0px)';
                
                // å¼ºåˆ¶é‡ç»˜
                strip.offsetHeight;
                
                // æ‰¾åˆ°ç›®æ ‡å¥–å“çš„ç´¢å¼•ï¼ˆé€‰æ‹©ä¸€ä¸ªé å‰çš„ä½ç½®ï¼Œç¡®ä¿å¯è§ï¼‰
                let targetIndex = -1;
                const prizeIndices = [];
                
                // æ”¶é›†æ‰€æœ‰åŒ¹é…çš„å¥–å“ç´¢å¼•
                for (let j = 0; j < items.length; j++) {
                    if (parseInt(items[j].dataset.prizeId) === winningPrize.id) {
                        prizeIndices.push(j);
                    }
                }
                
                // é€‰æ‹©ä¸€ä¸ªåœ¨å‰åŠéƒ¨åˆ†çš„ç´¢å¼•ï¼Œç¡®ä¿æ»šåŠ¨åèƒ½çœ‹åˆ°
                if (prizeIndices.length > 0) {
                    // é€‰æ‹©å‰é¢å‡ ä¸ªä¸­çš„ä¸€ä¸ªï¼Œç¡®ä¿æ»šåŠ¨ååœ¨å¯è§†èŒƒå›´å†…
                    const visibleIndices = prizeIndices.filter(idx => idx < items.length / 2);
                    targetIndex = visibleIndices.length > 0 ? visibleIndices[0] : prizeIndices[0];
                } else {
                    targetIndex = Math.floor(Math.random() * Math.min(10, items.length)); // åªåœ¨å‰10ä¸ªä¸­é€‰æ‹©
                }
                
                // è®¡ç®—æ»šåŠ¨å‚æ•°
                const itemWidth = 80;
                const containerWidth = row.offsetWidth;
                const centerPosition = containerWidth / 2;
                
                // è®¡ç®—è®©ç›®æ ‡itemåœåœ¨ä¸­å¿ƒçš„ä½ç½®
                const targetItemLeftEdge = targetIndex * itemWidth;
                const targetItemCenter = targetItemLeftEdge + itemWidth / 2;
                const translateAmount = centerPosition - targetItemCenter;
                
                // æ·»åŠ é¢å¤–æ»šåŠ¨è®©åŠ¨ç”»çœ‹èµ·æ¥çœŸå®
                const extraDistance = itemWidth * 20; // é¢å¤–æ»šåŠ¨20ä¸ªitemçš„è·ç¦»
                const finalTranslate = translateAmount - extraDistance;
                
                // å¯åŠ¨æ»šåŠ¨åŠ¨ç”»
                setTimeout(() => {
                    strip.style.transition = 'transform 3s ease-out';
                    strip.style.transform = `translateX(${finalTranslate}px)`;
                }, 200 + i * 200); // æ¯è¡Œé”™å¼€200ms
            }
            
            return results;
        }

        // ä½¿ç”¨åç«¯ç»“æœæ‰§è¡ŒæŠ½å¥–åŠ¨ç”»
        async function performSpinWithResults(prizes) {
            const rows = document.querySelectorAll('.slot-row');
            
            for (let i = 0; i < rows.length && i < prizes.length; i++) {
                const row = rows[i];
                const strip = row.querySelector('.slot-strip');
                const items = strip.querySelectorAll('.slot-item');
                const winningPrize = prizes[i];
                
                // å¼ºåˆ¶é‡ç½®åˆ°åˆå§‹ä½ç½®
                strip.style.transition = 'none';
                strip.style.transform = 'translateX(0px)';
                
                // å¼ºåˆ¶é‡ç»˜
                strip.offsetHeight;
                
                // æ‰¾åˆ°ç›®æ ‡å¥–å“çš„ç´¢å¼•
                let targetIndex = -1;
                for (let j = 0; j < items.length; j++) {
                    if (parseInt(items[j].dataset.prizeId) === winningPrize.id) {
                        targetIndex = j;
                        break;
                    }
                }
                
                if (targetIndex === -1) {
                    targetIndex = Math.floor(Math.random() * Math.min(10, items.length));
                }
                
                // è®¡ç®—æ»šåŠ¨å‚æ•°
                const itemWidth = 80;
                const containerWidth = row.offsetWidth;
                const centerPosition = containerWidth / 2;
                
                const targetItemLeftEdge = targetIndex * itemWidth;
                const targetItemCenter = targetItemLeftEdge + itemWidth / 2;
                const translateAmount = centerPosition - targetItemCenter;
                
                const extraDistance = itemWidth * 20;
                const finalTranslate = translateAmount - extraDistance;
                
                // å¯åŠ¨æ»šåŠ¨åŠ¨ç”»
                setTimeout(() => {
                    strip.style.transition = 'transform 3s ease-out';
                    strip.style.transform = `translateX(${finalTranslate}px)`;
                }, 200 + i * 200);
            }
        }

        // æ ¹æ®æ¦‚ç‡é€‰æ‹©å¥–å“
        function selectPrizeByProbability() {
            const totalProbability = prizeData.reduce((sum, prize) => sum + prize.probability, 0);
            const random = Math.random() * totalProbability;
            
            let accumulator = 0;
            for (const prize of prizeData) {
                accumulator += prize.probability;
                if (random <= accumulator) {
                    return prize;
                }
            }
            
            // å¤‡ç”¨è¿”å›æœ€åä¸€ä¸ªå¥–å“
            return prizeData[prizeData.length - 1];
        }

        // æ˜¾ç¤ºä¸­å¥–ç»“æœ
        function showWinResult(results, totalValue = null) {
            const modal = document.getElementById('winModal');
            const result = document.getElementById('winResult');
            
            // ä½¿ç”¨åç«¯æä¾›çš„æ€»ä»·å€¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™è®¡ç®—
            const calculatedValue = totalValue || results.reduce((sum, prize) => sum + parseFloat(prize.value || 0), 0);
            const prizeNames = results.map(p => p.name).join('ã€');
            
            const prizeDisplay = results.map(prize => {
                if (prize.image_url) {
                    return `<img src="${prize.image_url}" alt="${prize.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 10px; margin: 0 5px;">`;
                } else {
                    return `<span style="font-size: 60px; margin: 0 5px;">${prize.icon}</span>`;
                }
            }).join('');
            
            result.innerHTML = `
                <div style="margin: 20px 0;">${prizeDisplay}</div>
                <div class="neon-text gold" style="font-size: 24px; margin: 10px 0;">${prizeNames}</div>
                <div class="neon-text green" style="font-size: 20px;">
                    æ­å–œè·å¾—æ€»ä»·å€¼: Â¥${parseFloat(calculatedValue).toFixed(2)} çš„å¥–å“ï¼
                </div>
            `;
            
            modal.classList.add('show');
        }

        // ç”Ÿæˆå¥–å“è¯´æ˜ç½‘æ ¼
        function generatePrizeGrid() {
            const prizeGrid = document.getElementById('prizeGrid');
            
            prizeGrid.innerHTML = prizeData.map(prize => `
                <div class="prize-item ${prize.rarity}">
                    <div class="prize-display">
                        ${prize.image_url ? 
                            `<img src="${prize.image_url}" alt="${prize.name}" class="prize-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                             <span class="prize-icon" style="display:none;">${prize.icon}</span>` :
                            `<span class="prize-icon">${prize.icon}</span>`
                        }
                    </div>
                    <span class="prize-name">${prize.name}</span>
                    <span class="prize-value">ä»·å€¼: Â¥${prize.value}</span>
                    <span class="prize-rarity">${getRarityText(prize.rarity)}</span>
                    <span class="prize-probability">æ¦‚ç‡: ${prize.probability}%</span>
                </div>
            `).join('');
        }

        // è·å–ç¨€æœ‰åº¦æ–‡æœ¬
        function getRarityText(rarity) {
            const rarityMap = {
                'common': 'æ™®é€š',
                'rare': 'ç¨€æœ‰', 
                'epic': 'å²è¯—',
                'legendary': 'ä¼ è¯´'
            };
            return rarityMap[rarity] || 'æ™®é€š';
        }

        // å…³é—­ä¸­å¥–å¼¹çª—
        function closeWinModal() {
            document.getElementById('winModal').classList.remove('show');
            
            // ç¡®ä¿æ‰€æœ‰stripéƒ½é‡ç½®åˆ°åˆå§‹ä½ç½®
            const allStrips = document.querySelectorAll('.slot-strip');
            allStrips.forEach(strip => {
                strip.style.transition = 'none';
                strip.style.transform = 'translateX(0px)';
            });
        }

        // è¿”å›ä¸»é¡µ
        function goToHome() {
            window.location.href = './main.html';
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                try {
                    await api.logout();
                    window.location.href = '../auth/login.html';
                } catch (error) {
                    console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                    window.location.href = '../auth/login.html';
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', initPage);

        // æ–°å¢åŠŸèƒ½å‡½æ•°

        // æ‰“å¼€æ¯æ—¥ç­¾åˆ°
        function openCheckin() {
            generateCalendar();
            document.getElementById('checkinModal').classList.add('show');
        }

        // å…³é—­æ¯æ—¥ç­¾åˆ°å¼¹çª—
        function closeCheckinModal() {
            document.getElementById('checkinModal').classList.remove('show');
        }

        // ç”Ÿæˆç­¾åˆ°æ—¥å†
        function generateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            // è·å–æœ¬æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // æ¸…ç©ºæ—¥å†
            calendarGrid.innerHTML = '';
            
            // æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.color = '#ffd700';
                calendarGrid.appendChild(dayHeader);
            });
            
            // æ·»åŠ ç©ºç™½å¤©æ•°ï¼ˆæœˆåˆï¼‰
            const startDay = firstDay.getDay();
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyDay);
            }
            
            // æ·»åŠ æœ¬æœˆå¤©æ•°
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                // æ ‡è®°ä»Šå¤©
                if (day === now.getDate()) {
                    dayElement.classList.add('today');
                }
                
                // æ¨¡æ‹Ÿç­¾åˆ°çŠ¶æ€ï¼ˆå®é™…åº”è¯¥ä»æœåŠ¡å™¨è·å–ï¼‰
                if (Math.random() > 0.7) {
                    dayElement.classList.add('checked');
                    dayElement.title = 'å·²ç­¾åˆ°';
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // æ‰§è¡Œç­¾åˆ°
        async function performCheckin() {
            const btn = document.getElementById('checkinBtn');
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = 'ç­¾åˆ°ä¸­...';
            
            try {
                // æ¨¡æ‹Ÿç­¾åˆ°è¯·æ±‚
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // æˆåŠŸç­¾åˆ°
                btn.textContent = 'ç­¾åˆ°æˆåŠŸï¼';
                btn.style.background = 'linear-gradient(45deg, #22c55e, #16a34a)';
                
                // æ›´æ–°ç”¨æˆ·ä½™é¢
                setTimeout(() => {
                    loadUserInfo();
                    generateCalendar();
                }, 1000);
                
                // 3ç§’åæ¢å¤æŒ‰é’®
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    btn.style.background = 'linear-gradient(45deg, #4ade80, #22c55e)';
                }, 3000);
                
            } catch (error) {
                console.error('ç­¾åˆ°å¤±è´¥:', error);
                btn.disabled = false;
                btn.textContent = 'ç­¾åˆ°å¤±è´¥';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }
        }

        // æ‰“å¼€ä»“åº“
        function openWarehouse() {
            loadWarehouseItems();
            document.getElementById('warehouseModal').classList.add('show');
        }

        // å…³é—­ä»“åº“å¼¹çª—
        function closeWarehouseModal() {
            document.getElementById('warehouseModal').classList.remove('show');
        }

        // åŠ è½½ä»“åº“ç‰©å“
        function loadWarehouseItems() {
            const warehouseItems = document.getElementById('warehouseItems');
            
            // æ¨¡æ‹Ÿä»“åº“æ•°æ®
            const items = [
                { id: 1, name: 'iPhone 15', icon: 'ğŸ“±', count: 1 },
                { id: 2, name: 'AirPods', icon: 'ğŸ§', count: 2 },
                { id: 3, name: 'å……ç”µå®', icon: 'ğŸ”‹', count: 5 },
                { id: 4, name: 'æ•°æ®çº¿', icon: 'ğŸ”Œ', count: 3 },
                { id: 5, name: 'é‡‘å¸', icon: 'ğŸª™', count: 150 },
                { id: 6, name: 'é’»çŸ³', icon: 'ğŸ’', count: 8 }
            ];
            
            const itemsHtml = items.map(item => `
                <div class="warehouse-item">
                    <div class="warehouse-item-icon">${item.icon}</div>
                    <div class="warehouse-item-name">${item.name}</div>
                    <div class="warehouse-item-count">x${item.count}</div>
                </div>
            `).join('');
            
            warehouseItems.innerHTML = itemsHtml;
        }

        // ä»“åº“æ ‡ç­¾åˆ‡æ¢
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('tab-btn')) {
                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
                e.target.classList.add('active');
                
                // é‡æ–°åŠ è½½å¯¹åº”å†…å®¹
                loadWarehouseItems();
            }
        });

        // ä¸ªäººä¸­å¿ƒè·³è½¬
        function goToProfile() {
            window.location.href = '../user/profile.html';
        }
    </script>
</body>
</html>